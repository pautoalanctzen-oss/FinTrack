<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard | FinTrack</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root { 
            --app-bg: #f8f9fa; 
            --app-card-bg: #ffffff;
            --app-primary: #0d6efd;
            --app-shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --app-shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --app-shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
        }
        [data-bs-theme="dark"] {
            --app-bg: #0f0f0f; 
            --app-card-bg: #161616;
            --app-shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --app-shadow-md: 0 4px 16px rgba(0,0,0,0.4);
            --app-shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: var(--app-bg); overflow-x: hidden; }

        /* Sidebar estilos */
        .sidebar { position: fixed; top: 0; left: 0; height: 100vh; background: var(--bs-primary); width: 70px; transition: width 0.3s ease, transform 0.3s ease; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transform: translateX(0); }
        .sidebar.expanded { width: 250px; }
        .sidebar-header { padding: 20px; color: white; border-bottom: 1px solid rgba(255,255,255,0.1); height: 70px; display: flex; align-items: center; justify-content: flex-end; }
        .sidebar-toggle { background: transparent; border: none; color: white; cursor: pointer; padding: 10px; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; }
        .sidebar-toggle svg { width: 24px; height: 24px; }
        .sidebar.expanded .sidebar-toggle { transform: rotate(180deg); }

        .sidebar-menu { list-style: none; padding: 0; margin: 20px 0; }
        .menu-item { margin: 0; }
        .menu-item a { display: flex; align-items: center; padding: 15px 20px; color: rgba(255,255,255,0.8); text-decoration: none; transition: all 0.3s ease; white-space: nowrap; overflow: hidden; }
        .menu-item a:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-item.active > a { background: rgba(255,255,255,0.2); color: white; border-left: 4px solid white; }
        .menu-icon { min-width: 30px; display: flex; align-items: center; justify-content: center; }
        .menu-icon svg { width: 24px; height: 24px; }
        .menu-text { margin-left: 15px; opacity: 0; transition: opacity 0.3s ease; }
        .sidebar.expanded .menu-text { opacity: 1; }
        .sidebar:not(.expanded) .menu-text { display: none; }

        /* Submenú */
        .menu-item.has-submenu > a { cursor: pointer; }
        .menu-item.has-submenu > a .menu-arrow { margin-left: auto; transition: transform 0.3s ease; }
        .menu-item.has-submenu.open > a .menu-arrow { transform: rotate(90deg); }
        .submenu { list-style: none; padding: 0; margin: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: rgba(0,0,0,0.1); }
        .menu-item.has-submenu.open .submenu { max-height: 500px; }
        .submenu-item a { display: flex; align-items: center; padding: 12px 20px 12px 60px; color: rgba(255,255,255,0.7); text-decoration: none; transition: all 0.3s ease; font-size: 0.9rem; }
        .submenu-item a:hover { background: rgba(255,255,255,0.1); color: white; }
        .submenu-item.active a { background: rgba(255,255,255,0.15); color: white; border-left: 4px solid white; }
        .sidebar:not(.expanded) .submenu { display: none; }

        /* Menú de ajustes al fondo */
        .menu-bottom { position: absolute; bottom: 20px; width: 100%; }

    /* Barra de tareas fija superior */
    .taskbar { position: fixed; top: 0; left: 70px; right: 0; height: 70px; background-color: #ffffff; border-bottom: 1px solid #dee2e6; z-index: 999; display: flex; align-items: center; justify-content: flex-end; padding-right: 30px; transition: left 0.3s ease; }
    .sidebar.expanded ~ .taskbar { left: 250px; }

    /* Contenido principal */
    .main-content { margin-left: 70px; padding: 30px; padding-top: 100px; transition: margin-left 0.3s ease; min-height: 100vh; position: relative; }
    .sidebar.expanded ~ .main-content { margin-left: 250px; }
        /* Menú usuario flotante */
    .user-menu-wrapper { position: static; display: flex; align-items: center; gap: 0.5rem; }
    .user-menu-wrapper .btn { min-width: 90px; }        
    
    /* Cards mejoradas con gradientes y sombras */
    .welcome-card { 
        background: var(--app-card-bg); 
        padding: 30px; 
        border-radius: 16px; 
        box-shadow: var(--app-shadow-sm);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(0,0,0,0.05);
    }
    .welcome-card:hover {
        box-shadow: var(--app-shadow-md);
        transform: translateY(-2px);
    }
    
    /* Estilos para todas las cards del sistema */
    .card {
        border-radius: 12px;
        border: 1px solid rgba(0,0,0,0.06);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: var(--app-card-bg);
    }
    .card:hover {
        box-shadow: var(--app-shadow-md) !important;
        transform: translateY(-2px);
    }
    .card-header {
        background: linear-gradient(135deg, rgba(13,110,253,0.05) 0%, rgba(13,110,253,0.02) 100%);
        border-bottom: 1px solid rgba(0,0,0,0.06);
        font-weight: 600;
        border-radius: 12px 12px 0 0 !important;
    }
    .card-body {
        transition: all 0.3s ease;
    }
    
    /* Botones con transiciones suaves */
    .btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 8px;
        font-weight: 500;
    }
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--app-shadow-sm);
    }
    .btn:active {
        transform: translateY(0);
    }
    
    /* Inputs y selects con mejor feedback visual */
    .form-control, .form-select {
        transition: all 0.3s ease;
        border-radius: 8px;
    }
    .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        border-color: #0d6efd;
    }
    
    /* Tablas con hover effect mejorado */
    .table > tbody > tr {
        transition: all 0.2s ease;
    }
    .table > tbody > tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
        transform: scale(1.01);
        box-shadow: var(--app-shadow-sm);
    }

        /* Ajustes */
        .settings-container { max-width: 720px; margin: 0 auto; }
        .password-wrapper { position: relative; }
        .toggle-password { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: transparent; cursor: pointer; color: #6c757d; padding: 0.25rem 0.5rem; }
        .toggle-password svg { width: 20px; height: 20px; }
        .validation-item { font-size: 0.875rem; margin: 0.25rem 0; }
        .validation-item.valid { color: #198754; }
        .validation-item.invalid { color: #dc3545; }
        .confirm-error { color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem; }
        /* Estado select styling */
        .estado-select { font-weight:500; }
        .estado-select.estado-activo { background:#d1e7dd; color:#0f5132; border-color:#badbcc; }
        .estado-select.estado-inactivo { background:#f8d7da; color:#842029; border-color:#f5c2c7; }
        .estado-select option { color:#212529; }
            /* Resumen de Registros - estilos acordeón uniformes */
            #registros-accordion .accordion-button,
            .registros-subacc .accordion-button {
                min-height: 64px;
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
            }
            .registros-subacc .accordion-button > div strong { display:block; font-size:0.95rem; }
            .registros-subacc .accordion-button > div span.small { line-height:1.1; }
            .registros-subacc .accordion-item {
                border-bottom: 1px solid var(--bs-border-color);
            }
            .registros-subacc .accordion-button:not(.collapsed) {
                box-shadow: inset 0 -1px 0 rgba(0,0,0,.125);
            }
            .registros-subacc .badge { font-weight: 600; }
        /* Resumen General helpers */
        .rg-square { aspect-ratio: 1 / 1; }
        @media (max-width: 1199.98px) { /* fall back on smaller screens */
            .rg-square { aspect-ratio: auto; }
        }
        .rg-legend { min-width: 150px; }
        .rg-legend .item { display: flex; align-items: center; margin-bottom: 6px; white-space: nowrap; }
        .rg-legend .swatch { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        /* Modern Datepicker styles */
        .mdp-wrap{position:relative;display:inline-block;width:100%}
        .mdp-panel{position:absolute;background:#fff;border:1px solid #dee2e6;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:1000;padding:12px;width:280px}
        .mdp-year-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:4px 0}
        .mdp-arrow{border:none;background:transparent;cursor:pointer;font-size:.9rem;padding:4px 8px;color:#6c757d;transition:color .2s}
        .mdp-arrow:hover{color:#000}
        .mdp-year{font-weight:600;font-size:.95rem;flex:1;text-align:center}
        .mdp-month-row{margin-bottom:8px}
        .mdp-month{width:100%;border:1px solid #ced4da;border-radius:4px;padding:6px;font-size:.85rem}
        .mdp-days{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:#e9ecef}
        .mdp-weekday{text-align:center;padding:6px 4px;background:#f8f9fa;font-weight:600;color:#6c757d;font-size:.7rem;text-transform:uppercase}
        .mdp-day{padding:6px;background:#fff;cursor:pointer;font-size:.8rem;transition:background .15s;display:flex;align-items:center;justify-content:center;min-height:32px;border:1px solid #e9ecef}
        .mdp-day:hover{background:#f8f9fa;border-color:#adb5bd}
        .mdp-day.active{background:var(--bs-primary);color:#fff;border-color:var(--bs-primary);font-weight:600}
        .mdp-panel{display:none}
        .mdp-container.open .mdp-panel{display:block}

        /* Estilos del Manual */
        .manual-container { display: flex; height: 100%; gap: 0; }
        .manual-sidebar { width: 200px; background-color: #f8f9fa; border-right: 1px solid #dee2e6; overflow-y: auto; }
        .manual-nav-item { padding: 12px 16px; border-left: 3px solid transparent; cursor: pointer; transition: all 0.3s ease; color: #495057; font-weight: 500; }
        .manual-nav-item:hover { background-color: #e9ecef; }
        .manual-nav-item.active { border-left-color: var(--bs-primary); background-color: #e7f1ff; color: var(--bs-primary); }
        .manual-content { flex: 1; padding: 30px; overflow-y: auto; background-color: #ffffff; }
        .manual-section { display: none; }
        .manual-section.active { display: block; }
        .manual-section h2 { color: var(--bs-primary); margin-bottom: 20px; font-weight: 600; }
        .manual-section h3 { color: #495057; margin-top: 20px; margin-bottom: 10px; font-weight: 500; }
        .manual-section p { color: #6c757d; line-height: 1.6; margin-bottom: 12px; }
        .manual-section ul { margin-left: 20px; margin-bottom: 15px; }
        .manual-section li { color: #6c757d; line-height: 1.6; margin-bottom: 6px; }
        .manual-step { background-color: #f8f9fa; padding: 12px 16px; border-left: 3px solid var(--bs-primary); margin: 12px 0; border-radius: 4px; }
        .manual-download-btn { margin-top: 20px; }

        /* Responsive: móvil/tablet */
        @media (max-width: 991.98px) {
            .sidebar { transform: translateX(-100%); width: 260px; }
            .sidebar.expanded { transform: translateX(0); width: 260px; }
            .taskbar { left: 0; padding: 0 12px; justify-content: space-between; }
            .sidebar.expanded ~ .taskbar { left: 0; }
            .main-content { margin-left: 0; padding: 20px; padding-top: 90px; }
            .sidebar.expanded ~ .main-content { margin-left: 0; }
            .user-menu-wrapper { gap: 0.35rem; }
            .user-menu-wrapper .btn { min-width: auto; }
            .welcome-card { padding: 20px; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header" style="justify-content: center; align-items: center; height: 80px; padding: 0;">
            <div style="text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;">
                <img src="assets/logo.svg" alt="FinTrack" style="width: 45px; height: 45px; filter: brightness(0) invert(1);">
                <span class="menu-text" style="color: white; font-size: 0.9rem; font-weight: 600; margin: 0;">FinTrack</span>
            </div>
        </div>

        <ul class="sidebar-menu">
            <!-- Inicio -->
            <li class="menu-item active">
                <a href="#inicio" onclick="changeSection('inicio')">
                    <span class="menu-icon">
                        <!-- Icono de casa -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                        </svg>
                    </span>
                    <span class="menu-text">Inicio</span>
                </a>
            </li>

            <!-- Registros -->
            <li class="menu-item has-submenu" id="registros-menu">
                <a href="#" onclick="toggleSubmenu(event, 'registros-menu')">
                    <span class="menu-icon">
                        <!-- Icono de calendario -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 8.25h18M4.5 6.75h15A1.5 1.5 0 0121 8.25v10.5A1.5 1.5 0 0119.5 20.25h-15A1.5 1.5 0 013 18.75V8.25A1.5 1.5 0 014.5 6.75z" />
                        </svg>
                    </span>
                    <span class="menu-text">Registros</span>
                    <span class="menu-arrow menu-text">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                        </svg>
                    </span>
                </a>
                <ul class="submenu">
                    <li class="submenu-item">
                        <a href="#registros-resumen" onclick="changeSection('registros-resumen')">Resumen</a>
                    </li>
                    <li class="submenu-item">
                        <a href="#registros-add" onclick="changeSection('registros-add')">Añadir Registro</a>
                    </li>
                    <li class="submenu-item">
                        <a href="#registros-productos" onclick="changeSection('registros-productos')">Productos</a>
                    </li>
                </ul>
            </li>

            <!-- Clientes -->
            <li class="menu-item has-submenu" id="clientes-menu">
                <a href="#" onclick="toggleSubmenu(event, 'clientes-menu')">
                    <span class="menu-icon">
                        <!-- Icono de personas -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                        </svg>
                    </span>
                    <span class="menu-text">Clientes</span>
                    <span class="menu-arrow menu-text">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                        </svg>
                    </span>
                </a>
                <ul class="submenu">
                    <li class="submenu-item">
                        <a href="#clientes-listado" onclick="changeSection('clientes-listado')">
                            Listado de Clientes
                        </a>
                    </li>
                    <li class="submenu-item">
                        <a href="#clientes-admin" onclick="changeSection('clientes-admin')">
                            Administrar
                        </a>
                    </li>
                </ul>
            </li>

            <!-- Reportes -->
            <li class="menu-item">
                <a href="#reportes" onclick="changeSection('reportes')">
                    <span class="menu-icon">
                        <!-- Icono de documento/hoja -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                    </span>
                    <span class="menu-text">Reportes</span>
                </a>
            </li>
        </ul>

        <!-- Botón toggle -->
        <div style="position: absolute; bottom: 140px; width: 100%; padding: 0 10px;">
            <button class="sidebar-toggle" id="toggleBtn" onclick="toggleSidebar()" style="width: 100%; display: flex; justify-content: center; margin: 0;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="width: 20px; height: 20px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
            </button>
        </div>

        <!-- Ajustes al fondo -->
        <ul class="sidebar-menu menu-bottom">
            <li class="menu-item">
                <a href="#ajustes" onclick="changeSection('ajustes')">
                    <span class="menu-icon">
                        <!-- Icono de configuración -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </span>
                    <span class="menu-text">Ajustes</span>
                </a>
            </li>
        </ul>
    </nav>

    <!-- Barra de tareas fija -->
    <div class="taskbar">
        <div class="d-lg-none">
            <button class="btn btn-primary btn-sm d-flex align-items-center gap-2" id="mobileMenuBtn" onclick="toggleSidebar()" aria-label="Abrir menú">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
                <span>Menú</span>
            </button>
        </div>
        <div class="user-menu-wrapper">
            <button class="btn btn-light border btn-sm d-flex align-items-center gap-2" id="manualBtn" title="Descargar Manual" style="padding: 0.5rem 0.75rem; height: fit-content;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="var(--bs-primary)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="16" height="16">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                    <path d="M6 7v10m10-10v10"/>
                </svg>
                <span>Manual</span>
            </button>
            <div class="dropdown">
                <button class="btn btn-light border btn-sm d-flex align-items-center gap-2" id="userMenuBtn" data-bs-toggle="dropdown" aria-expanded="false" style="padding: 0.5rem 0.75rem; height: fit-content;">
                    <span class="user-avatar rounded-circle d-inline-flex align-items-center justify-content-center" style="width:16px;height:16px;background: var(--bs-primary); color: #fff; flex-shrink: 0;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="12" height="12" aria-hidden="true">
                            <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/>
                        </svg>
                    </span>
                    <span id="username-display"></span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuBtn">
                    <li><a class="dropdown-item" href="#" id="menu-profile">Mi perfil</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" id="menu-logout">Cerrar Sesión</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <main class="main-content">
        <div id="content-area">
            <!-- Contenido de Inicio (mínimo) -->
            <div id="inicio-content" class="welcome-card">
                <div class="mb-4 text-center">
                    <div class="text-muted small mb-1" style="letter-spacing:.5px;">Bienvenidos a</div>
                    <h1 class="fw-bold display-6 mb-3" style="line-height:1.1;">FinTrack</h1>
                </div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100 py-3 d-flex align-items-center justify-content-center gap-2 shadow-sm" onclick="changeSection('clientes-listado')">
                            <span class="d-inline-flex">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="24" height="24">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                            </span>
                            <span class="fw-semibold">Registra tus Clientes</span>
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100 py-3 d-flex align-items-center justify-content-center gap-2 shadow-sm" onclick="changeSection('registros-resumen')">
                            <span class="d-inline-flex">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="24" height="24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </span>
                            <span class="fw-semibold">Gestiona tus Cobros</span>
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100 py-3 d-flex align-items-center justify-content-center gap-2 shadow-sm" onclick="changeSection('reportes')">
                            <span class="d-inline-flex">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="24" height="24">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-8-6zm-1 16H7v-2h6v2zm3-4H7v-2h10v2zm0-4H7V8h10v2z"/>
                                </svg>
                            </span>
                            <span class="fw-semibold">Genera tus Reportes</span>
                        </button>
                    </div>
                </div>
                <hr class="my-4"/>
                <!-- Resumen General -->
                <div id="resumen-general" class="mt-3">
                    <div class="d-flex flex-column flex-lg-row align-items-lg-end align-items-stretch gap-3 mb-3">
                        <div class="flex-grow-1">
                            <h4 class="mb-1 d-flex align-items-center gap-2">Resumen General
                                <span class="badge bg-primary text-light fw-normal" style="font-size:.65rem; letter-spacing:.5px;">BETA</span>
                            </h4>
                            <div class="text-muted small">Vista agregada de tus registros: totales por obra, estados y evolución.</div>
                        </div>
                        <div class="d-flex flex-wrap align-items-end gap-3">
                            <div>
                                <label for="resumen-general-fecha-inicio" class="form-label small text-muted mb-1">Fecha desde</label>
                                <input type="text" id="resumen-general-fecha-inicio" class="form-control form-control-sm" data-datepicker="modern" value="01-12-2025" />
                            </div>
                            <div>
                                <label for="resumen-general-fecha-fin" class="form-label small text-muted mb-1">Fecha hasta</label>
                                <input type="text" id="resumen-general-fecha-fin" class="form-control form-control-sm" data-datepicker="modern" value="08-12-2025" />
                            </div>
                            <div class="d-flex gap-2 align-items-end">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-rg-rango-30">Últimos 30 días</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-rg-reset">Limpiar</button>
                            </div>
                        </div>
                    </div>
                    <div id="resumen-general-empty" class="text-center text-muted py-5 border rounded" style="display:none;">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" width="48" height="48" class="mb-2 opacity-50">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 8.25h18M4.5 6.75h15A1.5 1.5 0 0121 8.25v10.5A1.5 1.5 0 0119.5 20.25h-15A1.5 1.5 0 013 18.75V8.25A1.5 1.5 0 014.5 6.75z" />
                        </svg>
                        <p class="mb-1">No hay datos en el rango seleccionado</p>
                        <p class="small">Guarda registros o ajusta las fechas para ver el resumen.</p>
                    </div>
                    <div id="resumen-general-charts" class="row g-3">
                        <!-- Nueva disposición: Col 1 promedios + has vendido; Col 2 evolución; Col 3 pie productos -->
                        <div class="col-xl-4 col-12">
                            <div id="card-promedio-diario" class="card shadow-sm mb-3">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <div class="d-flex flex-column">
                                        <strong>Promedio de Ventas Diarias</strong>
                                        <small class="text-muted">Cantidad de productos en el rango</small>
                                    </div>
                                    <div id="rg-promedio-diario" class="fs-3 fw-bold text-primary">0</div>
                                </div>
                            </div>
                            <div id="card-promedio-semanal" class="card shadow-sm mb-3">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <div class="d-flex flex-column">
                                        <strong>Promedio de Ventas Semanales</strong>
                                        <small class="text-muted">Cantidad de productos en el rango</small>
                                    </div>
                                    <div id="rg-promedio-semanal" class="fs-3 fw-bold text-primary">0</div>
                                </div>
                            </div>
                            <div id="card-has-vendido" class="card shadow-sm">
                                <div class="card-header py-2"><strong class="small">Has vendido (USD)</strong></div>
                                <div class="card-body d-flex align-items-center justify-content-center" style="min-height:90px;">
                                    <div id="rg-has-vendido" class="h2 fw-bold text-success mb-0">$0.00</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-4 col-12" id="card-evolucion-diaria">
                            <div class="card shadow-sm h-100">
                                <div class="card-header py-2"><strong class="small">Evolución Diaria (Cantidad)</strong></div>
                                <div class="card-body" style="height:240px;"><canvas id="chart-resumen-evo-diaria" style="height:100%; width:100%;"></canvas></div>
                            </div>
                        </div>
                        <div class="col-xl-4 col-12" id="card-productos-pie">
                            <div class="card shadow-sm h-100">
                                <div class="card-header py-2"><strong class="small">Productos: Cobrados vs Por Cobrar</strong></div>
                                <div class="card-body d-flex align-items-center" style="height:240px;">
                                    <div class="flex-grow-1" style="min-width:0;">
                                        <canvas id="chart-rg-productos" style="height:100%; width:100%;"></canvas>
                                    </div>
                                    <div id="legend-rg-productos" class="rg-legend ms-3 small"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Fila inferior: nuevo horizontal por obra y totales dinero globales -->
                        <div class="col-xl-6 col-12" id="card-totales-obra">
                            <div class="card shadow-sm h-100">
                                <div class="card-header py-2"><strong class="small">Totales por Obra (Cobrado / Pendiente / A Cobrar)</strong></div>
                                <div class="card-body"><canvas id="chart-rg-obra-totales" height="240"></canvas></div>
                            </div>
                        </div>
                        <div class="col-xl-6 col-12" id="card-totales-globales">
                            <div class="card shadow-sm h-100">
                                <div class="card-header py-2"><strong class="small">Resumen Global de Totales (Dinero)</strong></div>
                                <div class="card-body"><canvas id="chart-rg-totales" height="240"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- NOTE: end inicio-content -->
            

            <!-- Registros - Resumen -->
            <div id="registros-resumen-content" class="welcome-card" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Resumen de Registros</h2>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-primary btn-sm d-flex align-items-center" onclick="goToAddRegistro()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="18" height="18" class="me-1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            Añadir Registro
                        </button>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <label for="filter-registros-obra" class="form-label small text-muted">Filtrar por Obra</label>
                        <select class="form-select form-select-sm" id="filter-registros-obra">
                            <option value="">Todas las obras</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filter-registros-fecha-inicio" class="form-label small text-muted">Fecha desde</label>
                        <input type="text" class="form-control form-control-sm" id="filter-registros-fecha-inicio" data-datepicker="modern">
                    </div>
                    <div class="col-md-3">
                        <label for="filter-registros-fecha-fin" class="form-label small text-muted">Fecha hasta</label>
                        <input type="text" class="form-control form-control-sm" id="filter-registros-fecha-fin" data-datepicker="modern">
                    </div>
                </div>

                <!-- Acordeón de registros agrupados por fecha -->
                <div class="accordion" id="registros-accordion">
                    <!-- Generado dinámicamente -->
                </div>
                
                <!-- Placeholder inicial -->
                <div id="registros-resumen-empty" class="text-center text-muted py-5">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" width="48" height="48" class="mb-2 opacity-50">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 8.25h18M4.5 6.75h15A1.5 1.5 0 0121 8.25v10.5A1.5 1.5 0 0119.5 20.25h-15A1.5 1.5 0 013 18.75V8.25A1.5 1.5 0 014.5 6.75z" />
                    </svg>
                    <p>No hay registros</p>
                    <button class="btn btn-primary btn-sm" onclick="goToAddRegistro()">Añadir Registro</button>
                </div>
            </div>

            <!-- Registros - Añadir Registro -->
            <div id="registros-add-content" class="welcome-card" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="mb-0" id="registro-add-title">Añadir Registro</h2>
                    <div class="d-flex gap-2">
                        <button id="btn-editar-registro" class="btn btn-warning btn-sm" onclick="enableEditMode()" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16" class="me-1" style="display: inline-block; vertical-align: middle;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z" />
                            </svg>
                            Editar
                        </button>
                        <button id="btn-guardar-registro" class="btn btn-primary btn-sm" onclick="saveRegistro()">Guardar Registro</button>
                    </div>
                </div>
                <div id="registro-add-alert" class="alert d-none" role="alert"></div>
                
                <!-- Filtros en una sola fila -->
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label for="registro-fecha" class="form-label small text-muted">Día</label>
                        <input type="text" class="form-control form-control-sm" id="registro-fecha" data-datepicker="modern">
                    </div>
                    <div class="col-md-9">
                        <label for="registro-obra" class="form-label small text-muted">Obra</label>
                        <select class="form-select form-select-sm" id="registro-obra">
                            <option value="">Seleccione una obra...</option>
                        </select>
                    </div>
                </div>

                <div id="registro-add-container">
                    <div class="text-muted">Seleccione una obra o elija la opción "+ Registro Adicional" del listado.</div>
                </div>

                <!-- Totales -->
                <div id="registro-totales" class="mt-3" style="display:none;">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body py-2 d-flex justify-content-between">
                                    <span>Total de Almuerzos Vendidos</span>
                                    <strong id="registro-total-cantidad">0</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body py-2 d-flex justify-content-between">
                                    <span>Total a Cobrar</span>
                                    <strong id="registro-total-cobrar">$0.00</strong>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body py-2 d-flex justify-content-between">
                                    <span>Total Cobrado</span>
                                    <strong id="registro-total-pagado">$0.00</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registros - Productos -->
            <div id="registros-productos-content" class="welcome-card" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h2 class="mb-0">Productos</h2>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-primary btn-sm d-flex align-items-center" onclick="openProductosAdmin()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="18" height="18" class="me-1">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            Agregar Productos
                        </button>
                    </div>
                </div>

                <ul class="nav nav-tabs" id="productosTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="productos-tab-lista" data-bs-toggle="tab" data-bs-target="#productos-pane-lista" type="button" role="tab" aria-controls="productos-pane-lista" aria-selected="true">Productos</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="productos-tab-admin" data-bs-toggle="tab" data-bs-target="#productos-pane-admin" type="button" role="tab" aria-controls="productos-pane-admin" aria-selected="false">Administrar Productos</button>
                    </li>
                </ul>
                <div class="tab-content pt-3" id="productosTabsContent">
                    <!-- Lista de Productos -->
                    <div class="tab-pane fade show active" id="productos-pane-lista" role="tabpanel" aria-labelledby="productos-tab-lista">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th class="text-end">Precio de Venta</th>
                                        <th class="text-center">Estado</th>
                                        <th class="text-center" style="width: 140px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="productos-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">Sin productos. Usa "Agregar tus Productos" para comenzar.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Administrar Productos -->
                    <div class="tab-pane fade" id="productos-pane-admin" role="tabpanel" aria-labelledby="productos-tab-admin">
                        <div id="productos-admin-alert" class="alert d-none" role="alert"></div>
                        <form id="form-producto" class="row g-3">
                            <div class="col-md-6">
                                <label for="producto-nombre" class="form-label">Nombre <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="producto-nombre" required>
                            </div>
                            <div class="col-md-3">
                                <label for="producto-codigo" class="form-label">Código <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="producto-codigo" required>
                            </div>
                            <div class="col-md-3">
                                <label for="producto-precio" class="form-label">Precio de Venta <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="producto-precio" step="0.01" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="producto-estado" class="form-label">Estado</label>
                                <select id="producto-estado" class="form-select">
                                    <option value="activo" selected>Activo</option>
                                    <option value="inactivo">Inactivo</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="producto-descripcion" class="form-label">Descripción</label>
                                <textarea class="form-control" id="producto-descripcion" rows="2"></textarea>
                            </div>
                            <div class="col-12 d-grid">
                                <button id="btn-save-producto" type="button" class="btn btn-primary btn-sm" onclick="saveProductoFromAdmin()">Guardar Producto</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>


            <!-- Contenido de Clientes - Listado (oculto por defecto) -->
            <div id="clientes-listado-content" class="welcome-card" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Listado de Clientes</h2>
                    <div class="dropdown">
                        <button class="btn btn-primary btn-sm rounded-circle" style="width: 36px; height: 36px; padding: 0;" data-bs-toggle="dropdown" aria-expanded="false">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" width="20" height="20">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="openAdministrar('cliente')">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18" class="d-inline me-2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z" />
                                </svg>
                                Añadir Cliente
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="openAdministrar('obra')">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18" class="d-inline me-2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" />
                                </svg>
                                Añadir Obra
                            </a></li>
                        </ul>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <label for="filter-nombre" class="form-label small text-muted">Nombre</label>
                        <input type="text" class="form-control form-control-sm" id="filter-nombre" placeholder="Buscar por nombre...">
                    </div>
                    <div class="col-md-3">
                        <label for="filter-obra" class="form-label small text-muted">Obra</label>
                        <select class="form-select form-select-sm" id="filter-obra">
                            <option value="">Todas las obras</option>
                            <!-- Las opciones se cargarán dinámicamente -->
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filter-estado" class="form-label small text-muted">Estado</label>
                        <select class="form-select form-select-sm" id="filter-estado">
                            <option value="">Todos los estados</option>
                            <option value="activo">Activo</option>
                            <option value="inactivo">Inactivo</option>
                            <option value="pendiente">Pendiente</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filter-fecha-inicio" class="form-label small text-muted">Fecha desde</label>
                        <input type="text" class="form-control form-control-sm" id="filter-fecha-inicio" data-datepicker="modern">
                    </div>
                    <div class="col-md-2">
                        <label for="filter-fecha-fin" class="form-label small text-muted">Fecha hasta</label>
                        <input type="text" class="form-control form-control-sm" id="filter-fecha-fin" data-datepicker="modern">
                    </div>
                    
                </div>

                <!-- Tarjetas resumen por obra -->
                <div id="obra-summary-cards" class="row g-3 mb-4 justify-content-center">
                    <!-- Se generan dinámicamente -->
                </div>

                <!-- Tabla de Clientes -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Cédula</th>
                                <th>Obra</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th class="text-center" style="width: 120px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientes-table-body">
                            <!-- Los datos se cargarán dinámicamente -->
                            <tr>
                                <td colspan="6" class="text-center text-muted py-5">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" width="48" height="48" class="mb-2 opacity-50">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                                    </svg>
                                    <p>No hay clientes registrados</p>
                                    <button class="btn btn-primary btn-sm" onclick="showAddClienteModal(event)">Añadir primer cliente</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Contenido de Clientes - Administrar (oculto por defecto) -->
            <div id="clientes-admin-content" class="welcome-card" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="mb-0">Administrar</h2>
                </div>

                <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="admin-tab-obra" data-bs-toggle="tab" data-bs-target="#admin-pane-obra" type="button" role="tab" aria-controls="admin-pane-obra" aria-selected="true">Añadir Obra</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="admin-tab-clientes" data-bs-toggle="tab" data-bs-target="#admin-pane-clientes" type="button" role="tab" aria-controls="admin-pane-clientes" aria-selected="false">Añadir Clientes</button>
                    </li>
                </ul>
                <div class="tab-content pt-3" id="adminTabsContent">
                    <!-- Pane: Añadir Obra -->
                    <div class="tab-pane fade show active" id="admin-pane-obra" role="tabpanel" aria-labelledby="admin-tab-obra">
                        <div id="admin-obra-alert" class="alert d-none" role="alert"></div>
                        <form id="form-admin-obra" class="row g-3">
                            <div class="col-md-6">
                                <label for="admin-obra-nombre" class="form-label">Nombre de la obra <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="admin-obra-nombre" required>
                            </div>
                            <div class="col-md-6">
                                <label for="admin-obra-ubicacion" class="form-label">Ubicación</label>
                                <input type="text" class="form-control" id="admin-obra-ubicacion" placeholder="Ciudad, dirección...">
                            </div>
                            <div class="col-12">
                                <label for="admin-obra-descripcion" class="form-label">Descripción</label>
                                <textarea class="form-control" id="admin-obra-descripcion" rows="3"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="admin-obra-fecha-inicio" class="form-label">Fecha de inicio</label>
                                <input type="date" class="form-control" id="admin-obra-fecha-inicio">
                            </div>
                            <div class="col-md-6">
                                <label for="admin-obra-fecha-fin" class="form-label">Fecha estimada de fin</label>
                                <input type="date" class="form-control" id="admin-obra-fecha-fin">
                            </div>
                            <div class="col-12 d-grid">
                                <button type="button" class="btn btn-primary btn-sm" onclick="saveObraFromAdmin()">Guardar Obra</button>
                            </div>
                        </form>
                    </div>

                    <!-- Pane: Añadir Clientes -->
                    <div class="tab-pane fade" id="admin-pane-clientes" role="tabpanel" aria-labelledby="admin-tab-clientes">
                        <div id="admin-cliente-alert" class="alert d-none" role="alert"></div>
                        <form id="form-admin-cliente" class="row g-3">
                            <div class="col-md-6">
                                <label for="admin-cliente-nombre" class="form-label">Nombre completo <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="admin-cliente-nombre" required>
                            </div>
                            <div class="col-md-6">
                                <label for="admin-cliente-cedula" class="form-label">Cédula <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="admin-cliente-cedula" required>
                            </div>
                            <div class="col-md-6">
                                <label for="admin-cliente-obra" class="form-label">Obra <span class="text-danger">*</span></label>
                                <select class="form-select" id="admin-cliente-obra" required>
                                    <option value="">Seleccione una obra...</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="admin-cliente-estado" class="form-label">Estado <span class="text-danger">*</span></label>
                                <select class="form-select" id="admin-cliente-estado" required>
                                    <option value="activo">Activo</option>
                                    <option value="inactivo">Inactivo</option>
                                    <option value="pendiente">Pendiente</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="admin-cliente-fecha" class="form-label">Fecha de registro <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="admin-cliente-fecha" data-datepicker="modern" required>
                            </div>
                            <div class="col-md-6">
                                <label for="admin-cliente-telefono" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="admin-cliente-telefono">
                            </div>
                            <div class="col-md-6">
                                <label for="admin-cliente-email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="admin-cliente-email">
                            </div>
                            <div class="col-12">
                                <label for="admin-cliente-notas" class="form-label">Notas</label>
                                <textarea class="form-control" id="admin-cliente-notas" rows="3"></textarea>
                            </div>
                            <div class="col-12 d-grid">
                                <button type="button" class="btn btn-primary btn-sm" onclick="saveClienteFromAdmin()">Guardar Cliente</button>
                            </div>
                        </form>

                        <hr class="my-4"/>

                        <h6 class="mb-3">Importar clientes en lote</h6>
                        <div id="add-clientes-alert" class="alert d-none" role="alert"></div>
                        <div class="row g-3 align-items-end mb-3">
                            <div class="col-md-5">
                                <label class="form-label small text-muted" for="add-clientes-obra">Obra</label>
                                <select id="add-clientes-obra" class="form-select form-select-sm">
                                    <option value="">Seleccione una obra...</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label small text-muted" for="add-clientes-file">Importar archivo (.xlsx, .xls, .csv, .pdf)</label>
                                <input type="file" id="add-clientes-file" class="form-control form-control-sm" accept=".xlsx,.xls,.csv,.pdf">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary btn-sm w-100" onclick="handleAddClientesImport()">Importar</button>
                            </div>
                        </div>
                        <p class="text-muted small">Consejo: usa una hoja con columnas: Nombre, Cédula, Estado, Fecha.</p>
                    </div>
                </div>
            </div>

            <!-- Contenido de Reportes (oculto por defecto) -->
            <div id="reportes-content" class="welcome-card" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h2 class="mb-0">Reportes</h2>
                </div>

                <ul class="nav nav-tabs" id="reportesTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="resumen-tab" data-bs-toggle="tab" data-bs-target="#tab-resumen-reportes" type="button" role="tab" aria-controls="tab-resumen-reportes" aria-selected="true">Resumen Reportes</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="detallados-tab" data-bs-toggle="tab" data-bs-target="#tab-reportes-detallados" type="button" role="tab" aria-controls="tab-reportes-detallados" aria-selected="false">Reportes Detallados</button>
                    </li>
                </ul>
                <div class="tab-content pt-3" id="reportesTabsContent">
                    <!-- Tab: Resumen Reportes -->
                    <div class="tab-pane fade show active" id="tab-resumen-reportes" role="tabpanel" aria-labelledby="resumen-tab">
                        <div class="row g-3" id="resumen-reportes-contenedor">
                            <div class="col-md-6" id="reporte-diario-wrapper">
                                <div class="card h-100">
                                    <div class="card-header d-flex align-items-center justify-content-between">
                                        <strong>Reporte Diario</strong>
                                        <input type="text" id="resumen-diario-fecha" class="form-control form-control-sm" style="width:auto;" data-datepicker="modern">
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3 mb-3">
                                            <div class="col-sm-6 col-lg-3">
                                                <div class="border border-2 rounded p-2 text-center bg-light" style="border-color: var(--bs-primary) !important;">
                                                    <div class="small text-muted">A Cobrar</div>
                                                    <div class="fw-bold" style="color: var(--bs-primary);" id="resumen-diario-cobrar">$0.00</div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6 col-lg-3">
                                                <div class="border border-success border-2 rounded p-2 text-center bg-light">
                                                    <div class="small text-muted">Cobrado</div>
                                                    <div class="fw-bold text-success" id="resumen-diario-cobrado">$0.00</div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6 col-lg-3">
                                                <div class="border border-warning border-2 rounded p-2 text-center bg-light">
                                                    <div class="small text-muted">Pendiente</div>
                                                    <div class="fw-bold text-warning" id="resumen-diario-pendiente">$0.00</div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6 col-lg-3">
                                                <div class="border border-2 rounded p-2 text-center bg-light">
                                                    <div class="small text-muted">Cantidad</div>
                                                    <div class="fw-bold" id="resumen-diario-cantidad">0</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <canvas id="chart-diario" style="max-height:200px;"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6" id="reporte-semanal-wrapper">
                                <div class="card h-100">
                                    <div class="card-header d-flex align-items-center justify-content-between">
                                        <strong>Reporte Semanal</strong>
                                        <div class="d-flex align-items-center gap-2">
                                            <input type="text" id="resumen-semanal-fecha-inicio" class="form-control form-control-sm" title="Fecha desde" data-datepicker="modern">
                                            <input type="text" id="resumen-semanal-fecha-fin" class="form-control form-control-sm" title="Fecha hasta" data-datepicker="modern">
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3 mb-3">
                                            <div class="col-sm-6 col-lg-3">
                                                <div class="border border-2 rounded p-2 text-center bg-light" style="border-color: var(--bs-primary) !important;">
                                                    <div class="small text-muted">A Cobrar</div>
                                                    <div class="fw-bold" style="color: var(--bs-primary);" id="resumen-semanal-cobrar">$0.00</div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6 col-lg-3">
                                                <div class="border border-success border-2 rounded p-2 text-center bg-light">
                                                    <div class="small text-muted">Cobrado</div>
                                                    <div class="fw-bold text-success" id="resumen-semanal-cobrado">$0.00</div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6 col-lg-3">
                                                <div class="border border-warning border-2 rounded p-2 text-center bg-light">
                                                    <div class="small text-muted">Pendiente</div>
                                                    <div class="fw-bold text-warning" id="resumen-semanal-pendiente">$0.00</div>
                                                </div>
                                            </div>
                                            <div class="col-sm-6 col-lg-3">
                                                <div class="border border-2 rounded p-2 text-center bg-light">
                                                    <div class="small text-muted">Cantidad</div>
                                                    <div class="fw-bold" id="resumen-semanal-cantidad">0</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <canvas id="chart-semanal" style="max-height:200px;"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Reportes Detallados -->
                    <div class="tab-pane fade" id="tab-reportes-detallados" role="tabpanel" aria-labelledby="detallados-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div></div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="exportReportesExcel()">Exportar Excel</button>
                                <button class="btn btn-outline-primary btn-sm" onclick="exportReportesPDF()">Exportar PDF</button>
                            </div>
                        </div>

                        <!-- Filtros -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <label for="detallados-resumen-selector" class="form-label small text-muted">Modo Resumen</label>
                                <select class="form-select form-select-sm" id="detallados-resumen-selector">
                                    <option value="general" selected>General</option>
                                    <option value="detallado">Detallado</option>
                                    <option value="diario">Por Día</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filter-reportes-obra" class="form-label small text-muted">Filtrar por Obra</label>
                                <select class="form-select form-select-sm" id="filter-reportes-obra">
                                    <option value="">Todas las obras</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filter-reportes-fecha-inicio" class="form-label small text-muted">Fecha desde</label>
                                <input type="text" class="form-control form-control-sm" id="filter-reportes-fecha-inicio" data-datepicker="modern">
                            </div>
                            <div class="col-md-3">
                                <label for="filter-reportes-fecha-fin" class="form-label small text-muted">Fecha hasta</label>
                                <input type="text" class="form-control form-control-sm" id="filter-reportes-fecha-fin" data-datepicker="modern">
                            </div>
                        </div>

                        <!-- Totales -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <div class="card border-2" style="border-color: var(--bs-primary) !important;">
                                    <div class="card-body py-2 d-flex justify-content-between align-items-center">
                                        <span>Total a Cobrar</span>
                                        <strong id="reportes-total-cobrar" style="color: var(--bs-primary);">$0.00</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-success border-2">
                                    <div class="card-body py-2 d-flex justify-content-between align-items-center">
                                        <span>Total Cobrado</span>
                                        <strong id="reportes-total-cobrado" class="text-success">$0.00</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-warning border-2">
                                    <div class="card-body py-2 d-flex justify-content-between align-items-center">
                                        <span>Total Pendiente</span>
                                        <strong id="reportes-total-pendiente" class="text-warning">$0.00</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de resultados -->
                        <div class="table-responsive">
                            <table class="table table-sm align-middle" id="reportes-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Cliente</th>
                                        <th>Cédula</th>
                                        <th>Obra</th>
                                        <th class="text-end">Cantidad</th>
                                        <th class="text-end">A Cobrar</th>
                                        <th class="text-end">Cobrado</th>
                                        <th class="text-end">Pendiente</th>
                                        <th>Estado</th>
                                        <th class="text-end">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="reportes-tbody"></tbody>
                            </table>
                        </div>

                        <!-- Placeholder inicial -->
                        <div id="reportes-empty" class="text-center text-muted py-4" style="display:none;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" width="48" height="48" class="mb-2 opacity-50">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
                            </svg>
                            <p>No hay registros para los filtros seleccionados</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido de Ajustes (oculto por defecto) -->
            <div id="ajustes-content" class="welcome-card" style="display: none;">
                <h2 class="mb-3">Ajustes</h2>
                <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="perfil-tab" data-bs-toggle="tab" data-bs-target="#perfil" type="button" role="tab" aria-controls="perfil" aria-selected="true">Perfil</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="preferencias-tab" data-bs-toggle="tab" data-bs-target="#preferencias" type="button" role="tab" aria-controls="preferencias" aria-selected="false">Preferencias</button>
                    </li>
                    <!-- Futuras pestañas: Notificaciones, Preferencias, Seguridad, etc. -->
                </ul>
                <div class="tab-content pt-3" id="settingsTabsContent">
                    <!-- Tab: Perfil -->
                    <div class="tab-pane fade show active" id="perfil" role="tabpanel" aria-labelledby="perfil-tab">
                        <div class="settings-container">
                        <div id="settings-alert" class="alert d-none" role="alert"></div>

                        <!-- Resumen actual -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control form-control-sm" id="current-username" placeholder="Usuario actual" disabled>
                                    <label for="current-username">Usuario actual</label>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="email" class="form-control form-control-sm" id="current-email" placeholder="Correo actual" disabled>
                                    <label for="current-email">Correo actual</label>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <!-- Cambiar correo -->
                        <div class="mb-4">
                            <h5 class="mb-3">Cambiar correo</h5>
                            <form id="form-email" class="row g-2 settings-container">
                                <div class="col-md-8">
                                    <label for="new-email" class="form-label">Nuevo correo</label>
                                    <input type="email" class="form-control form-control-sm" id="new-email" name="email" placeholder="nombre@dominio.com" required>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary btn-sm w-100">Guardar correo</button>
                                </div>
                            </form>
                        </div>

                        <hr class="my-4" />

                        <!-- Cambiar usuario -->
                        <div class="mb-4">
                            <h5 class="mb-3">Cambiar usuario</h5>
                            <form id="form-username" class="row g-2 settings-container">
                                <div class="col-md-8">
                                    <label for="new-username" class="form-label">Nuevo usuario</label>
                                    <input type="text" class="form-control form-control-sm" id="new-username" name="new_username" minlength="3" required>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary btn-sm w-100">Guardar usuario</button>
                                </div>
                            </form>
                        </div>

                        <hr class="my-4" />

                        <!-- Cambiar contraseña -->
                        <div class="mb-2">
                            <h5 class="mb-3">Cambiar contraseña</h5>
                            <form id="form-password" class="settings-container">
                                <div class="mb-3">
                                    <label for="current-password" class="form-label">Contraseña actual</label>
                                    <input type="password" class="form-control form-control-sm" id="current-password" name="current_password" autocomplete="current-password" required>
                                </div>
                                <div class="mb-3">
                                    <label for="new-password" class="form-label">Nueva contraseña</label>
                                    <div class="password-wrapper">
                                        <input type="password" class="form-control form-control-sm" id="new-password" name="new_password" required>
                                        <button type="button" class="toggle-password" onclick="togglePwd('new-password', this)">
                                            <!-- ojo cerrado -->
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                                            </svg>
                                        </button>
                                    </div>
                                    <div id="pwd-rules" class="mt-2" style="display:none;">
                                        <div id="rule-case" class="validation-item invalid">✗ Debe contener mayúsculas y minúsculas</div>
                                        <div id="rule-number" class="validation-item invalid">✗ Debe contener números</div>
                                        <div id="rule-length" class="validation-item invalid">✗ Debe tener más de 6 caracteres</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="confirm-password" class="form-label">Confirmar nueva contraseña</label>
                                    <div class="password-wrapper">
                                        <input type="password" class="form-control form-control-sm" id="confirm-password" name="confirm_password" required>
                                        <button type="button" class="toggle-password" onclick="togglePwd('confirm-password', this)">
                                            <!-- ojo cerrado -->
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                                            </svg>
                                        </button>
                                    </div>
                                    <div id="confirm-error" class="confirm-error" style="display:none;">Las contraseñas no coinciden</div>
                                </div>
                                <div class="d-grid">
                                    <button id="btn-save-password" type="submit" class="btn btn-primary btn-sm" disabled>Guardar contraseña</button>
                                </div>
                            </form>
                        </div>
                        </div>
                    </div>

                    <!-- Tab: Preferencias -->
                    <div class="tab-pane fade" id="preferencias" role="tabpanel" aria-labelledby="preferencias-tab">
                        <div class="settings-container">
                            <div id="prefs-alert" class="alert d-none" role="alert"></div>

                            <div class="mb-4">
                                <h5 class="mb-3">Modo</h5>
                                <select id="theme-select" class="form-select form-select-sm" aria-label="Seleccionar modo de tema">
                                    <option value="light">Claro</option>
                                    <option value="dark">Oscuro</option>
                                    <option value="system">Según el sistema</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <h5 class="mb-3">Color principal</h5>
                                <!-- Paleta de colores estándar + personalizado -->
                                <div class="d-flex flex-wrap gap-2 mb-2" id="color-palette">
                                    <button type="button" class="btn btn-light border btn-sm color-swatch" data-color="#0d6efd">
                                        <span class="rounded-circle me-1" style="display:inline-block;width:14px;height:14px;background:#0d6efd;"></span>
                                        Azul
                                    </button>
                                    <button type="button" class="btn btn-light border btn-sm color-swatch" data-color="#e685b5">
                                        <span class="rounded-circle me-1" style="display:inline-block;width:14px;height:14px;background:#e685b5;"></span>
                                        Rosado
                                    </button>
                                    <button type="button" class="btn btn-light border btn-sm color-swatch" data-color="#6f42c1">
                                        <span class="rounded-circle me-1" style="display:inline-block;width:14px;height:14px;background:#6f42c1;"></span>
                                        Morado
                                    </button>
                                    <button type="button" class="btn btn-light border btn-sm color-swatch" data-color="#198754">
                                        <span class="rounded-circle me-1" style="display:inline-block;width:14px;height:14px;background:#198754;"></span>
                                        Verde
                                    </button>
                                    <button type="button" class="btn btn-light border btn-sm color-swatch" data-color="#dc3545">
                                        <span class="rounded-circle me-1" style="display:inline-block;width:14px;height:14px;background:#dc3545;"></span>
                                        Rojo
                                    </button>
                                    <button type="button" class="btn btn-light border btn-sm color-swatch" data-color="#fd7e14">
                                        <span class="rounded-circle me-1" style="display:inline-block;width:14px;height:14px;background:#fd7e14;"></span>
                                        Naranja
                                    </button>
                                    <button type="button" id="btn-custom-color" class="btn btn-light border btn-sm">
                                        Personalizado…
                                    </button>
                                </div>
                                <!-- Input de color (se usa para personalizado y compatibilidad con lógica existente) -->
                                <div class="row g-2 align-items-center">
                                    <div class="col-auto">
                                        <input type="color" id="primary-color" class="form-control form-control-color" value="#0d6efd" title="Elige el color principal">
                                    </div>
                                    <div class="col-auto">
                                        <button id="btn-reset-color" class="btn btn-light border btn-sm" type="button">Restablecer</button>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4" />

                            <div class="mb-4">
                                <h5 class="mb-3">Logo del negocio</h5>
                                <p class="text-muted small mb-2">Carga una imagen para usar como logo en la aplicación.</p>
                                <div class="d-flex align-items-center gap-3">
                                    <div>
                                        <input type="file" id="business-logo-input" class="form-control form-control-sm" accept="image/png,image/jpeg,image/svg+xml">
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <img id="business-logo-preview" src="" alt="Logo preview" style="display:none; width:48px; height:48px; object-fit:contain; border:1px solid #e9ecef; border-radius:6px; background:#fff; padding:4px;">
                                        <button id="business-logo-remove" class="btn btn-light border btn-sm" type="button" style="display:none;">Quitar logo</button>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4" />

                            <div class="mb-4">
                                <h5 class="mb-3">Resúmenes de Inicio</h5>
                                <p class="text-muted small mb-3">Selecciona qué resúmenes quieres ver en la página de inicio</p>
                                
                                <div class="list-group">
                                    <label class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-semibold">Promedio de Ventas Diarias</div>
                                            <small class="text-muted">Cantidad promedio de productos vendidos por día</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input resumen-toggle" type="checkbox" id="toggle-promedio-diario" data-resumen="promedio-diario" checked>
                                        </div>
                                    </label>
                                    
                                    <label class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-semibold">Promedio de Ventas Semanales</div>
                                            <small class="text-muted">Cantidad promedio de productos vendidos por semana</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input resumen-toggle" type="checkbox" id="toggle-promedio-semanal" data-resumen="promedio-semanal" checked>
                                        </div>
                                    </label>
                                    
                                    <label class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-semibold">Has Vendido (USD)</div>
                                            <small class="text-muted">Total de dinero cobrado en el rango</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input resumen-toggle" type="checkbox" id="toggle-has-vendido" data-resumen="has-vendido" checked>
                                        </div>
                                    </label>
                                    
                                    <label class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-semibold">Evolución Diaria (Cantidad)</div>
                                            <small class="text-muted">Gráfico de evolución de ventas día a día</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input resumen-toggle" type="checkbox" id="toggle-evolucion-diaria" data-resumen="evolucion-diaria" checked>
                                        </div>
                                    </label>
                                    
                                    <label class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-semibold">Productos: Cobrados vs Por Cobrar</div>
                                            <small class="text-muted">Distribución de productos cobrados y pendientes</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input resumen-toggle" type="checkbox" id="toggle-productos-pie" data-resumen="productos-pie" checked>
                                        </div>
                                    </label>
                                    
                                    <label class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-semibold">Totales por Obra</div>
                                            <small class="text-muted">Gráfico horizontal de totales por obra</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input resumen-toggle" type="checkbox" id="toggle-totales-obra" data-resumen="totales-obra" checked>
                                        </div>
                                    </label>
                                    
                                    <label class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="fw-semibold">Resumen Global de Totales (Dinero)</div>
                                            <small class="text-muted">Gráfico de barras con totales globales en dinero</small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input resumen-toggle" type="checkbox" id="toggle-totales-globales" data-resumen="totales-globales" checked>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button id="btn-save-prefs" class="btn btn-primary btn-sm" type="button">Guardar preferencias</button>
                                <button id="btn-apply-prefs" class="btn btn-outline-primary btn-sm" type="button">Aplicar ahora</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual de Usuario -->
            <div id="manual-content" class="welcome-card" style="display: none; padding: 0; height: calc(100vh - 160px);">
                <div class="manual-container">
                    <!-- Sidebar con navegación vertical -->
                    <div class="manual-sidebar">
                        <div class="manual-nav-item active" onclick="showManualSection('inicio')">📊 Inicio</div>
                        <div class="manual-nav-item" onclick="showManualSection('clientes')">👥 Clientes</div>
                        <div class="manual-nav-item" onclick="showManualSection('registros')">📝 Registros</div>
                        <div class="manual-nav-item" onclick="showManualSection('reportes')">📄 Reportes</div>
                        <div class="manual-nav-item" onclick="showManualSection('ajustes')">⚙️ Ajustes</div>
                    </div>

                    <!-- Contenido del manual -->
                    <div class="manual-content">
                        <!-- Sección: Inicio -->
                        <div id="manual-inicio" class="manual-section active">
                            <h2>Bienvenido al Dashboard</h2>
                            <p>El panel de inicio es tu centro de control para acceder a todas las funcionalidades de la aplicación.</p>
                            
                            <h3>Elementos principales</h3>
                            <ul>
                                <li><strong>Registro de Clientes:</strong> Acceso rápido para crear nuevos clientes</li>
                                <li><strong>Gestión de Cobros:</strong> Administra los pagos y cobros de tus obras</li>
                                <li><strong>Generación de Reportes:</strong> Crea reportes detallados de tu actividad</li>
                            </ul>

                            <h3>Cómo empezar</h3>
                            <div class="manual-step">
                                <strong>Paso 1:</strong> Haz clic en "Registro de Clientes" para comenzar a ingresar tus clientes
                            </div>
                            <div class="manual-step">
                                <strong>Paso 2:</strong> Usa el menú lateral para acceder a las diferentes secciones
                            </div>
                            <div class="manual-step">
                                <strong>Paso 3:</strong> Consulta este manual en cualquier momento para obtener ayuda
                            </div>
                        </div>

                        <!-- Sección: Clientes -->
                        <div id="manual-clientes" class="manual-section">
                            <h2>Gestión de Clientes</h2>
                            <p>Administra toda la información de tus clientes de forma centralizada.</p>

                            <h3>Agregar un nuevo cliente</h3>
                            <div class="manual-step">
                                <strong>Paso 1:</strong> Ve a Clientes → Administrar
                            </div>
                            <div class="manual-step">
                                <strong>Paso 2:</strong> Haz clic en "Agregar cliente"
                            </div>
                            <div class="manual-step">
                                <strong>Paso 3:</strong> Completa los campos requeridos (nombre, contacto, dirección)
                            </div>
                            <div class="manual-step">
                                <strong>Paso 4:</strong> Haz clic en "Guardar"
                            </div>

                            <h3>Ver lista de clientes</h3>
                            <ul>
                                <li>Accede a Clientes → Listado de Clientes</li>
                                <li>Puedes buscar clientes por nombre o ID</li>
                                <li>Utiliza los filtros para encontrar rápidamente lo que necesitas</li>
                            </ul>

                            <h3>Editar o eliminar cliente</h3>
                            <ul>
                                <li>En el listado, haz clic en el botón de editar (lápiz) para modificar datos</li>
                                <li>Haz clic en el botón de eliminar (papelera) para remover un cliente</li>
                            </ul>
                        </div>

                        <!-- Sección: Registros -->
                        <div id="manual-registros" class="manual-section">
                            <h2>Crear y Gestionar Registros</h2>
                            <p>Los registros contienen la información detallada de cada obra o proyecto.</p>

                            <h3>Crear un nuevo registro</h3>
                            <div class="manual-step">
                                <strong>Paso 1:</strong> Ve a Registros → Añadir Registro
                            </div>
                            <div class="manual-step">
                                <strong>Paso 2:</strong> Selecciona el cliente asociado
                            </div>
                            <div class="manual-step">
                                <strong>Paso 3:</strong> Ingresa los detalles de la obra (nombre, descripción, fechas)
                            </div>
                            <div class="manual-step">
                                <strong>Paso 4:</strong> Agrega los productos/servicios utilizados
                            </div>
                            <div class="manual-step">
                                <strong>Paso 5:</strong> Haz clic en "Guardar registro"
                            </div>

                            <h3>Ver resumen de registros</h3>
                            <ul>
                                <li>Accede a Registros → Resumen</li>
                                <li>Visualiza un resumen de todos tus registros activos</li>
                                <li>Puedes filtrar por estado, cliente o rango de fechas</li>
                            </ul>

                            <h3>Gestionar productos</h3>
                            <ul>
                                <li>Ve a Registros → Productos</li>
                                <li>Agrega nuevos productos a tu inventario</li>
                                <li>Edita precios y descripciones según sea necesario</li>
                            </ul>
                        </div>

                        <!-- Sección: Reportes -->
                        <div id="manual-reportes" class="manual-section">
                            <h2>Generar y Descargar Reportes</h2>
                            <p>Crea reportes detallados de tus actividades y descargarlos en formato PDF.</p>

                            <h3>Generar un reporte</h3>
                            <div class="manual-step">
                                <strong>Paso 1:</strong> Ve a Reportes
                            </div>
                            <div class="manual-step">
                                <strong>Paso 2:</strong> Selecciona el tipo de reporte que necesitas
                            </div>
                            <div class="manual-step">
                                <strong>Paso 3:</strong> Establece los filtros (fecha, cliente, estado)
                            </div>
                            <div class="manual-step">
                                <strong>Paso 4:</strong> Haz clic en "Generar reporte"
                            </div>

                            <h3>Descargar en PDF</h3>
                            <ul>
                                <li>Una vez generado el reporte, haz clic en "Descargar PDF"</li>
                                <li>El archivo se descargará a tu computadora automáticamente</li>
                                <li>Puedes compartir o imprimir el PDF según sea necesario</li>
                            </ul>

                            <h3>Tipos de reportes disponibles</h3>
                            <ul>
                                <li><strong>Reporte General:</strong> Resumen completo de todas las actividades</li>
                                <li><strong>Reporte por Cliente:</strong> Detalle específico de cada cliente</li>
                                <li><strong>Reporte de Cobros:</strong> Estado de pagos y pendientes</li>
                                <li><strong>Reporte de Productos:</strong> Inventario y utilización</li>
                            </ul>
                        </div>

                        <!-- Sección: Ajustes -->
                        <div id="manual-ajustes" class="manual-section">
                            <h2>Configuración y Preferencias</h2>
                            <p>Personaliza la aplicación según tus necesidades.</p>

                            <h3>Cambiar contraseña</h3>
                            <div class="manual-step">
                                <strong>Paso 1:</strong> Ve a Ajustes → Cambiar Contraseña
                            </div>
                            <div class="manual-step">
                                <strong>Paso 2:</strong> Ingresa tu contraseña actual
                            </div>
                            <div class="manual-step">
                                <strong>Paso 3:</strong> Ingresa la nueva contraseña (mínimo 8 caracteres)
                            </div>
                            <div class="manual-step">
                                <strong>Paso 4:</strong> Confirma la nueva contraseña
                            </div>
                            <div class="manual-step">
                                <strong>Paso 5:</strong> Haz clic en "Guardar contraseña"
                            </div>

                            <h3>Preferencias de aplicación</h3>
                            <ul>
                                <li>Ve a Ajustes → Preferencias</li>
                                <li>Selecciona el tema visual (claro/oscuro)</li>
                                <li>Elige tu color primario preferido</li>
                                <li>Configura notificaciones según tu preferencia</li>
                            </ul>

                            <h3>Descargar manual</h3>
                            <ul>
                                <li>Haz clic en el botón "Descargar Manual" en la barra superior</li>
                                <li>El manual se descargará como PDF a tu computadora</li>
                                <li>Puedes consultar el manual sin estar conectado</li>
                            </ul>
                        </div>

                        <!-- Botón de descarga -->
                        <div class="manual-download-btn">
                            <button class="btn btn-primary" onclick="downloadManualPDF()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16" style="margin-right: 8px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                </svg>
                                Descargar como PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // API base y estado
        const BASE_API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? "http://127.0.0.1:8000"
            : "https://aplicaci-n-mi.onrender.com";
        let settingsInitialized = false;

        // ---- Utilidades globales faltantes ----
        function formatCurrency(value) {
            try {
                const n = Number(value || 0);
                return n.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            } catch {
                return `$${Number(value || 0).toFixed(2)}`;
            }
        }

        function togglePwd(inputId, btnEl) {
            try {
                const input = document.getElementById(inputId);
                if (!input) return;
                const type = input.type === 'password' ? 'text' : 'password';
                input.type = type;
                if (btnEl) {
                    // Cambiar ícono (ojo abierto/cerrado)
                    if (type === 'password') {
                        btnEl.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                            </svg>`;
                    } else {
                        btnEl.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>`;
                    }
                }
            } catch {}
        }

        function showSettingsAlert(message, type='info') {
            const box = document.getElementById('settings-alert');
            if (!box) return;
            box.textContent = message;
            box.className = `alert alert-${type}`;
            box.classList.remove('d-none');
            // Ocultar suavemente tras unos segundos en casos de éxito/info
            if (type !== 'danger') {
                setTimeout(() => { try { box.classList.add('d-none'); } catch {} }, 4000);
            }
        }

        function logout() {
            try { sessionStorage.removeItem('username'); } catch {}
            window.location.href = 'index.html';
        }

        // Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('expanded');
        }

        // Toggle submenú
        function toggleSubmenu(event, menuId) {
            event.preventDefault();
            const menuItem = document.getElementById(menuId);
            const sidebar = document.querySelector('.sidebar');
            
            // Si el sidebar no está expandido, expandirlo primero
            if (!sidebar.classList.contains('expanded')) {
                sidebar.classList.add('expanded');
            }
            
            // Toggle el submenú
            menuItem.classList.toggle('open');
        }

        // Cambiar sección (menu)
        function changeSection(section) {
            try {
            // Remover clase active de todos los items principales y submenú
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.submenu-item').forEach(item => item.classList.remove('active'));
            
            // Agregar clase active al item seleccionado
            if (window.event && window.event.target) {
                const submenuItem = window.event.target.closest('.submenu-item');
                const menuItem = window.event.target.closest('.menu-item');
                
                if (submenuItem) {
                    submenuItem.classList.add('active');
                    // También marcar el menú padre como activo
                    const parentMenu = submenuItem.closest('.has-submenu');
                    if (parentMenu) parentMenu.classList.add('active');
                } else if (menuItem) {
                    menuItem.classList.add('active');
                }
            } else {
                // Fallback: activar según la sección cuando no hay evento (navegación programática)
                const link = document.querySelector(`.submenu a[href="#${section}"]`);
                if (link) {
                    const submenuItem = link.closest('.submenu-item');
                    if (submenuItem) submenuItem.classList.add('active');
                    const parentMenu = link.closest('.has-submenu');
                    if (parentMenu) parentMenu.classList.add('active');
                } else {
                    // Activar top-level si aplica
                    const topLink = document.querySelector(`.sidebar-menu > .menu-item > a[href="#${section}"]`);
                    if (topLink) {
                        const topItem = topLink.closest('.menu-item');
                        if (topItem) topItem.classList.add('active');
                    }
                }
            }
            
            // Ocultar todos los contenidos
            document.querySelectorAll('[id$="-content"]').forEach(content => content.style.display = 'none');
            // Mostrar el contenido seleccionado
            const contentEl = document.getElementById(section + '-content');
            if (contentEl) {
                contentEl.style.display = 'block';
            }
            
            // Actualizar título
            const titles = { 
                inicio: 'Inicio', 
                'registros-resumen': 'Registros - Resumen',
                'registros-add': 'Añadir Registro',
                'registros-productos': 'Productos',
                clientes: 'Clientes',
                'clientes-listado': 'Listado de Clientes',
                'clientes-admin': 'Administrar',
                reportes: 'Reportes', 
                ajustes: 'Ajustes' 
            };
            const titleEl = document.getElementById('page-title');
            if (titleEl) {
                titleEl.textContent = titles[section] || 'Inicio';
            }

            // Inicio permanece vacío a petición; no se carga resumen
            
            // Cargar contenido específico de cada sección
            if (section === 'ajustes') {
                initSettings();
            } else if (section === 'clientes') {
                // Vista 'Clientes por Obra' eliminada: se omite carga de resumen por obra
                // Si volvemos a inicio más tarde se puede reusar filtros
            } else if (section === 'clientes-listado') {
                loadClientesTable();
                loadObrasSelect();
                renderObraSummaryCards();
            } else if (section === 'clientes-admin') {
                loadObrasSelect();
                initAdminForms();
            } else if (section === 'registros-resumen') {
                loadObrasSelect();
                initRegistrosFilters();
                loadRegistrosResumen();
            } else if (section === 'registros-add') {
                loadObrasSelect();
                initRegistroAdd();
            } else if (section === 'registros-productos') {
                loadProductosTable();
            } else if (section === 'reportes') {
                loadObrasSelect();
                initReportesResumen();
                initReportesFilters(); // para detallados cuando se abra la pestaña
                loadReportesResumenDiario();
                loadReportesResumenSemanal();
            } else if (section === 'inicio') {
                // Inicializar resumen general cuando se visita Inicio explícitamente
                initResumenGeneral();
            }
            } catch (err) {
                console.error('Error en changeSection("'+section+'"):', err);
                alert('Se produjo un error de script: ' + (err.message||err));
            }
        }

        // ===== Funciones del Manual de Usuario =====
        function showManualSection(sectionName) {
            // Actualizar navegación activa
            document.querySelectorAll('.manual-nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');

            // Ocultar todas las secciones del manual
            document.querySelectorAll('.manual-section').forEach(section => section.classList.remove('active'));

            // Mostrar la sección seleccionada
            const section = document.getElementById('manual-' + sectionName);
            if (section) {
                section.classList.add('active');
            }
        }

        function downloadManualPDF() {
            // Esta función se completará cuando agregues la librería jsPDF
            alert('La descarga en PDF estará disponible pronto. Por ahora, puedes usar Imprimir (Ctrl+P) y guardar como PDF.');
        }

        // Agregar evento al botón Manual
        document.addEventListener('DOMContentLoaded', async function() {
            const manualBtn = document.getElementById('manualBtn');
            if (manualBtn) {
                manualBtn.addEventListener('click', function() {
                    document.querySelectorAll('[id$="-content"]').forEach(content => content.style.display = 'none');
                    const manualEl = document.getElementById('manual-content');
                    if (manualEl) {
                        manualEl.style.display = 'block';
                    }
                });
            }
            
            // Cargar datos del backend al iniciar
            await loadAllDataFromBackend();
        });

        // Inicio vacío: stub conservando getRegistros para otras funciones que lo usan
        function getRegistros() {
            try {
                const raw = localStorage.getItem('registros');
                if (!raw) return [];
                const arr = JSON.parse(raw);
                return Array.isArray(arr) ? arr : [];
            } catch (e) {
                return [];
            }
        }
        function loadInicioResumen() { /* Inicio blank - función vacía intencional */ }
        // ===== Resumen General (Inicio) =====
    let chartResumenEvoDiaria = null;
    let chartRgTotales = null;
    let chartRgProductos = null;
    let chartRgObraTotales = null;

        // Helper: normaliza fechas a ISO AAAA-MM-DD (acepta dd-mm-aaaa y dd/mm/aaaa)
        function convertDateToISO(dateStr) {
            if (!dateStr) return '';
            const v = String(dateStr).trim();
            if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
            const dash = v.match(/^(\d{2})-(\d{2})-(\d{4})$/);
            if (dash) return `${dash[3]}-${dash[2]}-${dash[1]}`;
            const slash = v.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (slash) return `${slash[3]}-${slash[2]}-${slash[1]}`;
            return v;
        }

        function normalizeDateInputs() {
            const inputs = document.querySelectorAll('input[data-datepicker="modern"]');
            const todayIso = new Date().toISOString().split('T')[0];
            inputs.forEach(inp => {
                const iso = convertDateToISO(inp.value) || todayIso;
                inp.value = iso;
            });
        }

        // Normaliza y corrige pares inicio/fin (si están invertidos, los intercambia)
        function normalizeRangePair(idStart, idEnd) {
            const sEl = document.getElementById(idStart);
            const fEl = document.getElementById(idEnd);
            const todayIso = new Date().toISOString().substring(0,10);
            let ini = convertDateToISO(sEl?.value || '');
            let fin = convertDateToISO(fEl?.value || '');
            if (!ini && !fin) { ini = fin = todayIso; }
            else if (!ini) { ini = fin; }
            else if (!fin) { fin = ini; }
            if (ini && fin && ini > fin) { const t = ini; ini = fin; fin = t; }
            if (sEl) sEl.value = ini;
            if (fEl) fEl.value = fin;
            return { ini, fin };
        }

        // Vincula listeners para garantizar start <= end y disparar callback de recarga
        function guardRange(idStart, idEnd, onChange) {
            const sEl = document.getElementById(idStart);
            const fEl = document.getElementById(idEnd);
            const handler = () => {
                normalizeRangePair(idStart, idEnd);
                if (typeof onChange === 'function') onChange();
            };
            if (sEl && !sEl._guarded) { sEl.addEventListener('change', handler); sEl._guarded = true; }
            if (fEl && !fEl._guarded) { fEl.addEventListener('change', handler); fEl._guarded = true; }
        }

        // Coloca valores iniciales coherentes (hoy y rangos recientes) para que los filtros tengan datos al cargar
        function setInitialDateRanges() {
            const today = new Date();
            const todayIso = today.toISOString().substring(0,10);
            const daysAgo = (n)=>{ const d=new Date(today); d.setDate(today.getDate()-n); return d.toISOString().substring(0,10); };

            const setVal = (id, val)=>{ const el=document.getElementById(id); if(el) el.value = val; };

            // Inicio (Resumen General): últimos 7 días
            setVal('resumen-general-fecha-fin', todayIso);
            setVal('resumen-general-fecha-inicio', daysAgo(6));

            // Registros resumen: últimos 30 días
            setVal('filter-registros-fecha-fin', todayIso);
            setVal('filter-registros-fecha-inicio', daysAgo(29));

            // Reporte diario y semanal
            setVal('resumen-diario-fecha', todayIso);
            setVal('resumen-semanal-fecha-fin', todayIso);
            setVal('resumen-semanal-fecha-inicio', daysAgo(6));

            // Reportes detallados: últimos 30 días
            setVal('filter-reportes-fecha-fin', todayIso);
            setVal('filter-reportes-fecha-inicio', daysAgo(29));

            // Añadir registro: día actual
            setVal('registro-fecha', todayIso);
        }

        function initResumenGeneral() {
            const ini = document.getElementById('resumen-general-fecha-inicio');
            const fin = document.getElementById('resumen-general-fecha-fin');
            const btn30 = document.getElementById('btn-rg-rango-30');
            const btnReset = document.getElementById('btn-rg-reset');
            if (!ini || !fin || !btn30 || !btnReset) return; // sección no visible aún
            
            if (!ini._bound) { ini.addEventListener('change', loadResumenGeneral); ini._bound = true; }
            if (!fin._bound) { fin.addEventListener('change', loadResumenGeneral); fin._bound = true; }
            if (!btn30._bound) { btn30.addEventListener('click', () => {
                const today = new Date();
                const start = new Date(today); start.setDate(today.getDate() - 29);
                ini.value = start.toISOString().substring(0,10);
                fin.value = today.toISOString().substring(0,10);
                loadResumenGeneral();
            }); btn30._bound = true; }
            if (!btnReset._bound) { btnReset.addEventListener('click', () => {
                // Reset to default 7-day range
                const today = new Date();
                const sevenDaysAgo = new Date(today); sevenDaysAgo.setDate(today.getDate() - 7);
                ini.value = sevenDaysAgo.toISOString().substring(0,10);
                fin.value = today.toISOString().substring(0,10);
                loadResumenGeneral();
            }); btnReset._bound = true; }
            guardRange('resumen-general-fecha-inicio', 'resumen-general-fecha-fin', loadResumenGeneral);
            loadResumenGeneral();
        }

        function getFilteredRegistrosResumenGeneral() {
            const { ini, fin } = normalizeRangePair('resumen-general-fecha-inicio', 'resumen-general-fecha-fin');
            let data = registros.slice();
            if (ini) data = data.filter(r => r.fecha && r.fecha >= ini);
            if (fin) data = data.filter(r => r.fecha && r.fecha <= fin);
            return data;
        }

        function loadResumenGeneral() {
            const data = getFilteredRegistrosResumenGeneral();
            const empty = document.getElementById('resumen-general-empty');
            const chartsWrap = document.getElementById('resumen-general-charts');
            if (!empty || !chartsWrap) return;
            if (!data.length) {
                empty.style.display = '';
                chartsWrap.style.display = 'none';
                return;
            }
            empty.style.display = 'none';
            chartsWrap.style.display = '';
            renderResumenGeneralCharts(data);
        }

        function destroyResumenGeneralCharts() {
            try { if (chartResumenEvoDiaria) { chartResumenEvoDiaria.destroy(); chartResumenEvoDiaria = null; } } catch {}
            try { if (chartRgTotales) { chartRgTotales.destroy(); chartRgTotales = null; } } catch {}
            try { if (chartRgProductos) { chartRgProductos.destroy(); chartRgProductos = null; } } catch {}
            try { if (chartRgObraTotales) { chartRgObraTotales.destroy(); chartRgObraTotales = null; } } catch {}
        }

        function renderResumenGeneralCharts(data) {
            const colors = getThemeColors();
            // ---- Promedios y Evoluciones ----
            const ini = document.getElementById('resumen-general-fecha-inicio')?.value || '';
            const fin = document.getElementById('resumen-general-fecha-fin')?.value || '';
            let startDate, endDate;
            if (ini && fin) { startDate = new Date(ini+'T00:00:00'); endDate = new Date(fin+'T00:00:00'); }
            else {
                const dates = data.filter(r=>r.fecha).map(r=>r.fecha).sort();
                startDate = dates.length? new Date(dates[0]+'T00:00:00') : new Date();
                endDate = dates.length? new Date(dates[dates.length-1]+'T00:00:00') : new Date();
            }
            const daysList = enumerateDates(startDate, endDate);
            const dayTotals = {};
            data.forEach(r => { if (r.fecha) { dayTotals[r.fecha] = (dayTotals[r.fecha]||0) + Number(r.totalCantidad||0); } });
            const dailyValues = daysList.map(d => dayTotals[d] || 0);
            const totalQtySum = dailyValues.reduce((a,b)=>a+b,0);
            const daysCount = Math.max(1, daysList.length);
            const avgDaily = totalQtySum / daysCount;
            const avgDailyEl = document.getElementById('rg-promedio-diario');
            if (avgDailyEl) avgDailyEl.textContent = Number(avgDaily).toLocaleString('es-ES', { maximumFractionDigits: 1 });
            // Daily chart
            const ctxDaily = document.getElementById('chart-resumen-evo-diaria');
            if (ctxDaily) {
                if (chartResumenEvoDiaria) chartResumenEvoDiaria.destroy();
                chartResumenEvoDiaria = new Chart(ctxDaily, {
                    type: 'line',
                    data: {
                        labels: daysList.map(d => new Date(d+'T00:00:00').toLocaleDateString('es-ES',{month:'short',day:'numeric'})),
                        datasets: [{
                            label: 'Cantidad diaria de productos',
                            data: dailyValues,
                            tension: 0.35,
                            backgroundColor: hexWithAlpha(colors.primary, 0.25),
                            borderColor: colors.primary,
                            borderWidth: 2,
                            fill: true,
                            pointRadius: 2,
                            pointBackgroundColor: colors.primary
                        }]
                    },
                    options: {
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                    }
                });
            }
            // Weekly aggregation
            const weekMap = {};
            daysList.forEach(dstr => {
                const d = new Date(dstr+'T00:00:00');
                const wk = getISOWeekKey(d);
                weekMap[wk] = (weekMap[wk]||0) + (dayTotals[dstr]||0);
            });
            const weekKeys = Object.keys(weekMap).sort();
            const weekValues = weekKeys.map(k => weekMap[k]);
            const weeksCount = Math.max(1, weekKeys.length);
            const avgWeekly = totalQtySum / weeksCount;
            const avgWeeklyEl = document.getElementById('rg-promedio-semanal');
            if (avgWeeklyEl) avgWeeklyEl.textContent = Number(avgWeekly).toLocaleString('es-ES', { maximumFractionDigits: 1 });
            // Total vendido (monetario) en el rango
            let totalVendido = 0;
            data.forEach(r => { totalVendido += Number(r.totalPagado||0); });
            const vendidoEl = document.getElementById('rg-has-vendido');
            if (vendidoEl) vendidoEl.textContent = formatCurrency(totalVendido);
            // ----- Totales dinero y productos cobrados vs por cobrar -----
            renderRgTotales(data, colors);
            renderRgProductos(data, colors);
            renderRgObraTotales(data, colors);
        }

        function hexWithAlpha(hex, alpha=0.3) {
            let c = hex.replace('#','');
            if (c.length===3) c = c.split('').map(ch=>ch+ch).join('');
            const r = parseInt(c.substring(0,2),16);
            const g = parseInt(c.substring(2,4),16);
            const b = parseInt(c.substring(4,6),16);
            return `rgba(${r},${g},${b},${alpha})`;
        }

        function generatePaletteColor(baseHex, index, total) {
            // Simple variante rotando luminosidad y saturación
            const hsl = hexToHsl(baseHex);
            const step = (index / Math.max(1,total-1));
            const l = Math.max(30, Math.min(78, hsl.l * (0.6 + step*0.5)));
            const s = Math.max(35, Math.min(90, hsl.s * (0.7 + step*0.4)));
            return hslToHex(hsl.h + (step*8), s, l);
        }
        function enumerateDates(startDate, endDate) {
            const out = [];
            const d = new Date(startDate);
            const end = new Date(endDate);
            while (d <= end) {
                out.push(d.toISOString().substring(0,10));
                d.setDate(d.getDate()+1);
            }
            return out;
        }
        function getISOWeekKey(d) {
            const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            // Thursday in current week decides the year
            const dayNum = date.getUTCDay() || 7;
            date.setUTCDate(date.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
            const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
            const year = date.getUTCFullYear();
            return `${year}-W${String(weekNo).padStart(2,'0')}`;
        }

        function renderRgTotales(data, colors) {
            const ctx = document.getElementById('chart-rg-totales');
            if (!ctx) return;
            let totalCobrar = 0, totalCobrado = 0;
            data.forEach(r => { totalCobrar += Number(r.totalCobrar||0); totalCobrado += Number(r.totalPagado||0); });
            const totalPendiente = totalCobrar - totalCobrado;
            const ds = {
                labels: ['Total a Cobrar','Total Cobrado','Total Pendiente'],
                datasets: [{
                    label: 'Totales',
                    data: [totalCobrar, totalCobrado, totalPendiente],
                    backgroundColor: [colors.info, colors.success, colors.warning],
                    borderColor: [colors.info, colors.success, colors.warning],
                    borderWidth: 1
                }]
            };
            if (chartRgTotales) { chartRgTotales.destroy(); }
            chartRgTotales = new Chart(ctx, {
                type: 'bar',
                data: ds,
                options: {
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => formatCurrency(ctx.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => '$'+Number(v).toLocaleString('en-US') } }
                    }
                }
            });
        }

        function renderRgProductos(data, colors) {
            const ctx = document.getElementById('chart-rg-productos');
            if (!ctx) return;
            let productosCobrados = 0; // cantidad de productos ya pagados
            let productosPorCobrar = 0; // cantidad de productos con pendiente
            data.forEach(r => {
                // Si un item está pagado cuenta todos sus productos como cobrados.
                (r.items||[]).forEach(it => {
                    const itemTotalQty = (it.productos||[]).reduce((a,b)=>a + Number(b.cantidad||0),0);
                    if (it.pagado) productosCobrados += itemTotalQty; else productosPorCobrar += itemTotalQty;
                });
            });
            const ds = {
                labels: ['Cobrados','Por Cobrar'],
                datasets: [{
                    data: [productosCobrados, productosPorCobrar],
                    backgroundColor: [colors.success, colors.warning],
                    borderWidth: 2,
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--app-bg').trim() || '#fff'
                }]
            };
            if (chartRgProductos) { chartRgProductos.destroy(); }
            chartRgProductos = new Chart(ctx, {
                type: 'pie',
                data: ds,
                options: {
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => ctx.label+': '+ctx.parsed+' uds'
                            }
                        }
                    }
                }
            });
            // Construir leyenda personalizada con círculos
            const legendBox = document.getElementById('legend-rg-productos');
            if (legendBox) {
                legendBox.innerHTML = '';
                const labels = ds.labels;
                labels.forEach((lab, i) => {
                    const val = ds.datasets[0].data[i];
                    const color = ds.datasets[0].backgroundColor[i];
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `<span class="swatch" style="background:${color}"></span><span>${lab}: <strong>${val}</strong></span>`;
                    legendBox.appendChild(div);
                });
            }
            // Aumentar el radio del pastel para usar mejor el espacio
            if (chartRgProductos) {
                const base = chartRgProductos.options.layout || (chartRgProductos.options.layout = {});
                // Remove default padding if any to maximize radius
                base.padding = 0;
                chartRgProductos.options.plugins.tooltip.padding = 8;
                chartRgProductos.update();
            }
        }

        function renderRgObraTotales(data, colors) {
            const ctx = document.getElementById('chart-rg-obra-totales');
            if (!ctx) return;

            // Agregar por obra: total a cobrar, total cobrado y pendiente (a cobrar - cobrado)
            const mapa = new Map(); // obra -> { cobrar, cobrado }
            data.forEach(r => {
                const obra = r.obra || 'Sin Obra';
                const cur = mapa.get(obra) || { cobrar: 0, cobrado: 0 };
                cur.cobrar += Number(r.totalCobrar || 0);
                cur.cobrado += Number(r.totalPagado || 0);
                mapa.set(obra, cur);
            });

            const obras = Array.from(mapa.keys());
            const cobrar = obras.map(o => mapa.get(o).cobrar);
            const cobrado = obras.map(o => mapa.get(o).cobrado);
            const pendiente = obras.map((o, i) => Math.max(0, cobrar[i] - cobrado[i]));

            const ds = {
                labels: obras,
                datasets: [
                    {
                        label: 'A Cobrar',
                        data: cobrar,
                        backgroundColor: colors.info,
                        borderColor: colors.info
                    },
                    {
                        label: 'Cobrado',
                        data: cobrado,
                        backgroundColor: colors.success,
                        borderColor: colors.success
                    },
                    {
                        label: 'Pendiente',
                        data: pendiente,
                        backgroundColor: colors.warning,
                        borderColor: colors.warning
                    }
                ]
            };

            if (chartRgObraTotales) chartRgObraTotales.destroy();
            chartRgObraTotales = new Chart(ctx, {
                type: 'bar',
                data: ds,
                options: {
                    indexAxis: 'y',
                    plugins: {
                        legend: { 
                            position: 'bottom', 
                            labels: { usePointStyle: true, pointStyle: 'circle', boxWidth: 10, boxHeight: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.x)}`
                            }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, ticks: { callback: v => '$' + Number(v).toLocaleString('en-US') } },
                        y: { ticks: { autoSkip: false } }
                    }
                }
            });
        }

        /* Removed corrupted duplicate product & settings code block */

        async function loadProfile(username) {
            try {
                const resp = await fetch(`${BASE_API}/api/user?username=${encodeURIComponent(username)}`);
                const data = await resp.json();
                if (!resp.ok) throw new Error(data?.message || `Error ${resp.status}`);
                document.getElementById('current-username').value = data.username;
                document.getElementById('current-email').value = data.email;
            } catch (e) {
                showSettingsAlert(e.message || 'No se pudo cargar el perfil', 'danger');
            }
        }

        function initSettings() {
            if (settingsInitialized) return; // evitar múltiples binds
            settingsInitialized = true;

            const username = sessionStorage.getItem('username');
            if (username) loadProfile(username);

            // Validaciones de contraseña
            const newPwd = document.getElementById('new-password');
            const confirmPwd = document.getElementById('confirm-password');
            const ruleCase = document.getElementById('rule-case');
            const ruleNumber = document.getElementById('rule-number');
            const ruleLength = document.getElementById('rule-length');
            const rulesBox = document.getElementById('pwd-rules');
            const confirmError = document.getElementById('confirm-error');
            const btnSavePwd = document.getElementById('btn-save-password');

            function validatePasswordUI() {
                const vCase = /[a-z]/.test(newPwd.value) && /[A-Z]/.test(newPwd.value);
                const vNum = /\d/.test(newPwd.value);
                const vLen = newPwd.value.length > 6;
                ruleCase.className = `validation-item ${vCase ? 'valid' : 'invalid'}`;
                ruleCase.textContent = `${vCase ? '✓' : '✗'} Debe contener mayúsculas y minúsculas`;
                ruleNumber.className = `validation-item ${vNum ? 'valid' : 'invalid'}`;
                ruleNumber.textContent = `${vNum ? '✓' : '✗'} Debe contener números`;
                ruleLength.className = `validation-item ${vLen ? 'valid' : 'invalid'}`;
                ruleLength.textContent = `${vLen ? '✓' : '✗'} Debe tener más de 6 caracteres`;
                return vCase && vNum && vLen;
            }

            let pwdTouched = false;
            newPwd.addEventListener('input', () => {
                if (!pwdTouched) { rulesBox.style.display = 'block'; pwdTouched = true; }
                const allOk = validatePasswordUI();
                const match = confirmPwd.value && (confirmPwd.value === newPwd.value);
                confirmError.style.display = match || !confirmPwd.value ? 'none' : 'block';
                btnSavePwd.disabled = !(allOk && match);
            });
            confirmPwd.addEventListener('input', () => {
                const allOk = validatePasswordUI();
                const match = confirmPwd.value === newPwd.value;
                confirmError.style.display = match ? 'none' : 'block';
                btnSavePwd.disabled = !(allOk && match);
            });

            // Submit: cambiar correo
            document.getElementById('form-email').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('new-email').value.trim();
                const username = sessionStorage.getItem('username');
                try {
                    const fd = new FormData();
                    fd.append('username', username);
                    fd.append('email', email);
                    const resp = await fetch(`${BASE_API}/api/settings/update-email`, { method: 'POST', body: fd });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data?.message || `Error ${resp.status}`);
                    showSettingsAlert('Correo actualizado correctamente', 'success');
                    document.getElementById('current-email').value = email;
                    e.target.reset();
                } catch (err) {
                    showSettingsAlert(err.message || 'No se pudo actualizar el correo', 'danger');
                }
            });

            // Submit: cambiar usuario
            document.getElementById('form-username').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newUsername = document.getElementById('new-username').value.trim();
                const oldUsername = sessionStorage.getItem('username');
                try {
                    const fd = new FormData();
                    fd.append('username', oldUsername);
                    fd.append('new_username', newUsername);
                    const resp = await fetch(`${BASE_API}/api/settings/update-username`, { method: 'POST', body: fd });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data?.message || `Error ${resp.status}`);
                    showSettingsAlert('Usuario actualizado correctamente', 'success');
                    sessionStorage.setItem('username', newUsername);
                    document.getElementById('username-display').textContent = newUsername;
                    document.getElementById('current-username').value = newUsername;
                    e.target.reset();
                } catch (err) {
                    showSettingsAlert(err.message || 'No se pudo actualizar el usuario', 'danger');
                }
            });

            // Submit: cambiar contraseña
            document.getElementById('form-password').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = sessionStorage.getItem('username');
                const current_password = document.getElementById('current-password').value;
                const new_password = document.getElementById('new-password').value;
                const confirm_password = document.getElementById('confirm-password').value;
                try {
                    const fd = new FormData();
                    fd.append('username', username);
                    fd.append('current_password', current_password);
                    fd.append('new_password', new_password);
                    fd.append('confirm_password', confirm_password);
                    const resp = await fetch(`${BASE_API}/api/settings/update-password`, { method: 'POST', body: fd });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data?.message || `Error ${resp.status}`);
                    showSettingsAlert('Contraseña actualizada correctamente', 'success');
                    e.target.reset();
                    document.getElementById('pwd-rules').style.display = 'none';
                    document.getElementById('btn-save-password').disabled = true;
                } catch (err) {
                    showSettingsAlert(err.message || 'No se pudo actualizar la contraseña', 'danger');
                }
            });
        }

        // ----- Preferencias -----
        function getPrefs() {
            try { return JSON.parse(localStorage.getItem('app_prefs') || '{}'); }
            catch { return {}; }
        }
        function setPrefs(prefs) { localStorage.setItem('app_prefs', JSON.stringify(prefs)); }

        // ---- Helpers de color ----
        function hexToHsl(hex) {
            let c = hex.replace('#','');
            if (c.length === 3) c = c.split('').map(ch => ch+ch).join('');
            const r = parseInt(c.substring(0,2),16) / 255;
            const g = parseInt(c.substring(2,4),16) / 255;
            const b = parseInt(c.substring(4,6),16) / 255;
            const max = Math.max(r,g,b), min = Math.min(r,g,b);
            let h, s, l = (max + min) / 2;
            if (max === min) { h = s = 0; }
            else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch(max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h*360, s: s*100, l: l*100 };
        }
        function hslToHex(h,s,l) {
            h/=360; s/=100; l/=100;
            const hue2rgb = (p,q,t)=>{ if(t<0) t+=1; if(t>1) t-=1; if(t<1/6) return p+(q-p)*6*t; if(t<1/2) return q; if(t<2/3) return p+(q-p)*(2/3 - t)*6; return p; };
            let r,g,b;
            if (s === 0) { r=g=b=l; }
            else {
                const q = l < 0.5 ? l * (1 + s) : l + s - l*s;
                const p = 2 * l - q;
                r = hue2rgb(p,q,h + 1/3);
                g = hue2rgb(p,q,h);
                b = hue2rgb(p,q,h - 1/3);
            }
            const toHex = x => ('0' + Math.round(x*255).toString(16)).slice(-2);
            return '#' + toHex(r) + toHex(g) + toHex(b);
        }
        function desaturateHex(hex, satFactor = 0.35, lightAdjust = -12) {
            const hsl = hexToHsl(hex);
            const s = Math.max(0, Math.min(100, hsl.s * satFactor));
            const l = Math.max(0, Math.min(100, hsl.l + lightAdjust));
            return hslToHex(hsl.h, s, l);
        }

        let mediaListener = null;
        function applyPrefs(prefs) {
            const themePref = prefs.theme || 'light';
            const darkPreferred = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const themeMode = themePref === 'system' ? (darkPreferred ? 'dark' : 'light') : themePref;
            let color = prefs.primaryColor || '#0d6efd';
            if (themeMode === 'dark') color = desaturateHex(color, 0.35, -12);
            document.documentElement.setAttribute('data-bs-theme', themeMode);
            document.documentElement.style.setProperty('--bs-primary', color);
            document.documentElement.style.setProperty('--bs-primary-rgb', hexToRgb(color));
            // Forzar repintado de sidebar y avatar del usuario
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) sidebar.style.background = color;
            const avatar = document.querySelector('.user-avatar');
            if (avatar) avatar.style.background = color;
            // Actualizar todos los botones primarios dinámicamente
            document.querySelectorAll('.btn-primary').forEach(btn => {
                btn.style.setProperty('--bs-btn-bg', color);
                btn.style.setProperty('--bs-btn-border-color', color);
                btn.style.backgroundColor = color;
                btn.style.borderColor = color;
            });
            
            // Actualizar gráficos si están visibles
            refreshChartsWithTheme();
        }
        function hexToRgb(hex) {
            let c = hex.replace('#','');
            if (c.length === 3) c = c.split('').map(ch=>ch+ch).join('');
            const r = parseInt(c.substring(0,2),16);
            const g = parseInt(c.substring(2,4),16);
            const b = parseInt(c.substring(4,6),16);
            return `${r}, ${g}, ${b}`;
        }
        function bindSystemThemeListener(prefs) {
            if (!window.matchMedia) return;
            const mq = window.matchMedia('(prefers-color-scheme: dark)');
            if (mediaListener) { mq.removeEventListener('change', mediaListener); mediaListener = null; }
            if ((prefs.theme || 'light') === 'system') {
                mediaListener = () => applyPrefs(prefs);
                mq.addEventListener('change', mediaListener);
            }
        }
        function goToProfile() {
            // Activar Ajustes en el sidebar
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            const ajustesLink = document.querySelector('a[href="#ajustes"]');
            if (ajustesLink) ajustesLink.closest('.menu-item').classList.add('active');
            // Ocultar todos los contenidos
            document.querySelectorAll('[id$="-content"]').forEach(content => content.style.display = 'none');
            // Mostrar Ajustes
            document.getElementById('ajustes-content').style.display = 'block';
            // Inicializar ajustes si no se ha hecho
            if (window.initSettings) initSettings();
            // Activar pestaña Perfil explícitamente
            try {
                const tabEl = document.querySelector('#perfil-tab');
                if (tabEl && window.bootstrap && bootstrap.Tab) {
                    const tab = new bootstrap.Tab(tabEl);
                    tab.show();
                } else if (tabEl) {
                    // Fallback: activar clases
                    document.querySelectorAll('#settingsTabs .nav-link').forEach(el => el.classList.remove('active'));
                    tabEl.classList.add('active');
                    document.querySelectorAll('#settingsTabsContent .tab-pane').forEach(el => el.classList.remove('show','active'));
                    const pane = document.querySelector('#perfil');
                    if (pane) { pane.classList.add('show','active'); }
                }
            } catch {}
        }
        function initPreferences() {
            const prefs = getPrefs();
            const themeSelect = document.getElementById('theme-select');
            const colorInput = document.getElementById('primary-color');
            const palette = document.getElementById('color-palette');
            const logoInput = document.getElementById('business-logo-input');
            const logoPreview = document.getElementById('business-logo-preview');
            const logoRemoveBtn = document.getElementById('business-logo-remove');
            let pendingLogoDataUrl = null; // temporal hasta guardar

            // Preseleccionar UI
            themeSelect.value = (['light','dark','system'].includes(prefs.theme) ? prefs.theme : 'light');
            colorInput.value = prefs.primaryColor || '#0d6efd';

            // Cargar logo si existe
            if (prefs.businessLogo) {
                logoPreview.src = prefs.businessLogo;
                logoPreview.style.display = '';
                logoRemoveBtn.style.display = '';
            } else {
                logoPreview.style.display = 'none';
                logoRemoveBtn.style.display = 'none';
            }

            // Manejar carga de logo
            if (logoInput) {
                logoInput.addEventListener('change', () => {
                    const file = logoInput.files && logoInput.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = () => {
                        pendingLogoDataUrl = reader.result;
                        logoPreview.src = pendingLogoDataUrl;
                        logoPreview.style.display = '';
                        logoRemoveBtn.style.display = '';
                        showPrefsAlert('Logo cargado (pendiente de guardar)', 'info');
                    };
                    reader.readAsDataURL(file);
                });
            }
            if (logoRemoveBtn) {
                logoRemoveBtn.addEventListener('click', () => {
                    pendingLogoDataUrl = null;
                    logoPreview.src = '';
                    logoPreview.style.display = 'none';
                    logoInput.value = '';
                    logoRemoveBtn.style.display = 'none';
                    // Si existía en prefs, lo quitaremos al guardar
                    showPrefsAlert('Logo eliminado (pendiente de guardar)', 'warning');
                });
            }

            // Cargar preferencias de resúmenes
            if (prefs.resumenes) {
                loadResumenPreferences(prefs.resumenes);
                applyResumenVisibility(prefs.resumenes);
            }

            // Paleta
            function previewWithColor(hex) {
                const newPrefs = { theme: themeSelect.value, primaryColor: hex };
                applyPrefs(newPrefs);
                bindSystemThemeListener(newPrefs);
                showPrefsAlert('Preferencias aplicadas', 'success');
            }
            if (palette) {
                palette.querySelectorAll('.color-swatch').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const hex = btn.getAttribute('data-color');
                        colorInput.value = hex;
                        previewWithColor(hex);
                    });
                });
                const btnCustom = document.getElementById('btn-custom-color');
                if (btnCustom) btnCustom.addEventListener('click', () => colorInput.click());
            }
            colorInput.addEventListener('input', () => previewWithColor(colorInput.value));

            // Botones
            document.getElementById('btn-reset-color').addEventListener('click', () => {
                colorInput.value = '#0d6efd';
                previewWithColor('#0d6efd');
            });
            document.getElementById('btn-apply-prefs').addEventListener('click', () => {
                const newPrefs = { 
                    theme: themeSelect.value, 
                    primaryColor: colorInput.value,
                    resumenes: getResumenPreferences(),
                    businessLogo: pendingLogoDataUrl !== null ? pendingLogoDataUrl : (prefs.businessLogo || null)
                };
                applyPrefs(newPrefs);
                bindSystemThemeListener(newPrefs);
                applyResumenVisibility(newPrefs.resumenes);
                showPrefsAlert('Preferencias aplicadas', 'success');
            });
            document.getElementById('btn-save-prefs').addEventListener('click', () => {
                const newPrefs = { 
                    theme: themeSelect.value, 
                    primaryColor: colorInput.value,
                    resumenes: getResumenPreferences(),
                    businessLogo: pendingLogoDataUrl !== null ? pendingLogoDataUrl : (prefs.businessLogo || null)
                };
                setPrefs(newPrefs);
                applyPrefs(newPrefs);
                bindSystemThemeListener(newPrefs);
                applyResumenVisibility(newPrefs.resumenes);
                showPrefsAlert('Preferencias guardadas', 'success');
            });
        }
        function showPrefsAlert(message, type='info') {
            const box = document.getElementById('prefs-alert');
            box.textContent = message;
            box.className = `alert alert-${type}`;
            box.classList.remove('d-none');
        }

        // Obtener preferencias de resúmenes desde los checkboxes
        function getResumenPreferences() {
            const toggles = document.querySelectorAll('.resumen-toggle');
            const prefs = {};
            toggles.forEach(toggle => {
                const resumenKey = toggle.getAttribute('data-resumen');
                prefs[resumenKey] = toggle.checked;
            });
            return prefs;
        }

        // Aplicar visibilidad de resúmenes según preferencias
        function applyResumenVisibility(resumenes) {
            if (!resumenes) return;
            
            // Mapeo de las claves de preferencias a los IDs de las tarjetas
            const cardMapping = {
                'promedio-diario': 'card-promedio-diario',
                'promedio-semanal': 'card-promedio-semanal',
                'has-vendido': 'card-has-vendido',
                'evolucion-diaria': 'card-evolucion-diaria',
                'productos-pie': 'card-productos-pie',
                'totales-obra': 'card-totales-obra',
                'totales-globales': 'card-totales-globales'
            };
            
            Object.keys(cardMapping).forEach(key => {
                const cardElement = document.getElementById(cardMapping[key]);
                if (cardElement) {
                    cardElement.style.display = resumenes[key] !== false ? '' : 'none';
                }
            });
        }

        // Cargar preferencias de resúmenes en los checkboxes
        function loadResumenPreferences(resumenes) {
            if (!resumenes) return;
            
            Object.keys(resumenes).forEach(key => {
                const toggle = document.querySelector(`[data-resumen="${key}"]`);
                if (toggle) {
                    toggle.checked = resumenes[key] !== false;
                }
            });
        }

        // ===== GESTIÓN DE CLIENTES Y OBRAS =====
        
        // Datos cargados desde el backend
    let clientes = [];
    let obras = [];
    let registros = [];
    let productos = [];

    // Cargar todos los datos desde el backend
    async function loadAllDataFromBackend() {
        const username = sessionStorage.getItem('username');
        if (!username || username === 'demo') {
            // Modo demo: usar localStorage
            clientes = JSON.parse(localStorage.getItem('clientes')) || [];
            obras = JSON.parse(localStorage.getItem('obras')) || [];
            registros = JSON.parse(localStorage.getItem('registros')) || [];
            productos = JSON.parse(localStorage.getItem('productos')) || [];
            console.log('Modo demo activado - usando localStorage');
            return;
        }

        try {
            // Cargar datos reales desde el backend
            console.log('Cargando datos desde el backend para:', username);
            
            const [clientesData, obrasData, productosData, registrosData] = await Promise.all([
                API.getClientes(),
                API.getObras(),
                API.getProductos(),
                API.getRegistros()
            ]);

            clientes = clientesData || [];
            obras = obrasData || [];
            productos = productosData || [];
            registros = (registrosData || []).map(r => {
                // Normalizar: asegurar que exista 'items' para edición/visualización
                const items = r.items || r.detalles || [];
                return { ...r, items };
            });

            console.log(`✓ Datos cargados: ${clientes.length} clientes, ${obras.length} obras, ${productos.length} productos, ${registros.length} registros`);
        } catch (error) {
            console.error('Error al cargar datos:', error);
            alert('Error al cargar datos del servidor. Por favor, recarga la página.');
            throw error;
        }
    }


    // Normaliza fechas guardadas a ISO (AAAA-MM-DD) para que los filtros funcionen
    (function normalizeStoredDates(){
        const toIso = (val) => {
            if (!val) return '';
            if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val; // ya ISO
            const dash = val.match(/^(\d{2})-(\d{2})-(\d{4})$/);
            if (dash) return `${dash[3]}-${dash[2]}-${dash[1]}`;
            const slash = val.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (slash) return `${slash[3]}-${slash[2]}-${slash[1]}`;
            return val;
        };
        let changed = false;
        registros = (registros || []).map(r => {
            const iso = toIso(r.fecha);
            if (iso !== r.fecha) { changed = true; return { ...r, fecha: iso }; }
            return r;
        });
        if (changed) {
            try { localStorage.setItem('registros', JSON.stringify(registros)); } catch {}
        }
    })();
    let currentReportesFiltered = [];
    let chartDiario = null;
    let chartSemanal = null;
    let detalladosResumenMode = 'general';
    let currentEditRegistroId = null; // para editar un registro existente
    // Pivot (modo Por Día) metadata
    let pivotDayList = [];
    let pivotRows = [];
    let pivotIsActive = false;
    let originalReportesTheadHtml = '';

        // Cargar obras en los selectores
        function loadObrasSelect() {
            const selects = ['cliente-obra', 'edit-cliente-obra', 'filter-obra', 'add-clientes-obra', 'admin-cliente-obra', 'filter-reportes-obra'];
            // Agregar select de registros si existe
            if (document.getElementById('filter-registros-obra')) selects.push('filter-registros-obra');
            if (document.getElementById('registro-obra')) selects.push('registro-obra');
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                const isFilter = selectId === 'filter-obra';
                
                // Limpiar opciones excepto la primera
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Añadir obras
                obras.forEach(obra => {
                    const option = document.createElement('option');
                    option.value = obra.nombre;
                    option.textContent = obra.nombre;
                    select.appendChild(option);
                });

                // Si es el select de registro de obra, añadir opción especial para registro adicional
                if (selectId === 'registro-obra') {
                    const extra = document.createElement('option');
                    extra.value = '__ADICIONAL__';
                    extra.textContent = '+ Registro Adicional';
                    extra.className = 'text-primary fw-semibold';
                    select.appendChild(extra);
                }
                
                // Restaurar valor si existía
                if (currentValue) select.value = currentValue;
            });
        }

        // Navegar a Añadir Registro desde Resumen
        function goToAddRegistro() {
            currentEditRegistroId = null;
            
            // Restaurar título
            const title = document.getElementById('registro-add-title');
            if (title) title.textContent = 'Añadir Registro';
            
            // Restaurar modo edición (deshabilitar readonly)
            setReadonlyMode(false);
            
            changeSection('registros-add');
        }

        // ===== Registros - Resumen =====
        function initRegistrosFilters() {
            const fObra = document.getElementById('filter-registros-obra');
            const fIni = document.getElementById('filter-registros-fecha-inicio');
            const fFin = document.getElementById('filter-registros-fecha-fin');
            if (fObra && !fObra._bound) { fObra.addEventListener('change', loadRegistrosResumen); fObra._bound = true; }
            guardRange('filter-registros-fecha-inicio', 'filter-registros-fecha-fin', loadRegistrosResumen);
        }

        function loadRegistrosResumen() {
            const accordion = document.getElementById('registros-accordion');
            const emptyPlaceholder = document.getElementById('registros-resumen-empty');
            if (!accordion || !emptyPlaceholder) return;

            const obra = document.getElementById('filter-registros-obra')?.value || '';
            const { ini: fi, fin: ff } = normalizeRangePair('filter-registros-fecha-inicio', 'filter-registros-fecha-fin');
            let data = registros;
            if (obra) data = data.filter(r => r.obra === obra);
            if (fi) data = data.filter(r => !r.fecha || r.fecha >= fi);
            if (ff) data = data.filter(r => !r.fecha || r.fecha <= ff);

            if (!data || data.length === 0) {
                accordion.style.display = 'none';
                emptyPlaceholder.style.display = 'block';
                return;
            }

            emptyPlaceholder.style.display = 'none';
            accordion.style.display = 'block';

            // Agrupar solo por fecha y renderizar headers de fecha (sin contenido interno por ahora)
            const porFecha = {};
            data.forEach(r => {
                const f = r.fecha || 'Sin fecha';
                if (!porFecha[f]) porFecha[f] = 0;
                porFecha[f] += 1;
            });

            const fechasOrdenadas = Object.keys(porFecha).sort((a,b) => b.localeCompare(a));

            const accordionHtml = fechasOrdenadas.map((fecha, idx) => {
                const fId = `fecha-acc-${fecha.replace(/[^a-zA-Z0-9]/g,'')}`;
                const show = idx === 0 ? 'show' : '';
                const collapsed = idx === 0 ? '' : 'collapsed';
                const fechaLabel = fecha !== 'Sin fecha' ? new Date(fecha+'T00:00:00').toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'}) : 'Sin fecha';
                const count = porFecha[fecha];
                // Obtener registros de esa fecha para renderizar tarjetas simples
                const regsFecha = data.filter(r => (r.fecha || 'Sin fecha') === fecha);
                const cards = regsFecha.map(r => {
                    const cobrar = Number(r.totalCobrar || 0);
                    const pagado = Number(r.totalPagado || 0);
                    const pendiente = cobrar - pagado;
                    const totalUds = r.totalCantidad || 0;
                    const status = (r.status || (pagado >= cobrar && cobrar>0? 'pagado' : (pagado>0? 'parcial' : 'pendiente')));
                    const statusCfg = {
                        pagado: { cls: 'success', text: 'Pagado' },
                        parcial: { cls: 'warning', text: 'Parcial' },
                        pendiente: { cls: 'danger', text: 'Pendiente' }
                    }[status] || { cls: 'secondary', text: status };
                    const obraLabel = r.obra || (Array.isArray(r.clientesAdicionales) && r.clientesAdicionales.length? 'Clientes adicionales' : 'Sin obra');
                    const adicionalDetalle = (!r.obra && r.clientesAdicionales && r.clientesAdicionales.length) ? `<div class='small text-muted'>${r.clientesAdicionales.join(', ')}</div>` : '';
                    return `<div class='card mb-2 shadow-sm registro-card' data-registro-id='${r.id}'>
                        <div class='card-body pt-2 pb-3'>
                            <div class='d-flex justify-content-between align-items-start mb-2'>
                                <div class='me-3'>
                                    <div class='fw-semibold'>${obraLabel} <span class="text-muted small ms-2">${totalUds} productos registrados</span></div>
                                    ${adicionalDetalle}
                                </div>
                                <div class='d-flex align-items-center gap-2 flex-shrink-0'>
                                    <span class='badge bg-${statusCfg.cls}'>${statusCfg.text}</span>
                                    <button class='btn btn-outline-info btn-sm' onclick='viewRegistroDetalle(${r.id})' title='Ver'>
                                        <svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='currentColor' width='16' height='16'><path stroke-linecap='round' stroke-linejoin='round' d='M2.25 12c0 0 4.5-7.5 9.75-7.5S21.75 12 21.75 12 17.25 19.5 12 19.5 2.25 12 2.25 12z' /><path stroke-linecap='round' stroke-linejoin='round' d='M12 15a3 3 0 100-6 3 3 0 000 6z' /></svg>
                                    </button>
                                    <button class='btn btn-outline-secondary btn-sm' onclick='editRegistro(${r.id})' title='Modificar'>
                                        <svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='currentColor' width='16' height='16'><path stroke-linecap='round' stroke-linejoin='round' d='M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z' /></svg>
                                    </button>
                                    <button class='btn btn-outline-danger btn-sm' onclick='deleteRegistro(${r.id})' title='Eliminar'>
                                        <svg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='currentColor' width='16' height='16'><path stroke-linecap='round' stroke-linejoin='round' d='M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0' /></svg>
                                    </button>
                                </div>
                            </div>
                            <div class='row g-2 mb-2'>
                                <div class='col-12 col-md-4'>
                                    <div class='border border-2 rounded p-2 h-100 text-center bg-light' style='border-color: var(--bs-primary) !important;'>
                                        <div class='small text-muted'>Total a Cobrar</div>
                                        <div class='fw-bold' style='color: var(--bs-primary);'>${cobrar.toLocaleString('en-US',{style:'currency',currency:'USD'})}</div>
                                    </div>
                                </div>
                                <div class='col-12 col-md-4'>
                                    <div class='border border-success border-2 rounded p-2 h-100 text-center bg-light'>
                                        <div class='small text-muted'>Total Cobrado</div>
                                        <div class='fw-bold text-success'>${pagado.toLocaleString('en-US',{style:'currency',currency:'USD'})}</div>
                                    </div>
                                </div>
                                <div class='col-12 col-md-4'>
                                    <div class='border border-${pendiente>0?'warning':'secondary'} border-2 rounded p-2 h-100 text-center bg-light'>
                                        <div class='small text-muted'>Total Pendiente</div>
                                        <div class='fw-bold text-${pendiente>0?'warning':'secondary'}'>${pendiente.toLocaleString('en-US',{style:'currency',currency:'USD'})}</div>
                                    </div>
                                </div>
                            </div>
                            <div class='small text-muted'>${totalUds} productos registrados</div>
                        </div>
                    </div>`;
                }).join('');
                return `<div class="accordion-item">
                    <h2 class="accordion-header" id="${fId}-heading">
                        <button class="accordion-button ${collapsed}" type="button" data-bs-toggle="collapse" data-bs-target="#${fId}" aria-expanded="${idx===0}" aria-controls="${fId}">
                            <div class="d-flex justify-content-between align-items-center w-100 pe-3">
                                <strong>Registro ${fechaLabel}</strong>
                                <span class="text-muted small">${count} registro(s)</span>
                            </div>
                        </button>
                    </h2>
                    <div id="${fId}" class="accordion-collapse collapse ${show}" aria-labelledby="${fId}-heading" data-bs-parent="#registros-accordion">
                        <div class="accordion-body p-2">
                            ${cards || '<div class=\'text-muted small\'>Sin registros en esta fecha</div>'}
                        </div>
                    </div>
                </div>`;
            }).join('');

            accordion.innerHTML = accordionHtml;
        }

        // ===== Reportes =====
        function initReportesFilters() {
            const fObra = document.getElementById('filter-reportes-obra');
            const fIni = document.getElementById('filter-reportes-fecha-inicio');
            const fFin = document.getElementById('filter-reportes-fecha-fin');
            if (fObra && !fObra._bound) { fObra.addEventListener('change', loadReportesView); fObra._bound = true; }
            guardRange('filter-reportes-fecha-inicio', 'filter-reportes-fecha-fin', loadReportesView);
            const mSel = document.getElementById('detallados-resumen-selector');
            if (mSel && !mSel._bound) { mSel.addEventListener('change', () => { detalladosResumenMode = mSel.value; loadReportesView(); }); mSel._bound = true; }
            // Guardar encabezado original
            if (!originalReportesTheadHtml) {
                const thead = document.querySelector('#reportes-table thead');
                if (thead) originalReportesTheadHtml = thead.innerHTML;
            }
        }

        // ===== Resumen Reportes (Diario / Semanal) =====
        function initReportesResumen() {
            const diarioFecha = document.getElementById('resumen-diario-fecha');
            const semanalIni = document.getElementById('resumen-semanal-fecha-inicio');
            const semanalFin = document.getElementById('resumen-semanal-fecha-fin');
            const today = new Date();
            if (diarioFecha && !diarioFecha.value) diarioFecha.value = today.toISOString().substring(0,10);
            if (semanalIni && !semanalIni.value) {
                const start = new Date(today); start.setDate(today.getDate()-6);
                semanalIni.value = start.toISOString().substring(0,10);
            }
            if (semanalFin && !semanalFin.value) semanalFin.value = today.toISOString().substring(0,10);
            if (diarioFecha && !diarioFecha._bound) { diarioFecha.addEventListener('change', loadReportesResumenDiario); diarioFecha._bound = true; }
            guardRange('resumen-semanal-fecha-inicio', 'resumen-semanal-fecha-fin', loadReportesResumenSemanal);

            // Selector de vista de resumen
            // Si existiera un selector de vista para esta pestaña, se ignorará por ahora (reubicado en Detallados)
        }

        // applyResumenViewMode ya no se usa en esta pestaña.

        function loadReportesResumenDiario() {
            const fecha = convertDateToISO(document.getElementById('resumen-diario-fecha')?.value);
            const cobrarEl = document.getElementById('resumen-diario-cobrar');
            const cobradoEl = document.getElementById('resumen-diario-cobrado');
            const pendienteEl = document.getElementById('resumen-diario-pendiente');
            const cantidadEl = document.getElementById('resumen-diario-cantidad');
            if (!fecha) return;
            const regs = registros.filter(r => r.fecha === fecha);
            let cobrar=0,cobrado=0,pend=0,cant=0;
            regs.forEach(r=>{ cobrar+=Number(r.totalCobrar||0); cobrado+=Number(r.totalPagado||0); pend+=Number(r.totalCobrar||0)-Number(r.totalPagado||0); cant+=Number(r.totalCantidad||0); });
            if (cobrarEl) cobrarEl.textContent = cobrar.toLocaleString('en-US',{style:'currency',currency:'USD'});
            if (cobradoEl) cobradoEl.textContent = cobrado.toLocaleString('en-US',{style:'currency',currency:'USD'});
            if (pendienteEl) pendienteEl.textContent = pend.toLocaleString('en-US',{style:'currency',currency:'USD'});
            if (cantidadEl) cantidadEl.textContent = cant;
            updateChartDiario(cobrar, cobrado, pend);
        }

        function loadReportesResumenSemanal() {
            const { ini, fin } = normalizeRangePair('resumen-semanal-fecha-inicio', 'resumen-semanal-fecha-fin');
            const cobrarEl = document.getElementById('resumen-semanal-cobrar');
            const cobradoEl = document.getElementById('resumen-semanal-cobrado');
            const pendienteEl = document.getElementById('resumen-semanal-pendiente');
            const cantidadEl = document.getElementById('resumen-semanal-cantidad');
            if (!ini || !fin) return;
            const regs = registros.filter(r => r.fecha && r.fecha >= ini && r.fecha <= fin);
            let cobrar=0,cobrado=0,pend=0,cant=0;
            regs.forEach(r=>{ cobrar+=Number(r.totalCobrar||0); cobrado+=Number(r.totalPagado||0); pend+=Number(r.totalCobrar||0)-Number(r.totalPagado||0); cant+=Number(r.totalCantidad||0); });
            if (cobrarEl) cobrarEl.textContent = cobrar.toLocaleString('en-US',{style:'currency',currency:'USD'});
            if (cobradoEl) cobradoEl.textContent = cobrado.toLocaleString('en-US',{style:'currency',currency:'USD'});
            if (pendienteEl) pendienteEl.textContent = pend.toLocaleString('en-US',{style:'currency',currency:'USD'});
            if (cantidadEl) cantidadEl.textContent = cant;
            updateChartSemanal(regs, ini, fin);
        }

        // Gráficas con colores adaptados al tema
        function getThemeColors() {
            // Obtener color primario del tema activo
            const primary = getComputedStyle(document.documentElement).getPropertyValue('--bs-primary').trim() || '#0d6efd';
            
            // Convertir a HSL para generar variaciones más diferenciadas
            const hsl = hexToHsl(primary);
            
            // Generar variaciones del color primario con mayor contraste
            // Color 1 (A Cobrar): Versión más clara y menos saturada
            const color1 = hslToHex(hsl.h, Math.max(0, hsl.s * 0.6), Math.min(100, hsl.l + 25));
            
            // Color 2 (Cobrado): Color base/primario (tono medio)
            const color2 = primary;
            
            // Color 3 (Pendiente): Versión muy saturada y mucho más oscura
            const color3 = hslToHex(hsl.h, Math.min(100, hsl.s * 1.5), Math.max(0, hsl.l - 20));
            
            return { 
                primary: color2,    // Base (medio)
                success: color2,    // Cobrado (base)
                warning: color3,    // Pendiente (oscuro intenso)
                info: color1        // A Cobrar (claro suave)
            };
        }

        function refreshChartsWithTheme() {
            // Refrescar gráfico diario si existe
            if (chartDiario && chartDiario.data && chartDiario.data.datasets.length > 0) {
                const colors = getThemeColors();
                chartDiario.data.datasets[0].backgroundColor = [colors.success, colors.warning];
                chartDiario.update();
            }
            
            // Refrescar gráfico semanal si existe
            if (chartSemanal && chartSemanal.data && chartSemanal.data.datasets.length > 0) {
                const colors = getThemeColors();
                chartSemanal.data.datasets[0].backgroundColor = colors.info;
                chartSemanal.data.datasets[1].backgroundColor = colors.success;
                chartSemanal.data.datasets[2].backgroundColor = colors.warning;
                chartSemanal.update();
            }
            // Refrescar Resumen General si existe
            try {
                const data = getFilteredRegistrosResumenGeneral();
                if (document.getElementById('resumen-general')) { renderResumenGeneralCharts(data); }
            } catch {}
        }

        function updateChartDiario(cobrar, cobrado, pendiente) {
            const ctx = document.getElementById('chart-diario');
            if (!ctx) return;
            const colors = getThemeColors();
            const data = {
                labels: ['Cobrado', 'Pendiente'],
                datasets: [{
                    data: [cobrado, pendiente],
                    backgroundColor: [colors.success, colors.warning],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            };
            if (chartDiario) {
                chartDiario.data = data;
                chartDiario.update();
            } else {
                chartDiario = new Chart(ctx, {
                    type: 'pie',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            title: { display: true, text: 'Distribución del día' }
                        }
                    }
                });
            }
        }

        function updateChartSemanal(regs, ini, fin) {
            const ctx = document.getElementById('chart-semanal');
            if (!ctx) return;
            const colors = getThemeColors();
            // Agrupar por fecha
            const dateMap = {};
            const start = new Date(ini); const end = new Date(fin);
            for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
                const key = d.toISOString().substring(0,10);
                dateMap[key] = { cobrar:0, cobrado:0, pend:0 };
            }
            regs.forEach(r => {
                const key = r.fecha || '';
                if (dateMap[key]) {
                    dateMap[key].cobrar += Number(r.totalCobrar||0);
                    dateMap[key].cobrado += Number(r.totalPagado||0);
                    dateMap[key].pend += Number(r.totalCobrar||0)-Number(r.totalPagado||0);
                }
            });
            const labels = Object.keys(dateMap).sort();
            const cobrarData = labels.map(k => dateMap[k].cobrar);
            const cobradoData = labels.map(k => dateMap[k].cobrado);
            const pendData = labels.map(k => dateMap[k].pend);
            const data = {
                labels: labels.map(d => new Date(d+'T00:00:00').toLocaleDateString('es-ES',{month:'short',day:'numeric'})),
                datasets: [
                    { label: 'A Cobrar', data: cobrarData, backgroundColor: colors.info, borderColor: colors.info, borderWidth: 1 },
                    { label: 'Cobrado', data: cobradoData, backgroundColor: colors.success, borderColor: colors.success, borderWidth: 1 },
                    { label: 'Pendiente', data: pendData, backgroundColor: colors.warning, borderColor: colors.warning, borderWidth: 1 }
                ]
            };
            if (chartSemanal) {
                chartSemanal.data = data;
                chartSemanal.update();
            } else {
                chartSemanal = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            title: { display: true, text: 'Evolución semanal' }
                        },
                        scales: {
                            x: { stacked: false },
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }

        function loadReportesView() {
            const tbody = document.getElementById('reportes-tbody');
            const empty = document.getElementById('reportes-empty');
            const totCobrarEl = document.getElementById('reportes-total-cobrar');
            const totCobradoEl = document.getElementById('reportes-total-cobrado');
            const totPendEl = document.getElementById('reportes-total-pendiente');
            if (!tbody || !empty) return;

            const obra = document.getElementById('filter-reportes-obra')?.value || '';
            const { ini: fi, fin: ff } = normalizeRangePair('filter-reportes-fecha-inicio', 'filter-reportes-fecha-fin');
            let totalCobrar=0,totalCobrado=0,totalPendiente=0; tbody.innerHTML='';
            // Modo General: listar cada registro (fecha más reciente arriba)
            if (detalladosResumenMode === 'general') {
                let regs = registros.slice();
                if (obra) regs = regs.filter(r => r.obra === obra);
                if (fi) regs = regs.filter(r => !r.fecha || r.fecha >= fi);
                if (ff) regs = regs.filter(r => !r.fecha || r.fecha <= ff);
                // Ordenar por fecha desc (YYYY-MM-DD lexicográfico funciona)
                regs.sort((a,b)=> (b.fecha||'').localeCompare(a.fecha||''));
                currentReportesFiltered = regs.map(r => {
                    // Cliente y cédula: si múltiples clientes, concatenar nombres / cédulas
                    let clienteStr = '';
                    let cedulaStr = '';
                    if (Array.isArray(r.clientesAdicionales) && r.clientesAdicionales.length) {
                        clienteStr = r.clientesAdicionales.join(', ');
                        cedulaStr = r.clientesAdicionales.map(n => (clientes.find(c=>c.nombre===n)?.cedula || '')).filter(Boolean).join(', ');
                    }
                    return {
                        fecha: r.fecha || '',
                        cliente: clienteStr,
                        cedula: cedulaStr,
                        obra: r.obra || '',
                        totalCantidad: Number(r.totalCantidad||0),
                        totalCobrar: Number(r.totalCobrar||0),
                        totalPagado: Number(r.totalPagado||0),
                        status: (Number(r.totalPagado||0) >= Number(r.totalCobrar||0) && Number(r.totalCobrar||0)>0? 'pagado' : (Number(r.totalPagado||0)>0? 'parcial' : 'pendiente')),
                        id: r.id
                    };
                });
                currentReportesFiltered.forEach(r => {
                    const cobrar = Number(r.totalCobrar||0);
                    const pagado = Number(r.totalPagado||0);
                    const pendiente = cobrar - pagado;
                    totalCobrar += cobrar; totalCobrado += pagado; totalPendiente += pendiente;
                    const statusCfg = {
                        pagado: { cls: 'success', text: 'Pagado' },
                        parcial: { cls: 'warning', text: 'Parcial' },
                        pendiente: { cls: 'danger', text: 'Pendiente' }
                    }[r.status] || { cls:'secondary', text:r.status };
                    tbody.innerHTML += `<tr>
                        <td>${r.fecha}</td>
                        <td>${r.cliente}</td>
                        <td>${r.cedula}</td>
                        <td>${r.obra}</td>
                        <td class='text-end'>${(r.totalCantidad||0).toFixed(2)}</td>
                        <td class='text-end'>${cobrar.toLocaleString('en-US',{style:'currency',currency:'USD'})}</td>
                        <td class='text-end text-success'>${pagado.toLocaleString('en-US',{style:'currency',currency:'USD'})}</td>
                        <td class='text-end ${pendiente>0?'text-warning':''}'>${pendiente.toLocaleString('en-US',{style:'currency',currency:'USD'})}</td>
                        <td><span class='badge bg-${statusCfg.cls}'>${statusCfg.text}</span></td>
                        <td class='text-end'>
                            <button class='btn btn-outline-info btn-sm' title='Ver' onclick='viewRegistroDetalle(${r.id})'>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12c0 0 4.5-7.5 9.75-7.5S21.75 12 21.75 12 17.25 19.5 12 19.5 2.25 12 2.25 12z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 15a3 3 0 100-6 3 3 0 000 6z" /></svg>
                            </button>
                        </td>
                    </tr>`;
                });
            } else if (detalladosResumenMode === 'diario') {
                // Pivot "Por Día": columnas dinámicas por cada fecha del rango (fi..ff) o fechas presentes si rango incompleto.
                pivotIsActive = true;
                let regs = registros.filter(r => r.fecha);
                if (obra) regs = regs.filter(r => r.obra === obra);
                if (fi) regs = regs.filter(r => r.fecha >= fi);
                if (ff) regs = regs.filter(r => r.fecha <= ff);
                // Determinar lista de días
                if (fi && ff) {
                    const start = new Date(fi+'T00:00:00');
                    const end = new Date(ff+'T00:00:00');
                    const days = [];
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) { // ascendente
                        days.push(d.toISOString().substring(0,10));
                    }
                    pivotDayList = days; // ya ascendente
                } else {
                    const unique = new Set(); regs.forEach(r => unique.add(r.fecha));
                    pivotDayList = Array.from(unique).sort((a,b)=> a.localeCompare(b)); // ascendente
                }
                // Guardar encabezado original si aún no
                if (!originalReportesTheadHtml) {
                    const theadOrig = document.querySelector('#reportes-table thead');
                    if (theadOrig) originalReportesTheadHtml = theadOrig.innerHTML;
                }
                // Construir encabezado pivot
                const thead = document.querySelector('#reportes-table thead');
                if (thead) {
                    const diasSemana = ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
                    let headHtml = '<tr><th>Obra</th><th>Clientes</th>';
                    pivotDayList.forEach(d => {
                        const dateObj = new Date(d+'T00:00:00');
                        const label = diasSemana[dateObj.getDay()] + ' ' + d.split('-').reverse().join('-').replace(/^(\d{2})-(\d{2})-(\d{4})$/, (_,dd,mm,yyyy)=> dd+'-'+mm+'-'+yyyy.substring(2));
                        headHtml += `<th class="text-end" data-dia="${d}">${label}</th>`;
                    });
                    headHtml += '<th class="text-end">Total</th></tr>';
                    thead.innerHTML = headHtml;
                }
                // Map obra+cliente -> valores por día (usamos A Cobrar)
                const rowMap = {};
                regs.forEach(r => {
                    const fecha = r.fecha;
                    let clientesR = Array.isArray(r.clientesAdicionales) && r.clientesAdicionales.length ? r.clientesAdicionales.slice() : [];
                    if (clientesR.length === 0) {
                        // Sin clientes explícitos: buscar todos los clientes de esta obra
                        const obraClients = clientes.filter(c => c.obra === r.obra);
                        if (obraClients.length > 0) {
                            clientesR = obraClients.map(c => c.nombre);
                        } else {
                            clientesR = ['Sin Cliente'];
                        }
                    }
                    const dividir = clientesR.length || 1;
                    const cobrarUnit = Number(r.totalCobrar||0)/dividir;
                    clientesR.forEach(nom => {
                        const key = (r.obra||'') + '||' + nom;
                        if (!rowMap[key]) rowMap[key] = { obra: r.obra||'', cliente: nom, porDia:{}, total:0 };
                        rowMap[key].porDia[fecha] = (rowMap[key].porDia[fecha]||0) + cobrarUnit;
                        rowMap[key].total += cobrarUnit;
                    });
                });
                // Ordenar por nombre de Cliente (y como desempate por Obra)
                const rows = Object.values(rowMap).sort((a,b)=> a.cliente.localeCompare(b.cliente) || a.obra.localeCompare(b.obra));
                currentReportesFiltered = rows; // export adapt later
                tbody.innerHTML = '';
                const dayTotals = pivotDayList.map(()=>0);
                rows.forEach(rw => {
                    let html = `<tr><td>${rw.obra}</td><td>${rw.cliente||''}</td>`;
                    pivotDayList.forEach((d,i)=> {
                        const val = rw.porDia[d]||0;
                        dayTotals[i] += val;
                        html += `<td class='text-end'>${val? val.toLocaleString('en-US',{style:'currency',currency:'USD'}) : '-'}</td>`;
                    });
                    html += `<td class='text-end fw-semibold'>${rw.total.toLocaleString('en-US',{style:'currency',currency:'USD'})}</td></tr>`;
                    tbody.innerHTML += html;
                    totalCobrar += rw.total;
                });
                // Fila totals por día
                let totalRow = `<tr class='table-active'><td colspan='2' class='text-end fw-semibold'>Total por Día</td>`;
                dayTotals.forEach(v => { totalRow += `<td class='text-end fw-semibold'>${v.toLocaleString('en-US',{style:'currency',currency:'USD'})}</td>`; totalCobrado += v; });
                totalRow += `<td class='text-end fw-semibold'>${totalCobrar.toLocaleString('en-US',{style:'currency',currency:'USD'})}</td></tr>`;
                tbody.innerHTML += totalRow;
                // Ajustar totales superiores (usamos cobrar/cobrado estimados)
                totalPendiente = totalCobrar - totalCobrado;
            } else if (detalladosResumenMode === 'detallado') {
                // Modo Detallado: una fila por cliente y fecha (si múltiples clientes en un registro, dividir montos por igual)
                let regs = registros.slice();
                if (obra) regs = regs.filter(r => r.obra === obra);
                if (fi) regs = regs.filter(r => !r.fecha || r.fecha >= fi);
                if (ff) regs = regs.filter(r => !r.fecha || r.fecha <= ff);
                // Generar filas
                const rows = [];
                regs.forEach(r => {
                    const fecha = r.fecha || '';
                    const obraR = r.obra || '';
                    let clientesEnRegistro = Array.isArray(r.clientesAdicionales) && r.clientesAdicionales.length ? r.clientesAdicionales.slice() : [];
                    if (clientesEnRegistro.length === 0) {
                        // Sin lista explícita: distribuir entre todos los clientes de la obra (si existen)
                        const obraClients = clientes.filter(c => c.obra === obraR);
                        if (obraClients.length) clientesEnRegistro = obraClients.map(c => c.nombre);
                        else clientesEnRegistro = ['']; // fila sin cliente específico
                    }
                    const divisor = clientesEnRegistro.length || 1;
                    const cobrarUnit = Number(r.totalCobrar||0)/divisor;
                    const cobradoUnit = Number(r.totalPagado||0)/divisor;
                    const cantidadUnit = Number(r.totalCantidad||0)/divisor;
                    clientesEnRegistro.forEach(nombreCliente => {
                        const cObj = clientes.find(c => c.nombre === nombreCliente) || null;
                        rows.push({
                            fecha,
                            cliente: nombreCliente || '',
                            cedula: cObj?.cedula || '',
                            obra: obraR,
                            totalCantidad: cantidadUnit,
                            totalCobrar: cobrarUnit,
                            totalPagado: cobradoUnit,
                            status: (cobradoUnit >= cobrarUnit && cobrarUnit>0? 'pagado' : (cobradoUnit>0? 'parcial':'pendiente')),
                            id: r.id
                        });
                    });
                });
                // Ordenar por fecha desc y luego cliente
                rows.sort((a,b)=> {
                    const fCmp = (b.fecha||'').localeCompare(a.fecha||'');
                    if (fCmp !== 0) return fCmp;
                    return a.cliente.localeCompare(b.cliente);
                });
                currentReportesFiltered = rows;
                currentReportesFiltered.forEach(r => {
                    const cobrar = Number(r.totalCobrar||0);
                    const pagado = Number(r.totalPagado||0);
                    const pendiente = cobrar - pagado;
                    totalCobrar += cobrar; totalCobrado += pagado; totalPendiente += pendiente;
                    const statusCfg = { pagado:{cls:'success',text:'Pagado'}, parcial:{cls:'warning',text:'Parcial'}, pendiente:{cls:'danger',text:'Pendiente'} }[r.status] || { cls:'secondary', text:r.status };
                    tbody.innerHTML += `<tr>
                        <td>${r.fecha}</td>
                        <td>${r.cliente}</td>
                        <td>${r.cedula}</td>
                        <td>${r.obra}</td>
                        <td class='text-end'>${(r.totalCantidad||0).toFixed(2)}</td>
                        <td class='text-end'>${cobrar.toLocaleString('en-US',{style:'currency',currency:'USD'})}</td>
                        <td class='text-end text-success'>${pagado.toLocaleString('en-US',{style:'currency',currency:'USD'})}</td>
                        <td class='text-end ${pendiente>0?'text-warning':''}'>${pendiente.toLocaleString('en-US',{style:'currency',currency:'USD'})}</td>
                        <td><span class='badge bg-${statusCfg.cls}'>${statusCfg.text}</span></td>
                        <td class='text-end'>
                            <button class='btn btn-outline-info btn-sm' title='Ver' onclick='viewRegistroDetalle(${r.id})'>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12c0 0 4.5-7.5 9.75-7.5S21.75 12 21.75 12 17.25 19.5 12 19.5 2.25 12 2.25 12z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 15a3 3 0 100-6 3 3 0 000 6z" /></svg>
                            </button>
                        </td>
                    </tr>`;
                });
            }

            if (totCobrarEl) totCobrarEl.textContent = totalCobrar.toLocaleString('en-US',{style:'currency',currency:'USD'});
            if (totCobradoEl) totCobradoEl.textContent = totalCobrado.toLocaleString('en-US',{style:'currency',currency:'USD'});
            if (totPendEl) totPendEl.textContent = totalPendiente.toLocaleString('en-US',{style:'currency',currency:'USD'});

            if (currentReportesFiltered.length === 0) {
                empty.style.display = '';
            } else {
                empty.style.display = 'none';
            }

            // Restaurar encabezado si salimos del modo diario (pivot)
            if (detalladosResumenMode !== 'diario' && pivotIsActive) {
                const thead = document.querySelector('#reportes-table thead');
                if (thead && originalReportesTheadHtml) thead.innerHTML = originalReportesTheadHtml;
                pivotIsActive = false;
            }
        }

        // Helper para encontrar un registro (primer id) por cliente y obra para botón Ver
        function findFirstRegistroId(clienteNombre, obraNombre) {
            const reg = registros.find(r => {
                if (obraNombre && r.obra === obraNombre && Array.isArray(r.clientesAdicionales) && r.clientesAdicionales.includes(clienteNombre)) return true;
                if (obraNombre && r.obra === obraNombre && !r.clientesAdicionales) return true; // fallback
                if (!obraNombre && Array.isArray(r.clientesAdicionales) && r.clientesAdicionales.includes(clienteNombre)) return true;
                return false;
            });
            return reg ? reg.id : null;
        }

        // Exportar CSV
        // Exportar Excel usando SheetJS
        function exportReportesExcel() {
            if (!currentReportesFiltered || currentReportesFiltered.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }
            const wb = XLSX.utils.book_new();
            // Modo Por Día (pivot)
            if (detalladosResumenMode === 'diario' && pivotDayList && pivotDayList.length) {
                const diasSemana = ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
                const headers = ['Obra', 'Clientes', ...pivotDayList.map(d => {
                    const dateObj = new Date(d+'T00:00:00');
                    const label = diasSemana[dateObj.getDay()] + ' ' + d.split('-').reverse().join('-').replace(/^(\d{2})-(\d{2})-(\d{4})$/, (_,dd,mm,yyyy)=> dd+'-'+mm+'-'+yyyy.substring(2));
                    return label;
                }), 'Total'];
                const ws_data = [headers];
                const dayTotals = Array(pivotDayList.length).fill(0);
                let grandTotal = 0;
                (pivotRows && pivotRows.length ? pivotRows : currentReportesFiltered).forEach(rw => {
                    const row = [rw.obra || '', rw.cliente || ''];
                    let rowTotal = 0;
                    pivotDayList.forEach((d,i) => {
                        const v = Number((rw.porDia && rw.porDia[d]) || 0);
                        row.push(v);
                        dayTotals[i] += v;
                        rowTotal += v;
                    });
                    row.push(rowTotal);
                    grandTotal += rowTotal;
                    ws_data.push(row);
                });
                // Totals row
                ws_data.push(['', 'Total por Día', ...dayTotals, grandTotal]);
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                // Column widths: first two wider, days moderate, total moderate
                const cols = [{wch:22},{wch:22}, ...pivotDayList.map(()=>({wch:14})), {wch:16}];
                ws['!cols'] = cols;
                // Apply currency format to day and total columns (from index 2 to end)
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = 1; R <= range.e.r; ++R) {
                    for (let C = 2; C <= range.e.c; ++C) {
                        const addr = XLSX.utils.encode_cell({ r:R, c:C });
                        if (ws[addr] && typeof ws[addr].v === 'number') ws[addr].z = '$#,##0.00';
                    }
                }
                XLSX.utils.book_append_sheet(wb, ws, 'Reportes Por Día');
                XLSX.writeFile(wb, `reportes_por_dia_${new Date().toISOString().split('T')[0]}.xlsx`);
                return;
            }

            // Modos General / Detallado (tabla fija)
            const headers = ['Fecha', 'Cliente', 'Cédula', 'Obra', 'Cantidad', 'A Cobrar', 'Cobrado', 'Pendiente', 'Estado'];
            let sumCobrar=0,sumCobrado=0,sumPendiente=0;
            const data = currentReportesFiltered.map(r => {
                const cobrar = Number(r.totalCobrar || 0);
                const pagado = Number(r.totalPagado || 0);
                const pendiente = cobrar - pagado;
                sumCobrar += cobrar; sumCobrado += pagado; sumPendiente += pendiente;
                const estado = (r.status || (pagado >= cobrar && cobrar>0? 'pagado' : (pagado>0? 'parcial' : 'pendiente')));
                return [
                    r.fecha || '',
                    r.cliente || '',
                    r.cedula || '',
                    r.obra || '',
                    Number(r.totalCantidad||0),
                    cobrar,
                    pagado,
                    pendiente,
                    estado
                ];
            });
            const ws_data = [headers, ...data];
            // Agregar fila de totales (antes de estilos para incluir formato)
            ws_data.push(['', '', '', 'TOTALES:', '', sumCobrar, sumCobrado, sumPendiente, '']);
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            // Ajustar anchos de columnas
            ws['!cols'] = [
                { wch: 16 },
                { wch: 22 },
                { wch: 16 },
                { wch: 22 },
                { wch: 12 },
                { wch: 16 },
                { wch: 16 },
                { wch: 16 },
                { wch: 12 }
            ];
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r + 1; R <= range.e.r; ++R) { // saltar encabezado
                for (let C = 5; C <= 7; ++C) {
                    const addr = XLSX.utils.encode_cell({ r:R, c:C });
                    if (ws[addr] && typeof ws[addr].v === 'number') ws[addr].z = '$#,##0.00';
                }
            }
            XLSX.utils.book_append_sheet(wb, ws, 'Reportes Detallados');
            XLSX.writeFile(wb, `reportes_detallados_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Exportar PDF (simple usando ventana y print)
        function exportReportesPDF() {
            if (!currentReportesFiltered || currentReportesFiltered.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }
            const win = window.open('', '_blank');
            const css = `<style>body{font-family:Arial,sans-serif;font-size:12px;margin:16px;} .pdf-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px} .pdf-logo{max-height:48px;max-width:160px} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #ccc;padding:4px;} th{background:#f5f5f5;} .text-end{text-align:right;} .text-start{text-align:left;} .badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:10px;color:#fff;} .bg-success{background:#198754;} .bg-warning{background:#ffc107;color:#000;} .bg-danger{background:#dc3545;} .bg-secondary{background:#6c757d;}</style>`;
            const prefs = (typeof getPrefs === 'function') ? getPrefs() : {};
            const logoHtml = prefs && prefs.businessLogo ? `<img class="pdf-logo" src="${prefs.businessLogo}" />` : '';
            if (detalladosResumenMode === 'diario' && pivotDayList && pivotDayList.length) {
                // Pivot PDF
                const diasSemana = ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
                let headHtml = '<tr><th>Obra</th><th>Clientes</th>';
                pivotDayList.forEach(d => {
                    const dateObj = new Date(d+'T00:00:00');
                    const label = diasSemana[dateObj.getDay()] + ' ' + d.split('-').reverse().join('-').replace(/^(\d{2})-(\d{2})-(\d{4})$/, (_,dd,mm,yyyy)=> dd+'-'+mm+'-'+yyyy.substring(2));
                    headHtml += `<th class='text-end'>${label}</th>`;
                });
                headHtml += `<th class='text-end'>Total</th></tr>`;
                let body = `<table><thead>${headHtml}</thead><tbody>`;
                const rows = (pivotRows && pivotRows.length) ? pivotRows : currentReportesFiltered;
                const dayTotals = Array(pivotDayList.length).fill(0);
                let grandTotal = 0;
                rows.forEach(rw => {
                    body += `<tr><td class='text-start'>${rw.obra||''}</td><td class='text-start'>${rw.cliente||''}</td>`;
                    let rowTotal = 0;
                    pivotDayList.forEach((d,i)=>{
                        const v = Number((rw.porDia && rw.porDia[d]) || 0);
                        dayTotals[i] += v; rowTotal += v;
                        body += `<td class='text-end'>${v? v.toLocaleString('en-US',{style:'currency',currency:'USD'}) : '-'}</td>`;
                    });
                    grandTotal += rowTotal;
                    body += `<td class='text-end'><strong>${rowTotal.toLocaleString('en-US',{style:'currency',currency:'USD'})}</strong></td></tr>`;
                });
                // Totals row
                body += `<tr class='table-active'><td colspan='2' class='text-end'><strong>Total por Día</strong></td>`;
                dayTotals.forEach(v => body += `<td class='text-end'><strong>${v.toLocaleString('en-US',{style:'currency',currency:'USD'})}</strong></td>`);
                body += `<td class='text-end'><strong>${grandTotal.toLocaleString('en-US',{style:'currency',currency:'USD'})}</strong></td></tr>`;
                body += '</tbody></table>';
                const header = `<div class='pdf-header'><h3 style='margin:0'>Reporte Por Día</h3>${logoHtml}</div>`;
                win.document.write(`<!DOCTYPE html><html><head><title>Reporte Por Día</title>${css}</head><body>${header}${body}</body></html>`);
                win.document.close();
                setTimeout(()=>{ try { win.focus(); win.print(); } catch {} }, 250);
                return;
            }

            // General / Detallado PDF
            let html = `<!DOCTYPE html><html><head><title>Reporte</title>${css}</head><body><div class='pdf-header'><h3 style='margin:0'>Reporte Detallado</h3>${logoHtml}</div>`;
            let body = '<table><thead><tr><th>Fecha</th><th>Cliente</th><th>Cédula</th><th>Obra</th><th>Cantidad</th><th>A Cobrar</th><th>Cobrado</th><th>Pendiente</th><th>Estado</th></tr></thead><tbody>';
            currentReportesFiltered.forEach(r => {
                const cobrar = Number(r.totalCobrar||0);
                const pagado = Number(r.totalPagado||0);
                const pendiente = cobrar - pagado;
                const estado = (r.status || (pagado >= cobrar && cobrar>0? 'pagado' : (pagado>0? 'parcial' : 'pendiente')));
                const estadoCls = estado==='pagado'?'success':(estado==='parcial'?'warning':(estado==='pendiente'?'danger':'secondary'));
                body += `<tr>
                    <td class='text-start'>${r.fecha||''}</td>
                    <td class='text-start'>${r.cliente||''}</td>
                    <td class='text-start'>${r.cedula||''}</td>
                    <td class='text-start'>${r.obra||''}</td>
                    <td class='text-end'>${(r.totalCantidad||0).toFixed(2)}</td>
                    <td class='text-end'>${cobrar.toLocaleString('en-US',{style:'currency',currency:'USD'})}</td>
                    <td class='text-end'>${pagado.toLocaleString('en-US',{style:'currency',currency:'USD'})}</td>
                    <td class='text-end'>${pendiente.toLocaleString('en-US',{style:'currency',currency:'USD'})}</td>
                    <td class='text-start'><span class='badge bg-${estadoCls}'>${estado}</span></td>
                </tr>`;
            });
            body += '</tbody></table>';
            const totalsHtml = `<p><strong>Total A Cobrar:</strong> ${document.getElementById('reportes-total-cobrar').textContent} | <strong>Total Cobrado:</strong> ${document.getElementById('reportes-total-cobrado').textContent} | <strong>Total Pendiente:</strong> ${document.getElementById('reportes-total-pendiente').textContent}</p>`;
            win.document.write(html + totalsHtml + body + '</body></html>');
            win.document.close();
            setTimeout(()=>{ try { win.focus(); win.print(); } catch {} }, 250);
        }

        // ===== Registros - Añadir Registro =====
        function showRegistroAddAlert(msg, type='info') {
            const box = document.getElementById('registro-add-alert');
            if (!box) return;
            box.textContent = msg;
            box.className = `alert alert-${type}`;
            box.classList.remove('d-none');
            setTimeout(()=>{ try { box.classList.add('d-none'); } catch {} }, 4000);
        }

        function initRegistroAdd() {
            const today = new Date().toISOString().split('T')[0];
            const fechaInput = document.getElementById('registro-fecha');
            if (fechaInput && !fechaInput.value) fechaInput.value = today;

            const obraSel = document.getElementById('registro-obra');
            if (obraSel && !obraSel._bound) {
                obraSel.addEventListener('change', () => {
                    const val = obraSel.value;
                    if (val === '__ADICIONAL__') {
                        // Render modo adicional y permitir edición del nombre del cliente
                        renderRegistroAdicionalInline();
                    } else if (val) {
                        renderRegistroTableInline(val);
                    } else {
                        document.getElementById('registro-add-container').innerHTML = '<div class="text-muted">Seleccione una obra o elija la opción "+ Registro Adicional".</div>';
                        const totalesBox = document.getElementById('registro-totales');
                        if (totalesBox) totalesBox.style.display = 'none';
                    }
                });
                obraSel._bound = true;
            }

            // Si estamos editando un registro existente
            if (currentEditRegistroId) {
                const reg = registros.find(r => r.id === currentEditRegistroId);
                if (reg) {
                    if (fechaInput) fechaInput.value = reg.fecha || today;
                    if (reg.tipo === 'adicional') {
                        if (obraSel) obraSel.value = '__ADICIONAL__';
                        renderRegistroAdicionalInline(reg.items?.[0]?.clienteNombre || 'Adicionales');
                    } else {
                        if (obraSel) obraSel.value = reg.obra || '';
                        if (reg.obra) renderRegistroTableInline(reg.obra);
                    }
                    setTimeout(() => {
                        (reg.items || []).forEach(item => {
                            (item.productos || []).forEach(prod => {
                                const chk = document.getElementById(`rp-${item.clienteId}-${prod.productoId}`);
                                const qty = document.getElementById(`rq-${item.clienteId}-${prod.productoId}`);
                                if (chk) chk.checked = true;
                                if (qty) { qty.disabled = false; qty.value = String(prod.cantidad || 0); }
                            });
                            const paidChk = document.querySelector(`[data-paid-for="${item.clienteId}"]`);
                            if (paidChk) paidChk.checked = !!item.pagado;
                        });
                        recalcRegistroTotals();
                    }, 120);
                }
            }
        }

        function renderRegistroTableInline(obraNombre) {
            const container = document.getElementById('registro-add-container');
            const totalesBox = document.getElementById('registro-totales');
            if (!container) return;
            if (!productos || productos.length === 0) {
                container.innerHTML = `<div class='alert alert-warning'>No hay productos configurados. Ve a la sección Productos para agregarlos.</div>`;
                if (totalesBox) totalesBox.style.display = 'none';
                return;
            }
            const lista = (clientes||[]).filter(c => c.obra === obraNombre);
            if (!lista.length) {
                container.innerHTML = '<div class="text-muted">No hay clientes registrados en esta obra.</div>';
                if (totalesBox) totalesBox.style.display = 'none';
                return;
            }
            let thead = `<thead class='table-light'><tr><th>Cliente</th>`;
            productos.forEach(p=>{ thead += `<th class='text-center'>${p.nombre}<br><small class='text-muted'>${Number(p.precio).toLocaleString('en-US',{style:'currency',currency:'USD'})}</small></th>`; });
            thead += `<th class='text-end'>Total</th><th class='text-center'>Pagado</th></tr></thead>`;
            let tbody = '<tbody>';
            lista.forEach(c => {
                tbody += `<tr data-cliente-id='${c.id}' data-cliente-nombre='${c.nombre}'><td>${c.nombre}</td>`;
                productos.forEach(p => {
                    const cid = c.id, pid = p.id;
                    tbody += `<td class='text-center'><div class='d-inline-flex align-items-center gap-2'>
                        <input type='checkbox' id='rp-${cid}-${pid}' data-cliente-id='${cid}' data-producto-id='${pid}' onchange='onRegistroCheckboxChange(this)'>
                        <input type='number' id='rq-${cid}-${pid}' class='form-control form-control-sm' style='width:80px' min='0' step='1' value='0' disabled data-cliente-id='${cid}' data-producto-id='${pid}' onchange='onRegistroQtyChange(this)'>
                    </div></td>`;
                });
                tbody += `<td class='text-end fw-semibold' data-total-for='${c.id}'>$0.00</td>`;
                tbody += `<td class='text-center'><input type='checkbox' class='form-check-input' data-paid-for='${c.id}' onchange='onRegistroPaidChange(this)'></td></tr>`;
            });
            tbody += '</tbody>';
            container.innerHTML = `<div class='table-responsive'><table class='table table-sm align-middle'>${thead}${tbody}</table></div>`;
            if (totalesBox) totalesBox.style.display = '';
            recalcRegistroTotals();
        }

        function renderRegistroAdicionalInline(nombreEditable='Adicionales') {
            const container = document.getElementById('registro-add-container');
            const totalesBox = document.getElementById('registro-totales');
            if (!container) return;
            if (!productos || productos.length === 0) {
                container.innerHTML = `<div class='alert alert-warning'>No hay productos configurados. Ve a la sección Productos para agregarlos.</div>`;
                if (totalesBox) totalesBox.style.display = 'none';
                return;
            }
            const cid = 'adicional';
            let thead = `<thead class='table-light'><tr><th style='min-width:220px'>Cliente (editable)</th>`;
            productos.forEach(p=>{ thead += `<th class='text-center'>${p.nombre}<br><small class='text-muted'>${Number(p.precio).toLocaleString('en-US',{style:'currency',currency:'USD'})}</small></th>`; });
            thead += `<th class='text-end'>Total</th><th class='text-center'>Pagado</th></tr></thead>`;
            let tbody = '<tbody>';
            tbody += `<tr data-cliente-id='${cid}' data-cliente-nombre='${nombreEditable}'><td>
                <input type='text' id='adicional-nombre-edit' class='form-control form-control-sm' value='${nombreEditable}' oninput="updateAdicionalNombre(this.value)">
            </td>`;
            productos.forEach(p => {
                const pid = p.id;
                tbody += `<td class='text-center'><div class='d-inline-flex align-items-center gap-2'>
                    <input type='checkbox' id='rp-${cid}-${pid}' data-cliente-id='${cid}' data-producto-id='${pid}' onchange='onRegistroCheckboxChange(this)'>
                    <input type='number' id='rq-${cid}-${pid}' class='form-control form-control-sm' style='width:80px' min='0' step='1' value='0' disabled data-cliente-id='${cid}' data-producto-id='${pid}' onchange='onRegistroQtyChange(this)'>
                </div></td>`;
            });
            tbody += `<td class='text-end fw-semibold' data-total-for='${cid}'>$0.00</td>`;
            tbody += `<td class='text-center'><input type='checkbox' class='form-check-input' data-paid-for='${cid}' onchange='onRegistroPaidChange(this)'></td></tr>`;
            tbody += '</tbody>';
            container.innerHTML = `<div class='table-responsive'><table class='table table-sm align-middle'>${thead}${tbody}</table></div>`;
            if (totalesBox) totalesBox.style.display = '';
            recalcRegistroTotals();
        }

        function updateAdicionalNombre(val) {
            const row = document.querySelector('#registro-add-container tr[data-cliente-id="adicional"]');
            if (row) row.setAttribute('data-cliente-nombre', val.trim()||'Adicionales');
        }

        function renderRegistroTable() {
            const container = document.getElementById('registro-add-container');
            const totalesBox = document.getElementById('registro-totales');
            if (!container) return;
            const obraVal = document.getElementById('registro-obra')?.value || '';
            if (!productos || productos.length === 0) {
                container.innerHTML = `<div class="alert alert-warning">No hay productos configurados. Ve a la sección Productos para agregarlos.</div>`;
                if (totalesBox) totalesBox.style.display = 'none';
                return;
            }
            if (!obraVal) {
                container.innerHTML = '<div class="text-muted">Seleccione una obra o elija la opción "+ Registro Adicional" del listado.</div>';
                if (totalesBox) totalesBox.style.display = 'none';
                return;
            }
            if (obraVal === '__ADICIONAL__') {
                renderRegistroAdicionalInline('Adicionales');
            } else {
                renderRegistroTableInline(obraVal);
            }
        }

        function onRegistroCheckboxChange(el) {
            const cid = el.getAttribute('data-cliente-id');
            const pid = el.getAttribute('data-producto-id');
            const qty = document.getElementById(`rq-${cid}-${pid}`);
            if (!qty) return;
            if (el.checked) {
                qty.disabled = false;
                if (!qty.value || Number(qty.value) <= 0) qty.value = 1;
            } else {
                qty.value = 0;
                qty.disabled = true;
            }
            recalcRegistroTotals();
        }
        function onRegistroQtyChange(el) {
            const cid = el.getAttribute('data-cliente-id');
            const pid = el.getAttribute('data-producto-id');
            const chk = document.getElementById(`rp-${cid}-${pid}`);
            let val = parseInt(el.value || '0', 10);
            if (isNaN(val) || val < 0) val = 0;
            el.value = String(val);
            if (val > 0) {
                if (chk && !chk.checked) chk.checked = true;
                el.disabled = false;
            } else {
                if (chk && chk.checked) chk.checked = false;
                el.disabled = true;
            }
            recalcRegistroTotals();
        }

        function recalcRegistroTotals() {
            let totalCantidad = 0;
            let totalCobrar = 0;
            let totalPagado = 0;
            
            // Solo buscar en el contenedor principal (ahora unificado)
            const allRows = document.querySelectorAll('#registro-add-container tr[data-cliente-id]');
            
            allRows.forEach(tr => {
                const cid = tr.getAttribute('data-cliente-id');
                let totalCliente = 0;
                (productos || []).forEach(p => {
                    const chk = document.getElementById(`rp-${cid}-${p.id}`);
                    const qtyEl = document.getElementById(`rq-${cid}-${p.id}`);
                    if (chk && qtyEl && chk.checked) {
                        const qty = Math.max(0, parseInt(qtyEl.value || '0', 10));
                        totalCantidad += qty;
                        totalCliente += qty * Number(p.precio || 0);
                    }
                });
                const cell = tr.querySelector(`[data-total-for="${cid}"]`);
                if (cell) cell.textContent = totalCliente.toLocaleString('en-US',{style:'currency',currency:'USD'});
                const paidChk = tr.querySelector(`[data-paid-for="${cid}"]`);
                if (paidChk && paidChk.checked) totalPagado += totalCliente;
                totalCobrar += totalCliente;
            });
            
            const totalCantEl = document.getElementById('registro-total-cantidad');
            const totalCobEl = document.getElementById('registro-total-cobrar');
            const totalPagEl = document.getElementById('registro-total-pagado');
            if (totalCantEl) totalCantEl.textContent = String(totalCantidad);
            if (totalCobEl) totalCobEl.textContent = totalCobrar.toLocaleString('en-US',{style:'currency',currency:'USD'});
            if (totalPagEl) totalPagEl.textContent = totalPagado.toLocaleString('en-US',{style:'currency',currency:'USD'});
        }

        function onRegistroPaidChange(_el) { recalcRegistroTotals(); }

        // Render tabla para cliente adicional
        function renderRegistroAdicionalTable() {
            const container = document.getElementById('registro-adicional-container');
            const totalesBox = document.getElementById('registro-totales');
            if (!container) return;
            
            const nombreCliente = document.getElementById('registro-cliente-adicional-nombre')?.value.trim() || 'Cliente Adicional';
            
            if (!productos || productos.length === 0) {
                container.innerHTML = `<div class="alert alert-warning">No hay productos configurados. Ve a la sección Productos para agregarlos.</div>`;
                if (totalesBox) totalesBox.style.display = 'none';
                return;
            }

            // Construir tabla dinámica para un solo cliente (adicional)
            const cid = 'adicional'; // ID único para cliente adicional
            let thead = `<thead class="table-light"><tr><th>Cliente</th>`;
            productos.forEach(p => {
                thead += `<th class="text-center">${p.nombre}<br><small class="text-muted">${Number(p.precio).toLocaleString('en-US',{style:'currency',currency:'USD'})}</small></th>`;
            });
            thead += `<th class="text-end">Total</th><th class="text-center">Pagado</th></tr></thead>`;

            let tbody = '<tbody>';
            tbody += `<tr data-cliente-id="${cid}" data-cliente-nombre="${nombreCliente}"><td>${nombreCliente}</td>`;
            productos.forEach(p => {
                const pid = p.id;
                const chkId = `rp-${cid}-${pid}`;
                const qtyId = `rq-${cid}-${pid}`;
                tbody += `<td class="text-center">
                    <div class="d-inline-flex align-items-center gap-2">
                        <input type="checkbox" id="${chkId}" data-cliente-id="${cid}" data-producto-id="${pid}" onchange="onRegistroCheckboxChange(this)">
                        <input type="number" id="${qtyId}" class="form-control form-control-sm" style="width:80px" min="0" step="1" value="0" disabled data-cliente-id="${cid}" data-producto-id="${pid}" onchange="onRegistroQtyChange(this)">
                    </div>
                </td>`;
            });
            tbody += `<td class="text-end fw-semibold" data-total-for="${cid}">$0.00</td>`;
            tbody += `<td class="text-center"><input type="checkbox" class="form-check-input" data-paid-for="${cid}" onchange="onRegistroPaidChange(this)"></td></tr>`;
            tbody += '</tbody>';

            container.innerHTML = `<div class="table-responsive"><table class="table table-sm align-middle">${thead}${tbody}</table></div>`;
            if (totalesBox) totalesBox.style.display = '';
            recalcRegistroTotals();
        }

        async function saveRegistro() {
            // Detectar modo basado en el select de obra (incluye opción especial __ADICIONAL__)
            const fecha = document.getElementById('registro-fecha')?.value || '';
            const obraVal = document.getElementById('registro-obra')?.value || '';
            let obra, tipo, isObraMode;
            if (!obraVal) {
                showRegistroAddAlert('Selecciona una Obra o la opción "+ Registro Adicional".', 'warning');
                return;
            }
            if (obraVal === '__ADICIONAL__') {
                obra = 'Adicionales';
                tipo = 'adicional';
                isObraMode = false;
            } else {
                obra = obraVal;
                tipo = 'obra';
                isObraMode = true;
            }

            const rows = Array.from(document.querySelectorAll('#registro-add-container tr[data-cliente-id]'));
            const items = [];
            let totalCantidad = 0;
            let totalCobrar = 0;
            let totalPagado = 0;
            
            rows.forEach(tr => {
                const cid = tr.getAttribute('data-cliente-id');
                let clienteNombre;
                
                if (isObraMode) {
                    const cliente = (clientes || []).find(c => c.id === Number(cid));
                    if (!cliente) return;
                    clienteNombre = cliente.nombre;
                } else {
                    // Cliente adicional
                    clienteNombre = tr.getAttribute('data-cliente-nombre') || 'Cliente Adicional';
                }
                
                const prods = [];
                (productos || []).forEach(p => {
                    const chk = document.getElementById(`rp-${cid}-${p.id}`);
                    const qtyEl = document.getElementById(`rq-${cid}-${p.id}`);
                    if (!qtyEl) return;
                    const rawQty = parseInt(qtyEl.value || '0', 10);
                    const qty = isNaN(rawQty) ? 0 : rawQty;
                    if (qty > 0) {
                        // Asegurar coherencia: marcar checkbox si cantidad > 0
                        if (chk && !chk.checked) chk.checked = true;
                        prods.push({ productoId: p.id, nombre: p.nombre, cantidad: qty, precio: Number(p.precio || 0) });
                        totalCantidad += qty;
                        totalCobrar += qty * Number(p.precio || 0);
                    }
                });
                
                if (prods.length > 0) {
                    const paid = !!tr.querySelector(`[data-paid-for="${cid}"]`)?.checked;
                    const totalCliente = prods.reduce((acc, it) => acc + it.cantidad * it.precio, 0);
                    if (paid) totalPagado += totalCliente;
                    items.push({ clienteId: cid, clienteNombre, productos: prods, pagado: paid });
                }
            });
            
            if (totalCantidad === 0) { showRegistroAddAlert('No has seleccionado cantidades. Marca al menos un producto.', 'warning'); return; }
            
            const status = totalPagado >= totalCobrar && totalCobrar > 0 ? 'pagado' : (totalPagado > 0 ? 'parcial' : 'pendiente');
            const rec = {
                id: currentEditRegistroId || Date.now(),
                fecha,
                obra,
                tipo,
                items,
                totalCantidad,
                totalCobrar,
                totalPagado,
                status,
                titulo: `Registro ${obra}${fecha ? ' - ' + fecha : ''}`,
                resumen: `${totalCantidad} uds • A cobrar: ${totalCobrar.toLocaleString('en-US',{style:'currency',currency:'USD'})} • Pagado: ${totalPagado.toLocaleString('en-US',{style:'currency',currency:'USD'})}`
            };
            
            // Guardar en backend
            try {
                if (currentEditRegistroId) {
                    // Actualizar registro existente
                    await API.updateRegistro(currentEditRegistroId, rec);
                } else {
                    // Crear nuevo registro
                    const result = await API.createRegistro(rec);
                    rec.id = result.id; // Usar el ID del backend
                }
                
                // Actualizar array local
                const idx = registros.findIndex(r => r.id === rec.id);
                if (idx >= 0) registros[idx] = rec; else registros.push(rec);
            } catch (error) {
                console.error('Error al guardar registro:', error);
                showRegistroAddAlert('Error al guardar el registro en el servidor: ' + error.message, 'danger');
                return;
            }
            showRegistroAddAlert('Registro guardado correctamente.', 'success');
            // Navegar a resumen
            setTimeout(() => {
                currentEditRegistroId = null;
                changeSection('registros-resumen');
                loadRegistrosResumen();
            }, 400);
        }

        // ===== Productos =====
        function showProductosAdminAlert(msg, type='info') {
            const box = document.getElementById('productos-admin-alert');
            if (!box) return;
            box.textContent = msg;
            box.className = `alert alert-${type}`;
            box.classList.remove('d-none');
        }

        // Editar un registro desde el resumen
        function editRegistro(id) {
            currentEditRegistroId = id;
            
            // Cambiar título
            const title = document.getElementById('registro-add-title');
            if (title) title.textContent = 'Editar Registro';
            
            // Asegurar modo edición (sin readonly)
            setTimeout(() => setReadonlyMode(false), 200);
            
            changeSection('registros-add');
        }

        // Eliminar un registro
        async function deleteRegistro(id) {
            if (!confirm('¿Eliminar este registro? Esta acción no se puede deshacer.')) return;
            
            try {
                // Eliminar del backend
                await API.deleteRegistro(id);
                
                // Actualizar array local
                registros = registros.filter(r => r.id !== id);
                loadRegistrosResumen();
            } catch (error) {
                console.error('Error al eliminar registro:', error);
                alert('Error al eliminar el registro del servidor: ' + error.message);
            }
        }

        // Ver detalle de un registro en modo readonly
        function viewRegistroDetalle(id) {
            try { console.log('Ver detalle de registro', id); } catch {}
            
            // Buscar el registro
            const registro = registros.find(r => r.id === id);
            if (!registro) {
                alert('Registro no encontrado');
                return;
            }
            
            // Guardar ID para modo edición
            currentEditRegistroId = id;
            
            // Cambiar título
            const title = document.getElementById('registro-add-title');
            if (title) title.textContent = 'Ver Registro';
            
            // Cambiar a la sección
            changeSection('registros-add');
            
            // Cargar los datos del registro
            setTimeout(() => {
                // Establecer fecha y obra
                const fechaInput = document.getElementById('registro-fecha');
                const obraSelect = document.getElementById('registro-obra');
                
                if (fechaInput) fechaInput.value = registro.fecha || '';
                if (obraSelect) {
                    if (registro.tipo === 'adicional') {
                        obraSelect.value = '__ADICIONAL__';
                    } else {
                        obraSelect.value = registro.obra || '';
                    }
                    // Trigger change para cargar la tabla
                    obraSelect.dispatchEvent(new Event('change'));
                }
                
                // Esperar a que se cargue la tabla y luego llenar los datos
                setTimeout(() => {
                    // Mostrar aviso si el registro no tiene items (histórico agregado sin desglose)
                    if (!registro.items || registro.items.length === 0) {
                        showRegistroAddAlert('Este registro histórico no contiene el desglose por cliente/producto. Puedes ver los totales, pero la edición detallada no está disponible.', 'info');
                        // Aún recalcular totales para mostrar correctamente
                        recalcRegistroTotals();
                        setReadonlyMode(true);
                        return;
                    }
                    registro.items.forEach(item => {
                        item.productos.forEach(prod => {
                            const qtyInput = document.getElementById(`rq-${item.clienteId}-${prod.productoId}`);
                            const checkbox = document.getElementById(`rp-${item.clienteId}-${prod.productoId}`);
                            
                            if (qtyInput) {
                                qtyInput.value = prod.cantidad;
                                if (checkbox) checkbox.checked = true;
                            }
                        });
                        
                        // Marcar como pagado si corresponde
                        const paidCheckbox = document.querySelector(`[data-paid-for="${item.clienteId}"]`);
                        if (paidCheckbox) paidCheckbox.checked = item.pagado || false;
                    });
                    
                    // Recalcular totales
                    recalcRegistroTotals();
                    
                    // Activar modo readonly
                    setReadonlyMode(true);
                }, 300);
            }, 100);
        }

        // Activar/desactivar modo readonly en el formulario de registro
        function setReadonlyMode(readonly) {
            // Fecha y Obra
            const fechaInput = document.getElementById('registro-fecha');
            const obraSelect = document.getElementById('registro-obra');
            
            if (fechaInput) fechaInput.disabled = readonly;
            if (obraSelect) obraSelect.disabled = readonly;
            
            // Todos los inputs de cantidad
            document.querySelectorAll('#registro-add-container input[type="number"]').forEach(input => {
                input.disabled = readonly;
            });
            
            // Todos los checkboxes (productos y pagado)
            document.querySelectorAll('#registro-add-container input[type="checkbox"]').forEach(checkbox => {
                checkbox.disabled = readonly;
            });
            
            // Botones
            const btnEditar = document.getElementById('btn-editar-registro');
            const btnGuardar = document.getElementById('btn-guardar-registro');
            
            if (readonly) {
                if (btnEditar) btnEditar.style.display = '';
                if (btnGuardar) btnGuardar.style.display = 'none';
            } else {
                if (btnEditar) btnEditar.style.display = 'none';
                if (btnGuardar) btnGuardar.style.display = '';
            }
        }

        // Habilitar modo de edición
        function enableEditMode() {
            const title = document.getElementById('registro-add-title');
            if (title) title.textContent = 'Editar Registro';
            
            setReadonlyMode(false);
        }

        function toggleRegistroBody(id) { /* legacy if needed later */ }

        // Tabla de productos (versión extendida con estado y acciones)
        function loadProductosTable() {
            const tbody = document.getElementById('productos-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!productos || productos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">Sin productos. Usa "Agregar tus Productos" para comenzar.</td></tr>`;
                return;
            }
            productos.forEach(p => {
                if (!p.estado) p.estado = 'activo';
                const tr = document.createElement('tr');
                const precioFmt = Number(p.precio).toLocaleString('en-US',{style:'currency',currency:'USD'});
                tr.innerHTML = `
                    <td>${p.codigo}</td>
                    <td>${p.nombre}</td>
                    <td class="text-end">${precioFmt}</td>
                    <td class="text-center">
                        <select class="form-select form-select-sm estado-select ${p.estado==='activo' ? 'estado-activo' : 'estado-inactivo'}" onchange="onProductoEstadoChange(${p.id}, this.value, this)">
                            <option value="activo" ${p.estado==='activo' ? 'selected' : ''}>Activo</option>
                            <option value="inactivo" ${p.estado==='inactivo' ? 'selected' : ''}>Inactivo</option>
                        </select>
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-secondary" onclick="editProducto(${p.id})" title="Modificar">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z" /></svg>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteProducto(${p.id})" title="Eliminar">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                            </button>
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        function saveProductoFromAdmin() {
            const nombre = document.getElementById('producto-nombre').value.trim();
            const codigo = document.getElementById('producto-codigo').value.trim();
            const precio = document.getElementById('producto-precio').value;
            const descripcion = document.getElementById('producto-descripcion').value.trim();
            const estado = document.getElementById('producto-estado').value;
            if (!nombre || !codigo || !precio) {
                showProductosAdminAlert('Por favor completa Nombre, Código y Precio de Venta.','warning');
                return;
            }
            if (window.currentEditProductoId) {
                const idx = productos.findIndex(pr => pr.id === window.currentEditProductoId);
                if (idx >= 0) {
                    productos[idx] = { ...productos[idx], nombre, codigo, precio: parseFloat(precio), descripcion, estado };
                }
                window.currentEditProductoId = null;
                document.getElementById('btn-save-producto').textContent = 'Guardar Producto';
                showProductosAdminAlert('Producto actualizado correctamente.','success');
            } else {
                const prod = { id: Date.now(), nombre, codigo, precio: parseFloat(precio), descripcion, estado };
                productos.push(prod);
                showProductosAdminAlert('Producto guardado correctamente.','success');
            }
            localStorage.setItem('productos', JSON.stringify(productos));
            (document.getElementById('form-producto')||{}).reset?.();
            document.getElementById('producto-estado').value = 'activo';
            loadProductosTable();
            try { if (window.bootstrap && bootstrap.Tab) new bootstrap.Tab(document.getElementById('productos-tab-lista')).show(); } catch {}
        }

        function editProducto(id) {
            const prod = productos.find(p => p.id === id);
            if (!prod) return;
            window.currentEditProductoId = id;
            try { if (window.bootstrap && bootstrap.Tab) new bootstrap.Tab(document.getElementById('productos-tab-admin')).show(); } catch {}
            document.getElementById('producto-nombre').value = prod.nombre;
            document.getElementById('producto-codigo').value = prod.codigo;
            document.getElementById('producto-precio').value = prod.precio;
            document.getElementById('producto-descripcion').value = prod.descripcion || '';
            document.getElementById('producto-estado').value = prod.estado || 'activo';
            document.getElementById('btn-save-producto').textContent = 'Actualizar Producto';
        }

        function deleteProducto(id) {
            if (!confirm('¿Eliminar este producto? Esta acción no se puede deshacer.')) return;
            productos = productos.filter(p => p.id !== id);
            localStorage.setItem('productos', JSON.stringify(productos));
            loadProductosTable();
        }

        function onProductoEstadoChange(id, nuevo, el) {
            const idx = productos.findIndex(p => p.id === id);
            if (idx === -1) return;
            const estadoFinal = (nuevo === 'inactivo') ? 'inactivo' : 'activo';
            productos[idx].estado = estadoFinal;
            localStorage.setItem('productos', JSON.stringify(productos));
            // Actualizar estilos sin recargar toda la tabla si tenemos el elemento select
            if (el) {
                el.classList.remove('estado-activo','estado-inactivo');
                el.classList.add(estadoFinal === 'activo' ? 'estado-activo' : 'estado-inactivo');
            } else {
                loadProductosTable();
            }
        }

        function toggleProductoEstado(id) {
            const idx = productos.findIndex(p => p.id === id);
            if (idx === -1) return;
            productos[idx].estado = productos[idx].estado === 'activo' ? 'inactivo' : 'activo';
            localStorage.setItem('productos', JSON.stringify(productos));
            loadProductosTable();
        }

        function openProductosAdmin() {
            // Asegurar que estamos en la sección Productos
            changeSection('registros-productos');
            try { if (window.bootstrap && bootstrap.Tab) new bootstrap.Tab(document.getElementById('productos-tab-admin')).show(); } catch {}
        }

        function goToAddClientesFromObra() {
            // Cerrar modal de obra
            const modalEl = document.getElementById('addObraModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
            // Ir a la sección Administrar (tab Añadir Clientes)
            changeSection('clientes-admin');
            try {
                const tabBtn = document.getElementById('admin-tab-clientes');
                if (tabBtn && window.bootstrap && bootstrap.Tab) new bootstrap.Tab(tabBtn).show();
            } catch {}
            // Preseleccionar la obra si hay nombre cargado en el formulario
            const obraNombre = document.getElementById('obra-nombre').value.trim();
            if (obraNombre) {
                // Si la obra aún no existe en la lista, sugerimos crearla primero
                const obraSelect = document.getElementById('add-clientes-obra');
                if (obraSelect) {
                    // Intentar seleccionar si ya existe
                    const opt = Array.from(obraSelect.options).find(o => o.value === obraNombre);
                    if (opt) obraSelect.value = obraNombre;
                }
            }
        }

        function openAdministrar(which) {
            changeSection('clientes-admin');
            // which: 'cliente' | 'obra'
            const targetId = which === 'obra' ? 'admin-tab-obra' : 'admin-tab-clientes';
            try {
                const tabBtn = document.getElementById(targetId);
                if (tabBtn && window.bootstrap && bootstrap.Tab) new bootstrap.Tab(tabBtn).show();
            } catch {}
        }

        function initAdminForms() {
            // Prellenar fecha hoy en cliente
            const today = new Date().toISOString().split('T')[0];
            const clienteFecha = document.getElementById('admin-cliente-fecha');
            if (clienteFecha && !clienteFecha.value) clienteFecha.value = today;
        }

        function showAdminAlert(id, msg, type='info') {
            const box = document.getElementById(id);
            if (!box) return;
            box.textContent = msg;
            box.className = `alert alert-${type}`;
            box.classList.remove('d-none');
        }

        function saveObraFromAdmin() {
            const nombre = document.getElementById('admin-obra-nombre').value.trim();
            const ubicacion = document.getElementById('admin-obra-ubicacion').value.trim();
            const descripcion = document.getElementById('admin-obra-descripcion').value.trim();
            const fechaInicio = document.getElementById('admin-obra-fecha-inicio').value;
            const fechaFin = document.getElementById('admin-obra-fecha-fin').value;
            if (!nombre) {
                showAdminAlert('admin-obra-alert','El nombre de la obra es obligatorio.','warning');
                return;
            }
            const obra = { id: Date.now(), nombre, ubicacion, descripcion, fechaInicio, fechaFin };
            obras.push(obra);
            localStorage.setItem('obras', JSON.stringify(obras));
            loadObrasSelect();
            renderObraSummaryCards();
            // Vista 'Clientes por Obra' eliminada
            (document.getElementById('form-admin-obra')||{}).reset?.();
            showAdminAlert('admin-obra-alert','Obra añadida exitosamente.','success');
        }

                // Abrir modal edición de obra
                function openEditObraModal(nombreObra) {
                        const obra = obras.find(o => o.nombre === nombreObra);
                        if (!obra) { alert('Obra no encontrada'); return; }
                        // Crear modal si no existe
                        let modalEl = document.getElementById('editObraModal');
                        if (!modalEl) {
                                modalEl = document.createElement('div');
                                modalEl.className = 'modal fade';
                                modalEl.id = 'editObraModal';
                                modalEl.tabIndex = -1;
                                modalEl.innerHTML = `
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Editar Obra</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div id="edit-obra-alert" class="alert d-none" role="alert"></div>
                                            <form id="form-edit-obra" class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Nombre <span class="text-danger">*</span></label>
                                                    <input type="text" id="edit-obra-nombre" class="form-control" required />
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Ubicación</label>
                                                    <input type="text" id="edit-obra-ubicacion" class="form-control" />
                                                </div>
                                                <div class="col-12">
                                                    <label class="form-label">Descripción</label>
                                                    <textarea id="edit-obra-descripcion" class="form-control" rows="3"></textarea>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Fecha inicio</label>
                                                    <input type="date" id="edit-obra-fecha-inicio" class="form-control" />
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Fecha fin</label>
                                                    <input type="date" id="edit-obra-fecha-fin" class="form-control" />
                                                </div>
                                            </form>
                                        </div>
                                        <div class="modal-footer d-flex justify-content-between">
                                            <div>
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteObra('${nombreObra}')">Eliminar Obra</button>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                                                <button type="button" class="btn btn-primary btn-sm" onclick="updateObra('${nombreObra}')">Guardar Cambios</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                                document.body.appendChild(modalEl);
                        }
                        // Prellenar
                        document.getElementById('edit-obra-nombre').value = obra.nombre;
                        document.getElementById('edit-obra-ubicacion').value = obra.ubicacion || '';
                        document.getElementById('edit-obra-descripcion').value = obra.descripcion || '';
                        document.getElementById('edit-obra-fecha-inicio').value = obra.fechaInicio || '';
                        document.getElementById('edit-obra-fecha-fin').value = obra.fechaFin || '';
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                }

                function updateObra(originalNombre) {
                        const idx = obras.findIndex(o => o.nombre === originalNombre);
                        if (idx === -1) { alert('Obra no encontrada'); return; }
                        const nuevoNombre = document.getElementById('edit-obra-nombre').value.trim();
                        if (!nuevoNombre) { showEditObraAlert('El nombre es obligatorio','warning'); return; }
                        obras[idx] = {
                                ...obras[idx],
                                nombre: nuevoNombre,
                                ubicacion: document.getElementById('edit-obra-ubicacion').value.trim(),
                                descripcion: document.getElementById('edit-obra-descripcion').value.trim(),
                                fechaInicio: document.getElementById('edit-obra-fecha-inicio').value,
                                fechaFin: document.getElementById('edit-obra-fecha-fin').value
                        };
                        // Actualizar clientes que apuntaban al nombre anterior
                        if (originalNombre !== nuevoNombre) {
                                clientes.forEach(c => { if (c.obra === originalNombre) c.obra = nuevoNombre; });
                                // Registros con tipo 'obra'
                                registros.forEach(r => { if (r.tipo === 'obra' && r.obra === originalNombre) r.obra = nuevoNombre; });
                        }
                        localStorage.setItem('obras', JSON.stringify(obras));
                        localStorage.setItem('clientes', JSON.stringify(clientes));
                        localStorage.setItem('registros', JSON.stringify(registros));
                        loadObrasSelect();
                        renderObraSummaryCards();
                        // Vista 'Clientes por Obra' eliminada
                        loadRegistrosResumen();
                        showEditObraAlert('Obra actualizada correctamente','success');
                        setTimeout(()=>{ try { bootstrap.Modal.getInstance(document.getElementById('editObraModal')).hide(); } catch {} }, 800);
                }

                function showEditObraAlert(msg,type='info') {
                        const box = document.getElementById('edit-obra-alert');
                        if (!box) return;
                        box.textContent = msg;
                        box.className = `alert alert-${type}`;
                        box.classList.remove('d-none');
                }

                function deleteObra(nombreObra) {
                        if (!confirm('¿Eliminar esta obra y todos sus clientes y registros asociados? Esta acción no se puede deshacer.')) return;
                        // Eliminar obra
                        obras = obras.filter(o => o.nombre !== nombreObra);
                        // Eliminar clientes vinculados
                        clientes = clientes.filter(c => c.obra !== nombreObra);
                        // Eliminar registros de esa obra (solo tipo obra)
                        registros = registros.filter(r => !(r.tipo === 'obra' && r.obra === nombreObra));
                        localStorage.setItem('obras', JSON.stringify(obras));
                        localStorage.setItem('clientes', JSON.stringify(clientes));
                        localStorage.setItem('registros', JSON.stringify(registros));
                        loadObrasSelect();
            renderObraSummaryCards();
                        // Vista 'Clientes por Obra' eliminada
                        loadRegistrosResumen();
                        try { const m = bootstrap.Modal.getInstance(document.getElementById('editObraModal')); if (m) m.hide(); } catch {}
                        alert('Obra eliminada correctamente');
                }

        function saveClienteFromAdmin() {
            const nombre = document.getElementById('admin-cliente-nombre').value.trim();
            const cedula = document.getElementById('admin-cliente-cedula').value.trim();
            const obra = document.getElementById('admin-cliente-obra').value;
            const estado = document.getElementById('admin-cliente-estado').value;
            const fecha = document.getElementById('admin-cliente-fecha').value;
            const telefono = document.getElementById('admin-cliente-telefono').value.trim();
            const email = document.getElementById('admin-cliente-email').value.trim();
            const notas = document.getElementById('admin-cliente-notas').value.trim();
            if (!nombre || !cedula || !obra || !estado || !fecha) {
                showAdminAlert('admin-cliente-alert','Por favor completa los campos obligatorios.','warning');
                return;
            }
            const rec = { id: Date.now(), nombre, cedula, obra, estado, fecha, telefono, email, notas };
            clientes.push(rec);
            localStorage.setItem('clientes', JSON.stringify(clientes));
            loadClientesTable();
            renderObraSummaryCards();
            // Vista 'Clientes por Obra' eliminada
            (document.getElementById('form-admin-cliente')||{}).reset?.();
            // Restablecer fecha a hoy
            const today = new Date().toISOString().split('T')[0];
            const clienteFecha = document.getElementById('admin-cliente-fecha');
            if (clienteFecha) clienteFecha.value = today;
            showAdminAlert('admin-cliente-alert','Cliente añadido exitosamente.','success');
        }

        // Mostrar modal añadir cliente
        function showAddClienteModal(event) {
            if (event) event.preventDefault();
            
            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('cliente-fecha').value = today;
            
            // Limpiar formulario
            document.getElementById('form-add-cliente').reset();
            document.getElementById('cliente-fecha').value = today;
            
            loadObrasSelect();
            const modal = new bootstrap.Modal(document.getElementById('addClienteModal'));
            modal.show();
        }

        // Mostrar modal añadir obra
        function showAddObraModal(event) {
            if (event) event.preventDefault();
            document.getElementById('form-add-obra').reset();
            const modal = new bootstrap.Modal(document.getElementById('addObraModal'));
            // Reset lista temporal de clientes
            addObraClients = [];
            renderAddObraClientsTable();
            const today = new Date().toISOString().split('T')[0];
            const fechaInput = document.getElementById('new-obra-cliente-fecha');
            if (fechaInput) fechaInput.value = today;
            modal.show();
        }

        // Guardar cliente
        function saveCliente() {
            const form = document.getElementById('form-add-cliente');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const cliente = {
                id: Date.now(),
                nombre: document.getElementById('cliente-nombre').value,
                cedula: document.getElementById('cliente-cedula').value,
                obra: document.getElementById('cliente-obra').value,
                estado: document.getElementById('cliente-estado').value,
                fecha: document.getElementById('cliente-fecha').value,
                telefono: document.getElementById('cliente-telefono').value,
                email: document.getElementById('cliente-email').value,
                notas: document.getElementById('cliente-notas').value
            };

            clientes.push(cliente);
            localStorage.setItem('clientes', JSON.stringify(clientes));
            
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('addClienteModal')).hide();
            
            // Recargar vistas
            loadClientesTable();
            renderObraSummaryCards();
            // Vista 'Clientes por Obra' eliminada
            
            // Mostrar mensaje de éxito
            alert('Cliente añadido exitosamente');
        }

        // Guardar obra
        function saveObra() {
            const form = document.getElementById('form-add-obra');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const obra = {
                id: Date.now(),
                nombre: document.getElementById('obra-nombre').value,
                ubicacion: document.getElementById('obra-ubicacion').value,
                descripcion: document.getElementById('obra-descripcion').value,
                fechaInicio: document.getElementById('obra-fecha-inicio').value,
                fechaFin: document.getElementById('obra-fecha-fin').value
            };

            obras.push(obra);
            localStorage.setItem('obras', JSON.stringify(obras));
            
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('addObraModal')).hide();
            
            // Si hay clientes temporales, agregarlos vinculados a esta obra
            if (addObraClients.length > 0) {
                const today = new Date().toISOString().split('T')[0];
                addObraClients.forEach((c, i) => {
                    clientes.push({
                        id: Date.now() + i,
                        nombre: c.nombre,
                        cedula: c.cedula,
                        obra: obra.nombre,
                        estado: c.estado || 'activo',
                        fecha: c.fecha || today,
                        telefono: '',
                        email: '',
                        notas: ''
                    });
                });
                localStorage.setItem('clientes', JSON.stringify(clientes));
                addObraClients = [];
            }

            // Recargar selectores y vistas
            loadObrasSelect();
            renderObraSummaryCards();
            // Vista 'Clientes por Obra' eliminada
            
            // Mostrar mensaje de éxito
            alert('Obra añadida exitosamente');
        }

        // Mostrar modal editar cliente
        function showEditClienteModal(id) {
            const cliente = clientes.find(c => c.id === id);
            if (!cliente) return;

            document.getElementById('edit-cliente-id').value = cliente.id;
            document.getElementById('edit-cliente-nombre').value = cliente.nombre;
            document.getElementById('edit-cliente-cedula').value = cliente.cedula;
            document.getElementById('edit-cliente-obra').value = cliente.obra;
            document.getElementById('edit-cliente-estado').value = cliente.estado;
            document.getElementById('edit-cliente-fecha').value = cliente.fecha;
            document.getElementById('edit-cliente-telefono').value = cliente.telefono || '';
            document.getElementById('edit-cliente-email').value = cliente.email || '';
            document.getElementById('edit-cliente-notas').value = cliente.notas || '';

            loadObrasSelect();
            document.getElementById('edit-cliente-obra').value = cliente.obra;
            
            const modal = new bootstrap.Modal(document.getElementById('editClienteModal'));
            modal.show();
        }

        // Actualizar cliente
        function updateCliente() {
            const form = document.getElementById('form-edit-cliente');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const id = parseInt(document.getElementById('edit-cliente-id').value);
            const index = clientes.findIndex(c => c.id === id);
            
            if (index === -1) return;

            clientes[index] = {
                ...clientes[index],
                nombre: document.getElementById('edit-cliente-nombre').value,
                cedula: document.getElementById('edit-cliente-cedula').value,
                obra: document.getElementById('edit-cliente-obra').value,
                estado: document.getElementById('edit-cliente-estado').value,
                fecha: document.getElementById('edit-cliente-fecha').value,
                telefono: document.getElementById('edit-cliente-telefono').value,
                email: document.getElementById('edit-cliente-email').value,
                notas: document.getElementById('edit-cliente-notas').value
            };

            localStorage.setItem('clientes', JSON.stringify(clientes));
            
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('editClienteModal')).hide();
            
            // Recargar vistas
            loadClientesTable();
            renderObraSummaryCards();
            // Vista 'Clientes por Obra' eliminada
            
            alert('Cliente actualizado exitosamente');
        }

        // Eliminar cliente
        function deleteCliente(id) {
            if (!confirm('¿Estás seguro de que deseas eliminar este cliente?')) return;
            
            clientes = clientes.filter(c => c.id !== id);
            localStorage.setItem('clientes', JSON.stringify(clientes));
            
            // Recargar vistas
            loadClientesTable();
            renderObraSummaryCards();
            // Vista 'Clientes por Obra' eliminada
            
            alert('Cliente eliminado exitosamente');
        }

        // Cargar tabla de clientes
        function loadClientesTable() {
            const tbody = document.getElementById('clientes-table-body');
            if (!tbody) return;

            // Obtener filtros
            const filterNombre = document.getElementById('filter-nombre')?.value.toLowerCase() || '';
            const filterObra = document.getElementById('filter-obra')?.value || '';
            const filterEstado = document.getElementById('filter-estado')?.value || '';
            const filterFechaInicio = document.getElementById('filter-fecha-inicio')?.value || '';
            const filterFechaFin = document.getElementById('filter-fecha-fin')?.value || '';

            // Filtrar clientes
            let filteredClientes = clientes.filter(c => {
                const matchNombre = !filterNombre || c.nombre.toLowerCase().includes(filterNombre);
                const matchObra = !filterObra || c.obra === filterObra;
                const matchEstado = !filterEstado || c.estado === filterEstado;
                
                // Filtro por rango de fechas
                let matchFecha = true;
                if (filterFechaInicio && c.fecha < filterFechaInicio) {
                    matchFecha = false;
                }
                if (filterFechaFin && c.fecha > filterFechaFin) {
                    matchFecha = false;
                }
                
                return matchNombre && matchObra && matchEstado && matchFecha;
            });

            // Limpiar tabla
            tbody.innerHTML = '';

            // Si no hay clientes
            if (filteredClientes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-5">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" width="48" height="48" class="mb-2 opacity-50">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                            </svg>
                            <p>${clientes.length === 0 ? 'No hay clientes registrados' : 'No se encontraron clientes con los filtros aplicados'}</p>
                            ${clientes.length === 0 ? '<button class="btn btn-primary btn-sm" onclick="showAddClienteModal(event)">Añadir primer cliente</button>' : ''}
                        </td>
                    </tr>
                `;
                return;
            }

            // Añadir filas
            filteredClientes.forEach(cliente => {
                const estadoBadge = {
                    'activo': 'success',
                    'inactivo': 'secondary',
                    'pendiente': 'warning'
                }[cliente.estado] || 'secondary';

                const fechaFormateada = new Date(cliente.fecha + 'T00:00:00').toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cliente.nombre}</td>
                    <td>${cliente.cedula}</td>
                    <td>${cliente.obra}</td>
                    <td><span class="badge bg-${estadoBadge}">${cliente.estado.charAt(0).toUpperCase() + cliente.estado.slice(1)}</span></td>
                    <td>${fechaFormateada}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="showEditClienteModal(${cliente.id})" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                            </svg>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCliente(${cliente.id})" title="Eliminar">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Renderizar tarjetas resumen por obra
        function renderObraSummaryCards() {
            const container = document.getElementById('obra-summary-cards');
            if (!container) return;
            container.innerHTML = '';
            if (!obras || obras.length === 0) {
                container.innerHTML = '<div class="col-12 text-muted small">No hay obras registradas.</div>';
                return;
            }
            // Tomar filtros actuales (sin aplicar filtro de obra al agrupar, salvo que esté fijado a una obra específica)
            const filterNombre = document.getElementById('filter-nombre')?.value.toLowerCase() || '';
            const filterEstado = document.getElementById('filter-estado')?.value || '';
            const filterFechaInicio = document.getElementById('filter-fecha-inicio')?.value || '';
            const filterFechaFin = document.getElementById('filter-fecha-fin')?.value || '';
            const filterObra = document.getElementById('filter-obra')?.value || '';

            const obrasToRender = filterObra ? obras.filter(o => o.nombre === filterObra) : obras;

            // Centrar si pocas tarjetas
            if (obrasToRender.length < 4) {
                container.classList.add('justify-content-center');
            } else {
                container.classList.remove('justify-content-center');
            }

            // Generar tonos derivados del color primario del tema
            const root = document.documentElement;
            let baseColor = getComputedStyle(root).getPropertyValue('--bs-primary').trim();
            if (!baseColor) { try { baseColor = (getPrefs().primaryColor || '#0d6efd'); } catch { baseColor = '#0d6efd'; } }
            function adjustHsl(hex, sDelta=0, lDelta=0) {
                const hsl = hexToHsl(hex);
                const s = Math.max(0, Math.min(100, hsl.s + sDelta));
                const l = Math.max(0, Math.min(100, hsl.l + lDelta));
                return hslToHex(hsl.h, s, l);
            }
            const lightnessOffsets = [20, 10, 0, -10, -20, 15, -15, 25, -25];

            obrasToRender.forEach((obra, idx) => {
                const tone = adjustHsl(baseColor, -5, lightnessOffsets[idx % lightnessOffsets.length]);
                const clientesCount = (clientes || []).filter(c => {
                    if (c.obra !== obra.nombre) return false;
                    const matchNombre = !filterNombre || c.nombre.toLowerCase().includes(filterNombre);
                    const matchEstado = !filterEstado || c.estado === filterEstado;
                    let matchFecha = true;
                    if (filterFechaInicio && c.fecha < filterFechaInicio) matchFecha = false;
                    if (filterFechaFin && c.fecha > filterFechaFin) matchFecha = false;
                    return matchNombre && matchEstado && matchFecha;
                }).length;
                const col = document.createElement('div');
                col.className = 'col-6 col-sm-4 col-md-3 col-lg-2 d-flex';
                col.innerHTML = `
                    <div class="card h-100 border border-2 shadow-sm obra-summary-card w-100" style="border-color:${tone}; min-height:auto; background-color:#ffffff;">
                        <div class="card-body p-2 d-flex align-items-center justify-content-between" style="min-height:72px; overflow:hidden; flex-wrap:nowrap; gap:0.35rem;">
                            <div class="text-start" style="min-width:0; max-width:calc(100% - 64px); flex:1 1 auto;">
                                <div class="fw-semibold" style="font-size:0.95rem; color:#4b5563; word-break:break-word;">${obra.nombre}</div>
                                <div class="d-flex align-items-baseline gap-2" style="line-height:1.15; flex-wrap:nowrap;">
                                    <span class="fw-bold" style="font-size:1.8rem; color:${tone};">${clientesCount}</span>
                                    <span class="fw-semibold" style="font-size:1rem; color:${tone}; white-space:nowrap;">Clientes</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-1 flex-shrink-0" style="flex:0 0 auto;">
                                <button class="btn btn-sm d-flex align-items-center justify-content-center" style="border:1px solid ${tone}; color:${tone}; background:transparent; padding:0.15rem 0.3rem; width:28px; height:28px;" title="Modificar" onclick="openEditObraModal('${obra.nombre}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                <button class="btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center" style="padding:0.15rem 0.3rem; width:28px; height:28px;" title="Eliminar" onclick="deleteObra('${obra.nombre}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(col);
            });
        }

        // Inicializar filtros de clientes (listado completo)
        function initClientesFilters() {
            const filterNombre = document.getElementById('filter-nombre');
            const filterObra = document.getElementById('filter-obra');
            const filterEstado = document.getElementById('filter-estado');
            const filterFechaInicio = document.getElementById('filter-fecha-inicio');
            const filterFechaFin = document.getElementById('filter-fecha-fin');

            const onChange = () => { loadClientesTable(); renderObraSummaryCards(); };
            if (filterNombre) filterNombre.addEventListener('input', onChange);
            if (filterObra) filterObra.addEventListener('change', onChange);
            if (filterEstado) filterEstado.addEventListener('change', onChange);
            if (filterFechaInicio) filterFechaInicio.addEventListener('change', onChange);
            if (filterFechaFin) filterFechaFin.addEventListener('change', onChange);
        }

        // (Eliminado) Botón de 30 días: ya no se usa, se mantiene solo el rango de fechas manual.

        // Vista 'Clientes por Obra' eliminada: se remueve lógica asociada.

        // Inicializar filtros de resumen de clientes
        function initClientesResumenFilters() {
            const filterObra = document.getElementById('filter-clientes-obra');
            const filterEstado = document.getElementById('filter-clientes-estado');
            const filterFechaInicio = document.getElementById('filter-clientes-fecha-inicio');
            const filterFechaFin = document.getElementById('filter-clientes-fecha-fin');

            if (filterObra) filterObra.addEventListener('change', loadClientesByObra);
            if (filterEstado) filterEstado.addEventListener('change', loadClientesByObra);
            if (filterFechaInicio) filterFechaInicio.addEventListener('change', loadClientesByObra);
            if (filterFechaFin) filterFechaFin.addEventListener('change', loadClientesByObra);
        }

        // (Eliminado) Botón de 30 días en resumen: ya no se usa.

        // Cargar obras en el selector de filtro del resumen
        function loadObrasFilterResumen() {
            const select = document.getElementById('filter-clientes-obra');
            if (!select) return;
            
            const currentValue = select.value;
            
            // Limpiar opciones excepto la primera
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Añadir obras
            obras.forEach(obra => {
                const option = document.createElement('option');
                option.value = obra.nombre;
                option.textContent = obra.nombre;
                select.appendChild(option);
            });
            
            // Restaurar valor si existía
            if (currentValue) select.value = currentValue;
        }

        // ===== Clientes asociados al crear Obra =====
        let addObraClients = [];

        function clearObraClientsTemp() {
            addObraClients = [];
            renderAddObraClientsTable();
            const file = document.getElementById('obra-clientes-file');
            if (file) file.value = '';
            showObraImportAlert('Lista limpiada.', 'info');
        }

        function showObraImportAlert(msg, type='warning') {
            const box = document.getElementById('obra-import-alert');
            if (!box) return;
            box.className = `alert alert-${type} py-2 mb-3`;
            box.textContent = msg;
            box.classList.remove('d-none');
            // auto hide after 4s
            setTimeout(()=>{ box.classList.add('d-none'); }, 4000);
        }

        function renderAddObraClientsTable() {
            const tbody = document.getElementById('obra-clientes-temp-body');
            if (!tbody) return;
            if (addObraClients.length === 0) {
                tbody.innerHTML = '<tr class="text-muted"><td colspan="5" class="text-center py-3">Sin clientes añadidos</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            addObraClients.forEach((c, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${c.nombre || ''}</td>
                    <td>${c.cedula || ''}</td>
                    <td><span class="badge bg-${c.estado==='activo'?'success':(c.estado==='pendiente'?'warning':'secondary')}">${(c.estado||'').charAt(0).toUpperCase()+(c.estado||'').slice(1)}</span></td>
                    <td>${c.fecha || ''}</td>
                    <td class="text-end">
                        <button class="btn btn-light border btn-sm" onclick="removeAddObraClient(${idx})">Quitar</button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        function removeAddObraClient(index) {
            addObraClients.splice(index,1);
            renderAddObraClientsTable();
        }

        function addManualObraClient() {
            const nombre = document.getElementById('new-obra-cliente-nombre').value.trim();
            const cedula = document.getElementById('new-obra-cliente-cedula').value.trim();
            const estado = document.getElementById('new-obra-cliente-estado').value;
            const fecha = document.getElementById('new-obra-cliente-fecha').value;
            if (!nombre || !cedula) {
                showObraImportAlert('Nombre y Cédula son obligatorios para añadir un cliente.', 'warning');
                return;
            }
            const rec = { nombre, cedula, estado: estado || 'activo', fecha: fecha || new Date().toISOString().split('T')[0] };
            addObraClients.push(rec);
            renderAddObraClientsTable();
            // limpiar inputs
            document.getElementById('new-obra-cliente-nombre').value = '';
            document.getElementById('new-obra-cliente-cedula').value = '';
            document.getElementById('new-obra-cliente-estado').value = 'activo';
            document.getElementById('new-obra-cliente-fecha').value = '';
        }

        function handleObraClientsFile() {
            const input = document.getElementById('obra-clientes-file');
            if (!input || !input.files || input.files.length === 0) {
                showObraImportAlert('Selecciona un archivo para importar (.xlsx, .xls, .csv, .pdf).');
                return;
            }
            const file = input.files[0];
            const name = file.name.toLowerCase();
            if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
                importFromExcel(file);
            } else if (name.endsWith('.csv')) {
                importFromCsv(file);
            } else if (name.endsWith('.pdf')) {
                importFromPdf(file);
            } else {
                showObraImportAlert('Formato no soportado. Usa .xlsx, .xls, .csv o .pdf.');
            }
        }

        function importFromExcel(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                    const added = parseTabularRows(rows);
                    if (added > 0) {
                        renderAddObraClientsTable();
                        showObraImportAlert(`Se importaron ${added} clientes desde Excel.`, 'success');
                    } else {
                        showObraImportAlert('No se encontraron filas válidas en el archivo.');
                    }
                } catch (err) {
                    showObraImportAlert('Error al leer el Excel: ' + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function importFromCsv(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const rows = csvToRows(text);
                    const added = parseTabularRows(rows);
                    if (added > 0) {
                        renderAddObraClientsTable();
                        showObraImportAlert(`Se importaron ${added} clientes desde CSV.`, 'success');
                    } else {
                        showObraImportAlert('No se encontraron filas válidas en el archivo CSV.');
                    }
                } catch (err) {
                    showObraImportAlert('Error al leer el CSV: ' + err.message);
                }
            };
            reader.readAsText(file, 'utf-8');
        }

        function importFromPdf(file) {
            if (!window['pdfjsLib']) {
                showObraImportAlert('pdf.js no está disponible. Intenta con Excel o CSV.');
                return;
            }
            const url = URL.createObjectURL(file);
            pdfjsLib.getDocument(url).promise.then(async (pdf) => {
                let lines = [];
                for (let p = 1; p <= pdf.numPages; p++) {
                    const page = await pdf.getPage(p);
                    const content = await page.getTextContent();
                    // Agrupar por líneas aproximando por coordenada Y
                    let currentY = null;
                    let buffer = '';
                    content.items.forEach(item => {
                        const y = Math.round(item.transform[5]);
                        if (currentY === null) currentY = y;
                        if (Math.abs(y - currentY) > 2) {
                            lines.push(buffer.trim());
                            buffer = '';
                            currentY = y;
                        }
                        buffer += (item.str || '') + ' ';
                    });
                    if (buffer.trim()) lines.push(buffer.trim());
                }
                const rows = lines
                    .map(line => line.split(/[,;\t]|\s{2,}/g).filter(Boolean))
                    .filter(arr => arr.length >= 2);
                const added = parseTabularRows(rows);
                URL.revokeObjectURL(url);
                if (added > 0) {
                    renderAddObraClientsTable();
                    showObraImportAlert(`Se importaron ${added} clientes desde PDF (experimental).`, 'success');
                } else {
                    showObraImportAlert('No se pudieron detectar filas válidas en el PDF. Intenta con CSV/Excel.');
                }
            }).catch(err => {
                showObraImportAlert('Error al leer el PDF: ' + err.message);
            });
        }

        function csvToRows(text) {
            // Detectar delimitador (coma o punto y coma)
            const firstLine = text.split(/\r?\n/)[0];
            const delimiter = (firstLine.match(/;/g) || []).length > (firstLine.match(/,/g) || []).length ? ';' : ',';
            const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
            return lines.map(line => line.split(delimiter).map(s => s.replace(/^\s*"|"\s*$/g,'').trim()));
        }

        function normalize(str) {
            try {
                return (str || '').toString().toLowerCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .trim();
            } catch {
                return (str || '').toString().toLowerCase().trim();
            }
        }

        function parseTabularRows(rows) {
            if (!rows || rows.length === 0) return 0;
            // Determinar si hay encabezados
            let startIdx = 0;
            let map = { nombre: 0, cedula: 1, estado: 2, fecha: 3 };
            const header = rows[0].map(h => normalize(h));
            const hasHeader = header.some(h => ['nombre','cedula','cedula','estado','fecha'].includes(h));
            if (hasHeader) {
                startIdx = 1;
                map = {};
                header.forEach((h,i)=>{
                    if (h.includes('nombre')) map.nombre = i;
                    if (h.includes('cedul') || h.includes('document')) map.cedula = i;
                    if (h.includes('estado')) map.estado = i;
                    if (h.includes('fecha')) map.fecha = i;
                });
            }
            let added = 0;
            for (let i = startIdx; i < rows.length; i++) {
                const r = rows[i];
                const nombre = r[map.nombre] || '';
                const cedula = r[map.cedula] || '';
                if (!nombre || !cedula) continue;
                const estado = (r[map.estado] || 'activo').toString().toLowerCase();
                let fecha = r[map.fecha] || '';
                // Normalizar fecha si viene como dd/mm/yyyy
                if (fecha && fecha.includes('/')) {
                    const [d,m,y] = fecha.split('/');
                    if (d && m && y) {
                        fecha = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    }
                }
                if (!fecha || isNaN(Date.parse(fecha))) {
                    fecha = new Date().toISOString().split('T')[0];
                }
                addObraClients.push({ nombre: String(nombre).trim(), cedula: String(cedula).trim(), estado: ['activo','inactivo','pendiente'].includes(estado)?estado:'activo', fecha });
                added++;
            }
            return added;
        }

        // ===== Añadir Clientes (sección dedicada) =====
        function showAddClientesAlert(message, type='info') {
            const box = document.getElementById('add-clientes-alert');
            if (!box) return;
            box.textContent = message;
            box.className = `alert alert-${type}`;
            box.classList.remove('d-none');
        }

        function parseRowsToClientRecords(rows) {
            // Igual que parseTabularRows pero sin efectos secundarios; devuelve registros y conteo omitidos
            const result = { records: [], skipped: 0 };
            if (!rows || rows.length === 0) return result;
            let startIdx = 0;
            let map = { nombre: 0, cedula: 1, estado: 2, fecha: 3 };
            const header = rows[0].map(h => normalize(h));
            const hasHeader = header.some(h => ['nombre','cedula','cedula','estado','fecha'].includes(h));
            if (hasHeader) {
                startIdx = 1;
                map = {};
                header.forEach((h,i)=>{
                    if (h.includes('nombre')) map.nombre = i;
                    if (h.includes('cedul') || h.includes('document')) map.cedula = i;
                    if (h.includes('estado')) map.estado = i;
                    if (h.includes('fecha')) map.fecha = i;
                });
            }
            for (let i = startIdx; i < rows.length; i++) {
                const r = rows[i] || [];
                const nombre = r[map.nombre] || '';
                const cedula = r[map.cedula] || '';
                if (!nombre || !cedula) { result.skipped++; continue; }
                const estadoRaw = (r[map.estado] || 'activo').toString().toLowerCase();
                const estado = ['activo','inactivo','pendiente'].includes(estadoRaw) ? estadoRaw : 'activo';
                let fecha = r[map.fecha] || '';
                if (fecha && typeof fecha === 'string' && fecha.includes('/')) {
                    const [d,m,y] = fecha.split('/');
                    if (d && m && y) {
                        fecha = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    }
                }
                if (!fecha || isNaN(Date.parse(fecha))) {
                    fecha = new Date().toISOString().split('T')[0];
                }
                result.records.push({
                    nombre: String(nombre).trim(),
                    cedula: String(cedula).trim(),
                    estado,
                    fecha
                });
            }
            return result;
        }

        async function handleAddClientesImport() {
            const obraSelect = document.getElementById('add-clientes-obra');
            const fileInput = document.getElementById('add-clientes-file');
            if (!obraSelect || !obraSelect.value) {
                showAddClientesAlert('Selecciona una obra antes de importar.', 'warning');
                return;
            }
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                showAddClientesAlert('Selecciona un archivo para importar (.xlsx, .xls, .csv, .pdf).', 'warning');
                return;
            }

            const file = fileInput.files[0];
            const name = (file.name || '').toLowerCase();
            const processingModalEl = document.getElementById('processingModal');
            const processingModal = new bootstrap.Modal(processingModalEl);
            try {
                processingModal.show();
                let rows = [];

                if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
                    rows = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const wb = XLSX.read(data, { type: 'array' });
                                const ws = wb.Sheets[wb.SheetNames[0]];
                                const out = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                                resolve(out);
                            } catch (err) { reject(err); }
                        };
                        reader.onerror = reject;
                        reader.readAsArrayBuffer(file);
                    });
                } else if (name.endsWith('.csv')) {
                    rows = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try { resolve(csvToRows(e.target.result)); } catch (err) { reject(err); }
                        };
                        reader.onerror = reject;
                        reader.readAsText(file, 'utf-8');
                    });
                } else if (name.endsWith('.pdf')) {
                    if (!window['pdfjsLib']) throw new Error('pdf.js no está disponible. Intenta con Excel o CSV.');
                    rows = await (async () => {
                        const url = URL.createObjectURL(file);
                        try {
                            const pdf = await pdfjsLib.getDocument(url).promise;
                            let lines = [];
                            for (let p = 1; p <= pdf.numPages; p++) {
                                const page = await pdf.getPage(p);
                                const content = await page.getTextContent();
                                let currentY = null; let buffer = '';
                                content.items.forEach(item => {
                                    const y = Math.round(item.transform[5]);
                                    if (currentY === null) currentY = y;
                                    if (Math.abs(y - currentY) > 2) { lines.push(buffer.trim()); buffer=''; currentY = y; }
                                    buffer += (item.str || '') + ' ';
                                });
                                if (buffer.trim()) lines.push(buffer.trim());
                            }
                            return lines
                                .map(line => line.split(/[,;\t]|\s{2,}/g).filter(Boolean))
                                .filter(arr => arr.length >= 2);
                        } finally {
                            URL.revokeObjectURL(url);
                        }
                    })();
                } else {
                    throw new Error('Formato no soportado. Usa .xlsx, .xls, .csv o .pdf.');
                }

                const { records, skipped } = parseRowsToClientRecords(rows);
                if (records.length === 0) {
                    showAddClientesAlert('No se encontraron filas válidas en el archivo.', 'warning');
                    return;
                }

                const obraNombre = obraSelect.value;
                const today = new Date().toISOString().split('T')[0];
                const toAdd = records.map((r, i) => ({
                    id: Date.now() + i,
                    nombre: r.nombre,
                    cedula: r.cedula,
                    obra: obraNombre,
                    estado: r.estado || 'activo',
                    fecha: r.fecha || today,
                    telefono: '',
                    email: '',
                    notas: ''
                }));
                clientes.push(...toAdd);
                localStorage.setItem('clientes', JSON.stringify(clientes));

                // Refrescar vistas
                loadClientesTable();
                loadClientesByObra();

                const msg = `Finalizado: ${toAdd.length} cliente(s) añadidos${skipped ? `, ${skipped} fila(s) no procesadas` : ''}.`;
                showAddClientesAlert(msg, 'success');
                // Limpiar input file
                fileInput.value = '';
            } catch (err) {
                showAddClientesAlert('Error al importar: ' + (err?.message || err), 'danger');
            } finally {
                try { processingModal.hide(); } catch {}
            }
        }

        // Inicio
        window.addEventListener('DOMContentLoaded', () => {
            // Asegurar que todos los inputs de fecha estén en ISO antes de usar filtros
            normalizeDateInputs();
            setInitialDateRanges();
            applyPrefs(getPrefs());
            let username = sessionStorage.getItem('username');
            const demoMode = (localStorage.getItem('demo_mode') === '1');
            // Si no hay sesión, permitir continuar en modo demo (útil durante desarrollo)
            if (!username) {
                if (demoMode) {
                    username = 'demo';
                    try { sessionStorage.setItem('username', 'demo'); } catch {}
                } else {
                    // No bloquear la vista para depurar: mostrar aviso y continuar sin perfil
                    console.warn('No hay sesión activa. Continúas sin perfil. Ve a index.html para iniciar sesión.');
                }
            }
            if (username) {
                const el = document.getElementById('username-display');
                if (el) el.textContent = username;
            }
            // Mostrar aviso si está en modo demo (opcional minimalista: console log)
            try {
                if (localStorage.getItem('demo_mode') === '1') {
                    console.info('Modo demo activo: operando sin backend.');
                }
            } catch {}
            initPreferences();
            // Menú usuario
            const profileItem = document.getElementById('menu-profile');
            const logoutItem = document.getElementById('menu-logout');
            if (profileItem) profileItem.addEventListener('click', (e) => { e.preventDefault(); goToProfile(); });
            if (logoutItem) logoutItem.addEventListener('click', (e) => { e.preventDefault(); logout(); });
            
            // Inicializar módulo de clientes
            initClientesFilters();
            renderObraSummaryCards();
            // initClientesResumenFilters(); // Eliminado: vista 'Clientes por Obra' removida
            loadObrasSelect();
            // Cargar resumen de inicio inmediatamente (evita esperar primer cambioSection)
            try { loadInicioResumen(); } catch (e) { console.warn('Fallo al cargar resumen inicio inicial:', e); }
            // Asegurar título dinámico si existe el contenedor (opcional)
            if (!document.getElementById('page-title')) {
                const h = document.createElement('h1');
                h.id = 'page-title';
                h.className = 'visually-hidden';
                h.textContent = 'Inicio';
                document.querySelector('.main-content')?.insertBefore(h, document.getElementById('content-area'));
            }
            // Inicializar resumen general de inicio en primer carga
            initResumenGeneral();
        });
    </script>

    <!-- Modal Añadir Cliente -->
    <div class="modal fade" id="addClienteModal" tabindex="-1" aria-labelledby="addClienteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addClienteModalLabel">Añadir Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-add-cliente">
                        <div class="mb-3">
                            <label for="cliente-nombre" class="form-label">Nombre completo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cliente-nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="cliente-cedula" class="form-label">Cédula <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cliente-cedula" required>
                        </div>
                        <div class="mb-3">
                            <label for="cliente-obra" class="form-label">Obra <span class="text-danger">*</span></label>
                            <select class="form-select" id="cliente-obra" required>
                                <option value="">Seleccione una obra...</option>
                                <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="cliente-estado" class="form-label">Estado <span class="text-danger">*</span></label>
                            <select class="form-select" id="cliente-estado" required>
                                <option value="activo">Activo</option>
                                <option value="inactivo">Inactivo</option>
                                <option value="pendiente">Pendiente</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="cliente-fecha" class="form-label">Fecha de registro <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cliente-fecha" data-datepicker="modern" required>
                        </div>
                        <div class="mb-3">
                            <label for="cliente-telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="cliente-telefono">
                        </div>
                        <div class="mb-3">
                            <label for="cliente-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="cliente-email">
                        </div>
                        <div class="mb-3">
                            <label for="cliente-notas" class="form-label">Notas</label>
                            <textarea class="form-control" id="cliente-notas" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light border btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="saveCliente()">Guardar Cliente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Añadir Obra -->
    <div class="modal fade" id="addObraModal" tabindex="-1" aria-labelledby="addObraModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addObraModalLabel">Añadir Obra</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-add-obra">
                        <div class="mb-3">
                            <label for="obra-nombre" class="form-label">Nombre de la obra <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="obra-nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="obra-ubicacion" class="form-label">Ubicación</label>
                            <input type="text" class="form-control" id="obra-ubicacion" placeholder="Ciudad, dirección...">
                        </div>
                        <div class="mb-3">
                            <label for="obra-descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="obra-descripcion" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="obra-fecha-inicio" class="form-label">Fecha de inicio</label>
                                <input type="date" class="form-control" id="obra-fecha-inicio">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="obra-fecha-fin" class="form-label">Fecha estimada de fin</label>
                                <input type="date" class="form-control" id="obra-fecha-fin">
                            </div>
                        </div>
                    </form>

                    <hr class="my-3">
                    <div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Clientes asociados a esta obra (opcional)</h6>
                            <small class="text-muted">Puedes cargarlos desde archivo o añadirlos manualmente</small>
                        </div>

                        <div id="obra-import-alert" class="alert alert-warning d-none py-2 mb-3"></div>

                        <div class="row g-2 align-items-end mb-3">
                            <div class="col-md-6">
                                <label class="form-label small text-muted">Importar clientes (.xlsx, .xls, .csv, .pdf)</label>
                                <input type="file" class="form-control form-control-sm" id="obra-clientes-file" accept=".xlsx,.xls,.csv,.pdf">
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-light border btn-sm w-100" onclick="handleObraClientsFile()">Importar</button>
                            </div>
                            <div class="col-md-4 text-end">
                                <button type="button" class="btn btn-light border btn-sm" onclick="clearObraClientsTemp()">Limpiar lista</button>
                            </div>
                        </div>

                        <div class="row g-2 align-items-end mb-3">
                            <div class="col-md-4">
                                <label class="form-label small text-muted" for="new-obra-cliente-nombre">Nombre</label>
                                <input type="text" id="new-obra-cliente-nombre" class="form-control form-control-sm" placeholder="Nombre del cliente">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small text-muted" for="new-obra-cliente-cedula">Cédula</label>
                                <input type="text" id="new-obra-cliente-cedula" class="form-control form-control-sm" placeholder="Cédula">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-muted" for="new-obra-cliente-estado">Estado</label>
                                <select id="new-obra-cliente-estado" class="form-select form-select-sm">
                                    <option value="activo">Activo</option>
                                    <option value="inactivo">Inactivo</option>
                                    <option value="pendiente">Pendiente</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-muted" for="new-obra-cliente-fecha">Fecha</label>
                                <input type="text" id="new-obra-cliente-fecha" class="form-control form-control-sm" data-datepicker="modern">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-primary btn-sm w-100" onclick="addManualObraClient()">Añadir</button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Cédula</th>
                                        <th>Estado</th>
                                        <th>Fecha</th>
                                        <th class="text-end" style="width: 90px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="obra-clientes-temp-body">
                                    <tr class="text-muted">
                                        <td colspan="5" class="text-center py-3">Sin clientes añadidos</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light border btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="saveObra()">Guardar Obra</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Cliente -->
    <div class="modal fade" id="editClienteModal" tabindex="-1" aria-labelledby="editClienteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editClienteModalLabel">Editar Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-edit-cliente">
                        <input type="hidden" id="edit-cliente-id">
                        <div class="mb-3">
                            <label for="edit-cliente-nombre" class="form-label">Nombre completo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit-cliente-nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-cliente-cedula" class="form-label">Cédula <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit-cliente-cedula" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-cliente-obra" class="form-label">Obra <span class="text-danger">*</span></label>
                            <select class="form-select" id="edit-cliente-obra" required>
                                <option value="">Seleccione una obra...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-cliente-estado" class="form-label">Estado <span class="text-danger">*</span></label>
                            <select class="form-select" id="edit-cliente-estado" required>
                                <option value="activo">Activo</option>
                                <option value="inactivo">Inactivo</option>
                                <option value="pendiente">Pendiente</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-cliente-fecha" class="form-label">Fecha de registro <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit-cliente-fecha" data-datepicker="modern" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-cliente-telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="edit-cliente-telefono">
                        </div>
                        <div class="mb-3">
                            <label for="edit-cliente-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit-cliente-email">
                        </div>
                        <div class="mb-3">
                            <label for="edit-cliente-notas" class="form-label">Notas</label>
                            <textarea class="form-control" id="edit-cliente-notas" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light border btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="updateCliente()">Actualizar Cliente</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de procesamiento genérico -->
    <div class="modal fade" id="processingModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body d-flex align-items-center gap-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Procesando...</span>
                    </div>
                    <div>
                        <div class="fw-semibold">Procesando archivo...</div>
                        <div class="small text-muted">Esto puede tardar unos segundos</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SheetJS (Excel/CSV) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-Vp9N9aeQZWURlZcZy6Gm4HfG1Y7Xg+YH3eXzDmxCjE2pV1u3dB5uTz6z0VYV5d5q7zC1qNRH2Yrv2C1xD0I91w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        if (window['pdfjsLib']) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <!-- Modern Datepicker (inline) -->
    <script>
    (function(){
      function pad(n){return n<10?"0"+n:""+n}
      function build(container,input){
        container.classList.add("mdp-container");
        const panel = document.createElement('div');
        panel.className = 'mdp-panel';
        const yearRow = document.createElement('div');
        yearRow.className = 'mdp-year-row';
        const prev = document.createElement('button');
        prev.type = 'button'; prev.className = 'mdp-arrow'; prev.textContent = '◀';
        const next = document.createElement('button');
        next.type = 'button'; next.className = 'mdp-arrow'; next.textContent = '▶';
        const yearLabel = document.createElement('span'); yearLabel.className='mdp-year';
        yearRow.appendChild(prev); yearRow.appendChild(yearLabel); yearRow.appendChild(next);
        const monthRow = document.createElement('div');
        monthRow.className = 'mdp-month-row';
        const monthSelect = document.createElement('select');
        monthSelect.className = 'mdp-month';
        const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        months.forEach((m,i)=>{const o=document.createElement('option'); o.value=i+1; o.textContent=m; monthSelect.appendChild(o);});
        monthRow.appendChild(monthSelect);
        const daysGrid = document.createElement('div');
        daysGrid.className='mdp-days';
        panel.appendChild(yearRow);
        panel.appendChild(monthRow);
        panel.appendChild(daysGrid);
        container.appendChild(panel);
        let date = new Date();
        function syncFromInput(){
          const v = input.value;
          if(v){
            const parts = v.split('-');
            let y, m, d;
            if(parts[0].length===4){
              y = parseInt(parts[0]); m = parseInt(parts[1]); d = parts[2]?parseInt(parts[2]):1;
            }else{
              d = parseInt(parts[0]); m = parseInt(parts[1]); y = parts[2]?parseInt(parts[2]):date.getFullYear();
            }
            if(!isNaN(y)&&!isNaN(m)&&!isNaN(d)) date = new Date(y,m-1,d);
          }
        }
        function render(){
          yearLabel.textContent = date.getFullYear();
          monthSelect.value = (date.getMonth()+1);
          daysGrid.innerHTML = '';
          const y = date.getFullYear();
          const m = date.getMonth();
          const first = new Date(y,m,1);
          const last = new Date(y,m+1,0);
          const startWeekday = first.getDay();
          const wl = ['D','L','M','X','J','V','S'];
          wl.forEach(w=>{const el=document.createElement('div'); el.className='mdp-weekday'; el.textContent=w; daysGrid.appendChild(el);});
          for(let d=1; d<= last.getDate(); d++){
            const btn = document.createElement('button'); btn.type='button'; btn.className='mdp-day'; btn.textContent = d;
            if(d===1) btn.style.gridColumnStart = startWeekday+1;
            if(d === date.getDate()) btn.classList.add('active');
            btn.addEventListener('click',()=>{
              date = new Date(y,m,d);
                    input.value = y+'-'+pad(m+1)+'-'+pad(d); // usar ISO (AAAA-MM-DD)
              input.dispatchEvent(new Event('change'));
              hide();
            });
            daysGrid.appendChild(btn);
          }
        }
        function show(){ container.classList.add('open'); }
        function hide(){ container.classList.remove('open'); }
        prev.addEventListener('click',()=>{ date = new Date(date.getFullYear()-1, date.getMonth(), date.getDate()); render(); });
        next.addEventListener('click',()=>{ date = new Date(date.getFullYear()+1, date.getMonth(), date.getDate()); render(); });
        monthSelect.addEventListener('change',()=>{ const m = parseInt(monthSelect.value)-1; date = new Date(date.getFullYear(), m, 1); render(); });
        document.addEventListener('click', (e)=>{ if(!container.contains(e.target) && e.target!==input) hide(); });
        // Don't set readOnly, just prevent keyboard on focus
        input.addEventListener('keydown', (e)=>{ e.preventDefault(); });
        input.addEventListener('mousedown', (e)=>{ e.preventDefault(); syncFromInput(); render(); position(); show(); });
        input.addEventListener('focus', (e)=>{ syncFromInput(); render(); position(); show(); });
        input.addEventListener('click', (e)=>{ e.preventDefault(); syncFromInput(); render(); position(); show(); });
        function position(){
          panel.style.position = 'absolute';
          panel.style.top = (input.offsetTop + input.offsetHeight + 4) + 'px';
          panel.style.left = (input.offsetLeft) + 'px';
          panel.style.minWidth = Math.max(280, input.offsetWidth) + 'px';
        }
      }
            // Convierte dd-mm-aaaa => aaaa-mm-dd si es necesario
            const toIso = (val) => {
                const re = /^(\d{2})-(\d{2})-(\d{4})$/;
                const m = val.match(re);
                if (!m) return val;
                return `${m[3]}-${m[2]}-${m[1]}`;
            };

            function init(){
        const inputs = document.querySelectorAll('input[data-datepicker="modern"]');
        console.log('Modern datepicker init - found', inputs.length, 'inputs');
        inputs.forEach(input=>{
          const wrap = document.createElement('div');
          wrap.className='mdp-wrap';
          input.parentNode.insertBefore(wrap, input);
          wrap.appendChild(input);
          try { input.type = 'text'; } catch {}
          const ico = document.createElement('span');
          ico.setAttribute('aria-hidden','true');
          ico.style.position='absolute';
          ico.style.right='10px';
          ico.style.top='50%';
          ico.style.transform='translateY(-50%)';
          ico.style.color='#6c757d';
          ico.style.pointerEvents='none';
          ico.innerHTML='📅';
          wrap.style.position='relative';
          wrap.appendChild(ico);
          
                    // Normalizar valor actual (si viene dd-mm-aaaa lo pasamos a ISO)
                    if (input.value) {
                        // Usar el helper global para normalizar cualquier formato a ISO
                        input.value = convertDateToISO(input.value.trim());
                    }

                    // Defaults en ISO
                    if(!input.value || input.value.trim() === ''){
                        const today = new Date();
                        const sevenDaysAgo = new Date(today);
                        sevenDaysAgo.setDate(today.getDate() - 7);
                        const todayIso = today.toISOString().split('T')[0];
                        const sevenIso = sevenDaysAgo.toISOString().split('T')[0];
            
                        if(input.id.includes('fecha-inicio') || input.id.includes('fecha-desde')){
                            input.value = sevenIso;
                        } else if(input.id.includes('fecha-fin') || input.id.includes('fecha-hasta')){
                            input.value = todayIso;
                        } else {
                            input.value = todayIso;
                        }
                    }
          
          build(wrap,input);
        });
      }
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
    </script>
    <!-- API Service -->
    <script src="api.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>